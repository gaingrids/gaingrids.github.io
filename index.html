<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GainGrid Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --deep-purple: #5B2E8A;
            --vivid-magenta: #E33D7A;
            --soft-pink: #FF98BD;
            --electric-blue: #4AA3FF;
            --bg-dark: #0F0F14;
            --bg-panel: #0B0B0D;
            --text-secondary: #9AA0A6;
            --gcoin-gold: #FFC857;
            --white: #FFFFFF;
            --spacing-base: 8px;
            --radius-xs: 6px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--white);
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .app-header {
            width: 100%;
            background: var(--bg-panel);
            padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .app-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .balance-chip {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(227, 61, 122, 0.3));
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 200, 87, 0.3);
        }

        .coin-icon {
            width: 20px;
            height: 20px;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .balance-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--gcoin-gold);
        }

        .main-content {
            flex: 1;
            width: 100%;
            padding: calc(var(--spacing-base) * 3) calc(var(--spacing-base) * 2);
            padding-bottom: calc(var(--spacing-base) * 15);
            overflow-y: auto;
            position: relative;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feed-container {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .post-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
            transition: all 0.3s ease;
        }

        .post-card:hover {
            border-color: rgba(91, 46, 138, 0.4);
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1.5);
            margin-bottom: calc(var(--spacing-base) * 2);
            cursor: pointer;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--deep-purple), var(--electric-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-meta {
            flex: 1;
        }

        .poster-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--white);
            margin-bottom: 2px;
        }

        .post-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--white);
            margin-bottom: calc(var(--spacing-base) * 2);
            word-break: break-word;
        }

        .post-media {
            width: 100%;
            border-radius: var(--radius-sm);
            margin-bottom: calc(var(--spacing-base) * 2);
            overflow: hidden;
            max-height: 400px;
        }

        .post-media img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--radius-sm);
        }

        .post-media video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--radius-sm);
        }

        .earnings-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 200, 87, 0.1);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            border-radius: var(--radius-xs);
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .earnings-label {
            font-size: 12px;
            color: var(--gcoin-gold);
            font-weight: 600;
        }

        .post-actions {
            display: flex;
            gap: calc(var(--spacing-base) * 2);
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .action-btn.liked {
            background: rgba(227, 61, 122, 0.2);
            color: var(--vivid-magenta);
        }

        .action-icon {
            width: 16px;
            height: 16px;
        }

        .comments-section {
            margin-top: calc(var(--spacing-base) * 2);
            padding-top: calc(var(--spacing-base) * 2);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: none;
        }

        .comments-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .comments-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: calc(var(--spacing-base) * 1.5);
        }

        .comment-item {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1);
            margin-bottom: calc(var(--spacing-base) * 1);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-sm);
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--deep-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .comment-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-input-container {
            display: flex;
            gap: calc(var(--spacing-base) * 1);
        }

        .comment-input {
            flex: 1;
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }

        .send-comment-btn {
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: var(--electric-blue);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .task-board-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 2);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .task-counter {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            font-size: 14px;
        }

        .counter-label {
            color: var(--text-secondary);
        }

        .counter-value {
            font-weight: 700;
            color: var(--electric-blue);
        }

        .new-task-btn {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .new-task-btn:hover {
            transform: scale(1.05);
        }

        .platform-grid-container {
            position: relative;
            margin-bottom: calc(var(--spacing-base) * 3);
        }

        .platform-grid {
            display: flex;
            gap: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 1);
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .platform-grid::-webkit-scrollbar {
            display: none;
        }

        .platform-card {
            min-width: 100px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .platform-card:hover {
            transform: translateY(-4px);
            border-color: var(--electric-blue);
            box-shadow: 0 8px 32px rgba(74, 163, 255, 0.2);
        }

        .platform-card.active {
            border-color: var(--vivid-magenta);
            background: rgba(227, 61, 122, 0.1);
        }

        .platform-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto calc(var(--spacing-base) * 1);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            padding: calc(var(--spacing-base) * 1);
        }

        .platform-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }

        .platform-card:hover .platform-icon svg {
            transform: scale(1.1) rotate(5deg);
        }

        .platform-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--white);
            margin-bottom: calc(var(--spacing-base) * 0.5);
        }

        .platform-count {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .task-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
            position: relative;
        }

        .task-card.completed {
            opacity: 0.7;
            border-color: rgba(46, 204, 113, 0.3);
        }

        .task-card.completed::before {
            content: 'COMPLETED';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            padding: 4px 8px;
            border-radius: var(--radius-xs);
            font-size: 10px;
            font-weight: 600;
        }

        .task-header {
            display: flex;
            align-items: start;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-base) * 1);
            color: var(--white);
        }

        .task-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: calc(var(--spacing-base) * 1);
        }

        .task-reward {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 200, 87, 0.15);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 700;
            color: var(--gcoin-gold);
        }

        .task-footer {
            display: flex;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .task-btn {
            flex: 1;
            padding: calc(var(--spacing-base) * 1.5);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .task-btn.primary {
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            color: var(--white);
        }

        .task-btn.primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(91, 46, 138, 0.4);
        }

        .task-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--white);
        }

        .task-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .watch-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 2);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .daily-limit {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cleanup-btn {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.75);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(227, 61, 122, 0.15);
            border: 1px solid rgba(227, 61, 122, 0.3);
            border-radius: var(--radius-sm);
            color: var(--vivid-magenta);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .cleanup-btn:hover {
            background: rgba(227, 61, 122, 0.25);
            transform: scale(1.05);
        }

        .watch-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: calc(var(--spacing-base) * 2);
        }

        .video-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .video-card:hover {
            transform: translateY(-4px);
            border-color: rgba(74, 163, 255, 0.4);
        }

        .video-card.watched {
            opacity: 0.6;
            pointer-events: none;
        }

        .video-thumbnail {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(74, 163, 255, 0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .play-icon {
            width: 48px;
            height: 48px;
            opacity: 0.9;
        }

        .video-duration {
            position: absolute;
            bottom: calc(var(--spacing-base) * 1);
            right: calc(var(--spacing-base) * 1);
            background: rgba(0, 0, 0, 0.8);
            padding: calc(var(--spacing-base) * 0.5) calc(var(--spacing-base) * 1);
            border-radius: var(--radius-xs);
            font-size: 12px;
            font-weight: 600;
        }

        .video-info {
            padding: calc(var(--spacing-base) * 2);
        }

        .video-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-base) * 1);
            line-height: 1.3;
        }

        .video-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .video-reward {
            color: var(--gcoin-gold);
            font-weight: 600;
        }

        .collected-badge {
            color: var(--electric-blue);
            font-weight: 600;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 3);
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 3);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            border: 3px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .profile-username {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: calc(var(--spacing-base) * 2);
            width: 100%;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--electric-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
            overflow: hidden;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 2.5);
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: var(--bg-panel);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-around;
            padding: calc(var(--spacing-base) * 1.5) 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
            text-decoration: none;
        }

        .nav-item:hover {
            color: var(--white);
        }

        .nav-item.active {
            color: var(--electric-blue);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.12s ease;
        }

        .fab {
            position: fixed;
            bottom: calc(var(--spacing-base) * 12);
            right: calc(var(--spacing-base) * 2);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--vivid-magenta), var(--soft-pink));
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(227, 61, 122, 0.4);
            transition: all 0.3s ease;
            z-index: 99;
            opacity: 1;
            transform: translateY(0);
        }

        .fab.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(227, 61, 122, 0.6);
        }

        .fab-icon {
            width: 24px;
            height: 24px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(var(--spacing-base) * 2);
        }

        .modal-content {
            width: 100%;
            max-width: 500px;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .close-icon {
            width: 16px;
            height: 16px;
        }

        .composer-form {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 1);
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.12s ease;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--electric-blue);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .media-attach-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 3);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .media-attach-area:hover {
            border-color: var(--electric-blue);
            background: rgba(74, 163, 255, 0.05);
        }

        .media-attach-area.drag-over {
            border-color: var(--vivid-magenta);
            background: rgba(227, 61, 122, 0.05);
        }

        .attach-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto calc(var(--spacing-base) * 2);
            color: var(--text-secondary);
        }

        .media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: calc(var(--spacing-base) * 1);
            margin-top: calc(var(--spacing-base) * 2);
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submit-btn {
            padding: calc(var(--spacing-base) * 2);
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .submit-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(91, 46, 138, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .browser-frame {
            width: 100%;
            height: 80vh;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .browser-header {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .browser-dots {
            display: flex;
            gap: calc(var(--spacing-base) * 0.75);
        }

        .browser-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .browser-url {
            flex: 1;
            padding: calc(var(--spacing-base) * 0.75) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xs);
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .browser-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .browser-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .timer-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11, 11, 13, 0.95);
            padding: calc(var(--spacing-base) * 2);
            z-index: 10;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .timer-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--electric-blue);
            text-align: center;
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .timer-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--deep-purple), var(--vivid-magenta));
            width: 0%;
            transition: width 1s linear;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--electric-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid var(--electric-blue);
        }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .vip-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: var(--radius-xs);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .vip-badge.none {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .vip-badge.basic {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .vip-badge.silver {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .vip-badge.gold {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .vip-badge.premium {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 430px;
                margin: 0 auto;
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.3);
            }

            .watch-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @keyframes scrollPlatforms {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .platform-grid.auto-scroll {
            animation: scrollPlatforms 30s linear infinite;
        }

        .platform-grid-container:hover .platform-grid.auto-scroll {
            animation-play-state: paused;
        }

        .platform-card.youtube { border-color: rgba(255, 0, 0, 0.3); }
        .platform-card.youtube:hover { border-color: #FF0000; }
        
        .platform-card.telegram { border-color: rgba(0, 136, 204, 0.3); }
        .platform-card.telegram:hover { border-color: #0088cc; }
        
        .platform-card.instagram { border-color: rgba(225, 48, 108, 0.3); }
        .platform-card.instagram:hover { border-color: #E1306C; }
        
        .platform-card.twitter { border-color: rgba(29, 161, 242, 0.3); }
        .platform-card.twitter:hover { border-color: #1DA1F2; }
        
        .platform-card.tiktok { border-color: rgba(0, 0, 0, 0.3); }
        .platform-card.tiktok:hover { border-color: #000000; }
        
        .platform-card.whatsapp { border-color: rgba(37, 211, 102, 0.3); }
        .platform-card.whatsapp:hover { border-color: #25D366; }
        
        .platform-card.discord { border-color: rgba(88, 101, 242, 0.3); }
        .platform-card.discord:hover { border-color: #5865F2; }
        
        .platform-card.facebook { border-color: rgba(24, 119, 242, 0.3); }
        .platform-card.facebook:hover { border-color: #1877F2; }
        
        .platform-card.website { border-color: rgba(74, 163, 255, 0.3); }
        .platform-card.website:hover { border-color: #4AA3FF; }
        
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .transaction-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .transaction-icon.earn {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .transaction-icon.spend {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .transaction-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }
        
        .transaction-amount.earn {
            color: #2ecc71;
        }
        
        .transaction-amount.spend {
            color: #e74c3c;
        }
        
        .viewer-count {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .post-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .stat-item-small {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }
    </style>
    
    <!-- Monetag Ad SDK -->
    <script>
        (function(m,o,n,e,t,a,g){
            m['MonetagObject']=t;m[t]=m[t]||function(){
                (m[t].q=m[t].q||[]).push(arguments)
            };
            a=o.createElement(n);g=o.getElementsByTagName(n)[0];
            a.async=1;a.src=e;g.parentNode.insertBefore(a,g)
        })(window,document,'script','https://cdn.monetag.com/tag.min.js','monetag');
        monetag('start');
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading GainGrid...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-section">
                <div class="logo-icon">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="url(#logo-gradient)" />
                        <path d="M10 16L14 20L22 12" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        <defs>
                            <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#5B2E8A" />
                                <stop offset="1" stop-color="#E33D7A" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h1 class="app-title" id="appTitle">GainGrid</h1>
            </div>
            <div class="balance-chip">
                <div class="coin-icon">
                    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="9" fill="#FFC857" stroke="#FFD87A" stroke-width="1" />
                        <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="12" font-weight="700">G</text>
                    </svg>
                </div>
                <span class="balance-text" id="balanceText">0</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- GridHome Screen -->
            <section class="screen active" id="gridhomeScreen">
                <div class="feed-container" id="feedContainer">
                    <!-- Posts loaded dynamically -->
                </div>
            </section>

            <!-- Task Board Screen -->
            <section class="screen" id="tasksScreen">
                <div class="task-board-header">
                    <div class="task-counter">
                        <span class="counter-label">Tasks today:</span>
                        <span class="counter-value" id="taskCounter">0/20</span>
                    </div>
                    <button class="new-task-btn" id="newTaskBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>New Task</span>
                    </button>
                </div>

                <!-- Platform Grid -->
                <div class="platform-grid-container">
                    <div class="platform-grid auto-scroll" id="platformGrid">
                        <!-- Platforms loaded dynamically -->
                    </div>
                </div>

                <!-- Task List -->
                <div class="task-list" id="taskList">
                    <!-- Tasks loaded dynamically -->
                </div>
            </section>

            <!-- Watch & Earn Screen -->
            <section class="screen" id="watchScreen">
                <div class="watch-header">
                    <div class="daily-limit">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" />
                            <path d="M10 5V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>Daily Ads: <strong id="adsCounter">0/20</strong></span>
                    </div>
                    <button class="cleanup-btn" id="cleanupBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 4H14M6 7V11M10 7V11M3 4L4 13C4 13.5 4.5 14 5 14H11C11.5 14 12 13.5 12 13L13 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        </svg>
                        <span>Clean Up</span>
                    </button>
                </div>

                <div class="watch-grid" id="watchGrid">
                    <!-- Ads loaded dynamically -->
                </div>
            </section>

            <!-- Profile Screen -->
            <section class="screen" id="profileScreen">
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            <!-- Avatar loaded dynamically -->
                        </div>
                        <h2 class="profile-name" id="profileName">Loading...</h2>
                        <p class="profile-username" id="profileUsername">@username</p>
                        <div class="vip-badge" id="vipBadge">VIP Level</div>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="statGcoins">0</div>
                            <div class="stat-label">G-Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statReferrals">0</div>
                            <div class="stat-label">Referrals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statTasksDone">0</div>
                            <div class="stat-label">Tasks Done</div>
                        </div>
                    </div>

                    <div class="profile-menu">
                        <button class="menu-item" id="editProfileBtn">
                            <span>Edit Profile</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="transactionHistoryBtn">
                            <span>Transaction History</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="referralsBtn">
                            <span>Referrals</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="settingsBtn">
                            <span>Settings</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="helpSupportBtn">
                            <span>Help & Support</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchScreen('gridhome')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>GridHome</span>
            </button>
            <button class="nav-item" onclick="switchScreen('tasks')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Tasks</span>
            </button>
            <button class="nav-item" onclick="switchScreen('watch')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Watch</span>
            </button>
            <button class="nav-item" onclick="switchScreen('profile')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Profile</span>
            </button>
        </nav>

        <!-- Floating Action Button (Post) -->
        <button class="fab" id="fabPost" onclick="openComposer()">
            <svg class="fab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 20H21" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M16.5 3.49998C16.8978 3.10216 17.4374 2.87866 18 2.87866C18.2786 2.87866 18.5544 2.93353 18.8118 3.04014C19.0692 3.14674 19.303 3.303 19.5 3.49998C19.697 3.69697 19.8532 3.93082 19.9598 4.18819C20.0665 4.44556 20.1213 4.72141 20.1213 4.99998C20.1213 5.27856 20.0665 5.55441 19.9598 5.81178C19.8532 6.06915 19.697 6.303 19.5 6.49998L7 19L3 20L4 16L16.5 3.49998Z" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

        <!-- Modals -->
        <!-- Composer Modal -->
        <div class="modal-overlay" id="composerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Post</h2>
                    <button class="close-btn" onclick="closeComposer()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <form class="composer-form" id="postForm" onsubmit="submitPost(event)">
                    <div class="form-group">
                        <label class="form-label" for="postContent">Post Content</label>
                        <textarea class="form-textarea" id="postContent" placeholder="What do you want to share? Use # for hashtags and @ for mentions" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postLink">Link URL</label>
                        <input type="url" class="form-input" id="postLink" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postLinkType">Link Type</label>
                        <select class="form-input" id="postLinkType" required>
                            <option value="join">Join Group/Channel</option>
                            <option value="visit">Visit Website</option>
                            <option value="watch">Watch Video</option>
                            <option value="install">Install App</option>
                            <option value="signup">Sign Up</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postReward">Reward Amount (G-Coins)</label>
                        <input type="number" class="form-input" id="postReward" placeholder="Enter reward amount" min="10000" max="100000" required>
                        <div class="reward-preview">
                            <div class="preview-label">Minimum: 10,000 G-Coins</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Media (Optional)</label>
                        <div class="media-attach-area" id="mediaDropArea">
                            <svg class="attach-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="2" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.5" />
                                <circle cx="7" cy="7" r="2" stroke="currentColor" stroke-width="1.5" />
                                <path d="M2 14L7 9L12 14M10 12L13 9L18 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                            </svg>
                            <div class="file-drop-text">Drag & drop photos/videos or click to upload</div>
                            <div class="file-drop-hint">Max size: 10MB</div>
                            <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;">
                        </div>
                        <div class="media-preview" id="mediaPreview"></div>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="postSubmitBtn">Publish Post</button>
                </form>
            </div>
        </div>

        <!-- Browser Modal -->
        <div class="modal-overlay" id="browserModal">
            <div class="browser-frame">
                <div class="browser-header">
                    <div class="browser-dots">
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                    </div>
                    <div class="browser-url" id="browserUrl">https://gaingrid.com</div>
                    <button class="close-btn" onclick="closeBrowserModal()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <div class="browser-content">
                    <div id="browserIframeContainer"></div>
                    <div class="timer-overlay" id="timerOverlay">
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        <div class="timer-label" id="timerLabel">Please wait while we verify completion</div>
                        <div class="timer-progress">
                            <div class="timer-progress-bar" id="timerProgressBar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section Modal -->
        <div class="modal-overlay" id="profileSectionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="profileSectionTitle">Profile Section</h2>
                    <button class="close-btn" onclick="closeProfileSection()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="profileSectionContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const appState = {
            user: null,
            balance: 0,
            vipLevel: 'none',
            referrals: 0,
            dailyCounters: {
                tasks: 0,
                ads: 0
            },
            posts: [],
            tasks: [],
            ads: [],
            randomTasks: [],
            platforms: [],
            currentTask: null,
            currentAd: null,
            currentPostId: null,
            timerInterval: null,
            isTelegramWebApp: false,
            WebApp: null,
            lastScrollPosition: 0,
            botCallbackUrl: null,
            sessionId: Date.now().toString(),
            payloadData: null,
            isPersistent: true
        };

        // ==================== SMART LINKS & PLATFORMS ====================
        const SMART_LINKS = [
            'https://otieu.com/4/10176113',
            'https://otieu.com/4/10176184',
            'https://otieu.com/4/10176114',
            'https://otieu.com/4/10176185'
        ];

        const PLATFORMS = [
            { id: 'youtube', name: 'YouTube', color: '#FF0000' },
            { id: 'telegram', name: 'Telegram', color: '#0088CC' },
            { id: 'instagram', name: 'Instagram', color: '#E1306C' },
            { id: 'twitter', name: 'Twitter', color: '#1DA1F2' },
            { id: 'tiktok', name: 'TikTok', color: '#000000' },
            { id: 'facebook', name: 'Facebook', color: '#1877F2' },
            { id: 'whatsapp', name: 'WhatsApp', color: '#25D366' },
            { id: 'discord', name: 'Discord', color: '#5865F2' },
            { id: 'website', name: 'Website', color: '#4AA3FF' }
        ];

        // ==================== PERSISTENT STORAGE ====================
        class PersistentStorage {
            static PREFIX = 'gaingrid_';
            
            static set(key, value) {
                try {
                    localStorage.setItem(this.PREFIX + key, JSON.stringify(value));
                } catch (e) {
                    console.warn('LocalStorage set error:', e);
                }
            }
            
            static get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(this.PREFIX + key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.warn('LocalStorage get error:', e);
                    return defaultValue;
                }
            }
            
            static remove(key) {
                try {
                    localStorage.removeItem(this.PREFIX + key);
                } catch (e) {
                    console.warn('LocalStorage remove error:', e);
                }
            }
            
            // Global posts storage
            static getGlobalPosts() {
                return this.get('global_posts', []);
            }
            
            static setGlobalPosts(posts) {
                this.set('global_posts', posts);
            }
            
            // User-specific data
            static getUserData(userId) {
                return this.get(`user_${userId}`, {
                    likedPosts: [],
                    completedTasks: {},
                    watchedAds: {},
                    dailyCounters: { tasks: 0, ads: 0 }
                });
            }
            
            static setUserData(userId, data) {
                this.set(`user_${userId}`, data);
            }
            
            // Daily reset check
            static shouldResetDaily() {
                const lastReset = this.get('last_daily_reset', 0);
                const today = new Date().toDateString();
                return lastReset !== today;
            }
            
            static resetDailyIfNeeded() {
                if (this.shouldResetDaily()) {
                    const today = new Date().toDateString();
                    this.set('last_daily_reset', today);
                    return true;
                }
                return false;
            }
        }

        // ==================== BASE64 & PAYLOAD HANDLING ====================
        function decodeBase64(str) {
            try {
                // Replace URL-safe characters
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                
                // Add padding if needed
                const pad = str.length % 4;
                if (pad) {
                    if (pad === 1) {
                        throw new Error('Invalid base64 string');
                    }
                    str += new Array(5-pad).join('=');
                }
                
                // Decode
                const decoded = atob(str);
                return decodeURIComponent(decoded.split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) {
                console.warn('Base64 decode error:', e);
                return null;
            }
        }

        function parsePayloadFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const startParam = urlParams.get('start');
                
                if (!startParam) {
                    // Check hash
                    const hash = window.location.hash.substring(1);
                    if (hash.includes('start=')) {
                        const hashParams = new URLSearchParams(hash);
                        const hashStart = hashParams.get('start');
                        if (hashStart) return parseBase64Payload(hashStart);
                    }
                    return null;
                }
                
                return parseBase64Payload(startParam);
            } catch (e) {
                console.error('Payload parsing error:', e);
                return null;
            }
        }

        function parseBase64Payload(encoded) {
            try {
                const decoded = decodeBase64(encoded);
                if (!decoded) return null;
                
                const payload = JSON.parse(decoded);
                
                // Validate payload structure
                if (payload.type === 'gaingrid_dashboard' && payload.user_id && payload.gcoin !== undefined) {
                    return payload;
                }
                
                return null;
            } catch (e) {
                console.error('Payload decode error:', e);
                return null;
            }
        }

        // ==================== BOT COMMUNICATION ====================
        async function sendToBot(action, data) {
            if (!appState.botCallbackUrl) {
                console.warn('No bot callback URL available');
                return { success: false, error: 'No callback URL' };
            }
            
            try {
                const payload = {
                    action: action,
                    user_id: appState.user?.id || appState.payloadData?.user_id,
                    session_id: appState.sessionId,
                    timestamp: new Date().toISOString(),
                    data: data
                };
                
                // Replace placeholder with actual URL
                const callbackUrl = appState.botCallbackUrl.replace('<%paylode.url%>', '')
                                                         .replace('<%options.url%>', '')
                                                         .trim();
                
                if (!callbackUrl) {
                    console.warn('Invalid callback URL');
                    return { success: false, error: 'Invalid URL' };
                }
                
                const response = await fetch(callbackUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return { success: true, data: result };
                } else {
                    return { success: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                console.error('Bot communication error:', error);
                return { success: false, error: error.message };
            }
        }

        // ==================== TELEGRAM INTEGRATION ====================
        function initializeTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    appState.WebApp = window.Telegram.WebApp;
                    appState.isTelegramWebApp = true;
                    
                    // Initialize Telegram Web App
                    appState.WebApp.ready();
                    appState.WebApp.expand();
                    
                    // Get user data
                    const tgUser = appState.WebApp.initDataUnsafe.user;
                    if (tgUser) {
                        appState.user = {
                            id: tgUser.id,
                            firstName: tgUser.first_name,
                            lastName: tgUser.last_name || '',
                            username: tgUser.username || `user_${tgUser.id}`,
                            photoUrl: tgUser.photo_url
                        };
                        
                        console.log('Telegram user loaded:', appState.user);
                        return true;
                    }
                } catch (error) {
                    console.error('Telegram init error:', error);
                }
            }
            return false;
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            try {
                // Hide loading after delay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1500);
                
                // Parse payload from URL
                const payload = parsePayloadFromURL();
                if (payload) {
                    appState.payloadData = payload;
                    appState.botCallbackUrl = payload.callback_url;
                    
                    // Update state from payload
                    appState.balance = Number(payload.gcoin) || 0;
                    appState.vipLevel = parseVipLevel(payload.vip_level);
                    appState.referrals = Number(payload.referrals) || 0;
                    
                    console.log('Payload loaded:', payload);
                }
                
                // Initialize Telegram
                const telegramLoaded = initializeTelegram();
                
                // Load persistent data
                await loadPersistentData();
                
                // Initialize UI
                updateUIFromState();
                loadPlatforms();
                loadDailyTasksAndAds();
                
                // Setup event listeners
                setupEventListeners();
                initPlatformAutoScroll();
                
                // Send initialization event to bot
                if (appState.botCallbackUrl && appState.payloadData?.user_id) {
                    sendToBot('dashboard_loaded', {
                        user_id: appState.payloadData.user_id,
                        balance: appState.balance,
                        vip_level: appState.vipLevel,
                        session_id: appState.sessionId
                    });
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize app', 'error');
                
                // Still hide loading
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);
            }
        }

        function parseVipLevel(vipString) {
            if (!vipString) return 'none';
            
            const vipStr = vipString.toString().toLowerCase();
            if (vipStr.includes('premium')) return 'premium';
            if (vipStr.includes('gold')) return 'gold';
            if (vipStr.includes('silver')) return 'silver';
            if (vipStr.includes('basic')) return 'basic';
            return 'none';
        }

        // ==================== PERSISTENT DATA LOADING ====================
        async function loadPersistentData() {
            // Check for daily reset
            if (PersistentStorage.resetDailyIfNeeded()) {
                // Reset daily counters for all users
                appState.dailyCounters = { tasks: 0, ads: 0 };
            }
            
            // Load global posts
            appState.posts = PersistentStorage.getGlobalPosts();
            
            // If no posts, load demo posts
            if (appState.posts.length === 0) {
                await loadDemoPosts();
            }
            
            // Load user data if available
            if (appState.user?.id) {
                const userData = PersistentStorage.getUserData(appState.user.id);
                appState.dailyCounters = userData.dailyCounters || { tasks: 0, ads: 0 };
            }
        }

        // ==================== DEMO DATA ====================
        async function loadDemoPosts() {
            const demoPosts = [
                {
                    id: 'post_1',
                    userId: 'admin_001',
                    username: 'GainGrid Admin',
                    userAvatar: 'GA',
                    content: ' Welcome to GainGrid! Start earning G-Coins by completing tasks, watching ads, and creating viral posts. Invite friends for bonus rewards! #GainGrid #EarnMoney',
                    media: 'https://images.unsplash.com/photo-1611224923853-80b023f02d71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://t.me/GainGridChannel',
                    linkType: 'join',
                    reward: 5000,
                    likes: 125,
                    comments: [
                        { id: 'c1', userId: 'user1', username: 'Alice', text: 'Great platform!' },
                        { id: 'c2', userId: 'user2', username: 'Bob', text: 'Already earned 10k coins!' },
                        { id: 'c3', userId: 'user3', username: 'Charlie', text: 'How to withdraw?' }
                    ],
                    shares: 45,
                    views: 1289,
                    timestamp: '2 hours ago',
                    createdAt: Date.now() - 7200000
                },
                {
                    id: 'post_2',
                    userId: 'vip_user_002',
                    username: 'CryptoMaster',
                    userAvatar: 'CM',
                    content: ' Just completed 20 tasks and earned 50,000 G-Coins! The VIP bonus really helps. Upgrade your VIP level for better rewards! #Crypto #Earning #VIP',
                    media: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://example.com/crypto-task',
                    linkType: 'visit',
                    reward: 8000,
                    likes: 89,
                    comments: [
                        { id: 'c4', userId: 'user4', username: 'David', text: 'Wow! How long did it take?' },
                        { id: 'c5', userId: 'user5', username: 'Eva', text: 'VIP is worth it!' }
                    ],
                    shares: 23,
                    views: 876,
                    timestamp: '5 hours ago',
                    createdAt: Date.now() - 18000000
                },
                {
                    id: 'post_3',
                    userId: 'content_creator_003',
                    username: 'SocialGuru',
                    userAvatar: 'SG',
                    content: ' Best social media tasks available! Join Telegram channels, follow Instagram accounts, and watch YouTube videos for instant rewards. #SocialMedia #Tasks #Earn',
                    media: null,
                    link: 'https://t.me/JoinThisChannel',
                    linkType: 'join',
                    reward: 3000,
                    likes: 67,
                    comments: [
                        { id: 'c6', userId: 'user6', username: 'Frank', text: 'Easy tasks!' },
                        { id: 'c7', userId: 'user7', username: 'Grace', text: 'More please!' }
                    ],
                    shares: 12,
                    views: 543,
                    timestamp: '1 day ago',
                    createdAt: Date.now() - 86400000
                },
                {
                    id: 'post_4',
                    userId: 'video_expert_004',
                    username: 'VideoPro',
                    userAvatar: 'VP',
                    content: ' Watch these amazing videos and earn G-Coins! Each video gives you 60-120 coins. Perfect way to earn while relaxing. #Videos #WatchAndEarn #Entertainment',
                    media: 'https://images.unsplash.com/photo-1574375927938-d5a98e8ffe85?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://example.com/watch-video',
                    linkType: 'watch',
                    reward: 2000,
                    likes: 45,
                    comments: [
                        { id: 'c8', userId: 'user8', username: 'Henry', text: 'Love watching videos!' }
                    ],
                    shares: 8,
                    views: 432,
                    timestamp: '2 days ago',
                    createdAt: Date.now() - 172800000
                },
                {
                    id: 'post_5',
                    userId: 'app_tester_005',
                    username: 'AppLover',
                    userAvatar: 'AL',
                    content: ' Install these amazing apps and get massive rewards! Some apps give up to 10,000 G-Coins for installation. #Apps #Install #Rewards',
                    media: 'https://images.unsplash.com/photo-1551650975-87deedd944c3?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://example.com/install-app',
                    linkType: 'install',
                    reward: 10000,
                    likes: 112,
                    comments: [
                        { id: 'c9', userId: 'user9', username: 'Ivy', text: 'Which apps are best?' },
                        { id: 'c10', userId: 'user10', username: 'Jack', text: 'Got my reward instantly!' }
                    ],
                    shares: 34,
                    views: 765,
                    timestamp: '3 days ago',
                    createdAt: Date.now() - 259200000
                }
            ];
            
            // Add demo posts to global storage
            appState.posts = demoPosts;
            PersistentStorage.setGlobalPosts(demoPosts);
            
            updateFeed();
        }

        // ==================== DAILY TASKS & ADS ====================
        function loadDailyTasksAndAds() {
            // Generate daily tasks
            appState.tasks = generateDailyTasks();
            
            // Generate daily ads
            appState.ads = generateDailyAds();
            
            // Generate random tasks
            generateRandomTasks();
            
            // Update UI
            updateTasks();
            updateAds();
        }

        function generateDailyTasks() {
            const dateStr = new Date().toDateString();
            const tasks = [
                {
                    id: `task_${dateStr}_1`,
                    platform: 'telegram',
                    title: 'Join Telegram Channel',
                    description: 'Join our official channel and stay for 45 seconds',
                    duration: 45,
                    reward: 3500,
                    link: SMART_LINKS[0],
                    completed: false,
                    date: dateStr
                },
                {
                    id: `task_${dateStr}_2`,
                    platform: 'youtube',
                    title: 'Watch YouTube Video',
                    description: 'Watch full video and like (2 minutes 30 seconds)',
                    duration: 150,
                    reward: 5000,
                    link: SMART_LINKS[1],
                    completed: false,
                    date: dateStr
                },
                {
                    id: `task_${dateStr}_3`,
                    platform: 'instagram',
                    title: 'Follow Instagram',
                    description: 'Follow account and like 3 posts',
                    duration: 120,
                    reward: 4000,
                    link: SMART_LINKS[2],
                    completed: false,
                    date: dateStr
                },
                {
                    id: `task_${dateStr}_4`,
                    platform: 'website',
                    title: 'Visit Website',
                    description: 'Visit website and stay for 1 minute',
                    duration: 60,
                    reward: 2500,
                    link: SMART_LINKS[3],
                    completed: false,
                    date: dateStr
                }
            ];
            
            return tasks;
        }

        function generateDailyAds() {
            const ads = [];
            for (let i = 0; i < 20; i++) {
                ads.push({
                    id: `ad_${new Date().toDateString()}_${i + 1}`,
                    title: getRandomAdTitle(),
                    duration: Math.floor(Math.random() * 30) + 30,
                    reward: Math.floor(Math.random() * 61) + 60,
                    source: getRandomAdSource(),
                    link: SMART_LINKS[i % SMART_LINKS.length],
                    watched: false,
                    date: new Date().toDateString()
                });
            }
            return ads;
        }

        function generateRandomTasks() {
            appState.randomTasks = [];
            for (let i = 0; i < 10; i++) {
                appState.randomTasks.push({
                    id: `random_${Date.now()}_${i}`,
                    platform: 'website',
                    title: getRandomTaskTitle(),
                    description: getRandomTaskDescription(),
                    duration: Math.floor(Math.random() * 120) + 60,
                    reward: Math.floor(Math.random() * 201) + 100,
                    link: SMART_LINKS[i % SMART_LINKS.length],
                    completed: false,
                    isRandom: true
                });
            }
        }

        // ==================== UI UPDATE FUNCTIONS ====================
        function updateUIFromState() {
            // Update balance from payload
            document.getElementById('balanceText').textContent = appState.balance.toLocaleString();
            document.getElementById('statGcoins').textContent = appState.balance.toLocaleString();
            
            // Update VIP badge from payload
            updateVipBadge();
            
            // Update referrals from payload
            document.getElementById('statReferrals').textContent = appState.referrals.toLocaleString();
            document.getElementById('statTasksDone').textContent = appState.dailyCounters.tasks.toString();
            
            // Update profile if user exists
            if (appState.user) {
                updateProfileUI();
            }
            
            // Update counters
            updateCounters();
        }

        function updateProfileUI() {
            const profileName = document.getElementById('profileName');
            const profileUsername = document.getElementById('profileUsername');
            const profileAvatar = document.getElementById('profileAvatar');
            
            if (profileName) {
                const fullName = `${appState.user.firstName || ''} ${appState.user.lastName || ''}`.trim();
                profileName.textContent = fullName || 'Telegram User';
            }
            
            if (profileUsername) {
                const username = appState.user.username || '';
                profileUsername.textContent = username.startsWith('@') ? username : `@${username}`;
            }
            
            if (profileAvatar) {
                if (appState.user.photoUrl) {
                    profileAvatar.innerHTML = `<img src="${appState.user.photoUrl}" alt="Profile" onerror="this.style.display='none'; this.parentElement.textContent='${getInitials(appState.user.firstName, appState.user.lastName)}'">`;
                } else {
                    const initials = getInitials(appState.user.firstName, appState.user.lastName);
                    profileAvatar.textContent = initials;
                }
            }
        }

        function updateVipBadge() {
            const vipBadge = document.getElementById('vipBadge');
            if (!vipBadge) return;
            
            // Clear all classes
            vipBadge.className = 'vip-badge';
            
            // Add current VIP level
            vipBadge.classList.add(appState.vipLevel);
            
            // Set text based on VIP level
            const badgeText = {
                none: 'No VIP',
                basic: 'Basic VIP',
                silver: 'Silver VIP',
                gold: 'Gold VIP',
                premium: 'Premium VIP'
            }[appState.vipLevel] || 'No VIP';
            
            vipBadge.textContent = badgeText;
        }

        function updateFeed() {
            const feedContainer = document.getElementById('feedContainer');
            if (!feedContainer) return;
            
            feedContainer.innerHTML = '';
            
            // Sort posts by creation time (newest first)
            const sortedPosts = [...appState.posts].sort((a, b) => b.createdAt - a.createdAt);
            
            sortedPosts.forEach(post => {
                const postElement = createPostElement(post);
                feedContainer.appendChild(postElement);
            });
            
            if (sortedPosts.length === 0) {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        No posts yet. Be the first to create a viral post!
                    </div>
                `;
            }
        }

        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = 'post-card';
            div.dataset.postId = post.id;
            
            // Check if user liked this post
            const userLiked = appState.user?.id ? 
                PersistentStorage.getUserData(appState.user.id).likedPosts?.includes(post.id) : false;
            
            // Media HTML
            let mediaHtml = '';
            if (post.media) {
                if (post.media.includes('.mp4') || post.media.includes('.webm')) {
                    mediaHtml = `
                        <div class="post-media">
                            <video controls>
                                <source src="${post.media}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                } else {
                    mediaHtml = `
                        <div class="post-media">
                            <img src="${post.media}" alt="Post image" onerror="this.style.display='none'">
                        </div>
                    `;
                }
            }
            
            const actionText = getActionText(post.linkType);
            
            div.innerHTML = `
                <div class="post-header" onclick="viewUserProfile('${post.userId}')">
                    <div class="avatar">
                        ${post.userAvatar}
                    </div>
                    <div class="post-meta">
                        <div class="poster-name">${post.username}</div>
                        <div class="post-time">${post.timestamp}</div>
                    </div>
                </div>
                <div class="post-content">${post.content}</div>
                ${mediaHtml}
                <div class="earnings-bar">
                    <span class="earnings-label">Earn up to ${post.reward.toLocaleString()} G-coins</span>
                </div>
                <div class="post-stats">
                    <div class="viewer-count">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 10.5C8.48528 10.5 10.5 8.48528 10.5 6C10.5 3.51472 8.48528 1.5 6 1.5C3.51472 1.5 1.5 3.51472 1.5 6C1.5 8.48528 3.51472 10.5 6 10.5Z" stroke="currentColor" stroke-width="1"/>
                            <path d="M6 8C7.10457 8 8 7.10457 8 6C8 4.89543 7.10457 4 6 4C4.89543 4 4 4.89543 4 6C4 7.10457 4.89543 8 6 8Z" stroke="currentColor" stroke-width="1"/>
                            <path d="M1.5 6H10.5" stroke="currentColor" stroke-width="1"/>
                        </svg>
                        ${post.views ? post.views.toLocaleString() : '0'} views
                    </div>
                </div>
                <div class="post-actions">
                    <button class="action-btn ${userLiked ? 'liked' : ''}" onclick="handleLike('${post.id}', this)">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 14L2.5 8.5C1.5 7.5 1.5 5.8 2.5 4.8C3.5 3.8 5.2 3.8 6.2 4.8L8 6.6L9.8 4.8C10.8 3.8 12.5 3.8 13.5 4.8C14.5 5.8 14.5 7.5 13.5 8.5L8 14Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                  ${userLiked ? 'fill="currentColor"' : 'fill="none"'}/>
                        </svg>
                        <span>${post.likes}</span>
                    </button>
                    <button class="action-btn" onclick="handleTaskAction('${post.id}', '${post.link}', '${post.linkType}', ${post.reward})">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2L8 8L14 2ZM14 2L9.5 14L8 8L2 6.5L14 2Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>${actionText}</span>
                    </button>
                    <button class="action-btn" onclick="toggleComments('${post.id}')">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 11C14 11.5 13.5 12 13 12H4L2 14V3C2 2.5 2.5 2 3 2H13C13.5 2 14 2.5 14 3V11Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>${post.comments.length}</span>
                    </button>
                </div>
                <div class="comments-section" id="comments-${post.id}">
                    <div class="comments-container" id="comments-container-${post.id}">
                        ${post.comments.map(comment => `
                            <div class="comment-item">
                                <div class="comment-avatar">${comment.username.charAt(0)}</div>
                                <div class="comment-content">
                                    <div class="comment-author">${comment.username}</div>
                                    <div class="comment-text">${comment.text}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
                        <button class="send-comment-btn" onclick="sendComment('${post.id}')">Send</button>
                    </div>
                </div>
            `;
            
            return div;
        }

        function loadPlatforms() {
            const platformGrid = document.getElementById('platformGrid');
            if (!platformGrid) return;
            
            platformGrid.innerHTML = '';
            
            PLATFORMS.forEach(platform => {
                const platformElement = createPlatformElement(platform);
                platformGrid.appendChild(platformElement);
                const platformElement2 = createPlatformElement(platform);
                platformGrid.appendChild(platformElement2);
            });
        }

        function createPlatformElement(platform) {
            const div = document.createElement('div');
            div.className = `platform-card ${platform.id}`;
            div.onclick = () => filterTasksByPlatform(platform.id);
            
            let svgIcon = '';
            
            switch (platform.id) {
                case 'youtube':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47.13-1.33.22-2.65.28-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z"/></svg>';
                    break;
                case 'telegram':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>';
                    break;
                default:
                    svgIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
            }
            
            div.innerHTML = `
                <div class="platform-icon" style="color: ${platform.color}">
                    ${svgIcon}
                </div>
                <div class="platform-name">${platform.name}</div>
                <div class="platform-count">${getRandomCount()} tasks</div>
            `;
            
            return div;
        }

        function updateTasks() {
            const taskList = document.getElementById('taskList');
            if (!taskList) return;
            
            taskList.innerHTML = '';
            
            const allTasks = [...appState.tasks, ...appState.randomTasks];
            
            if (allTasks.length === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        No tasks available. Check back tomorrow!
                    </div>
                `;
                return;
            }
            
            allTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
            
            updateTaskCounter();
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task-card ${task.completed ? 'completed' : ''}`;
            div.dataset.taskId = task.id;
            
            const platform = PLATFORMS.find(p => p.id === task.platform) || PLATFORMS[0];
            
            div.innerHTML = `
                <div class="task-header">
                    <div class="platform-icon ${platform.id}" style="color: ${platform.color}; width: 40px; height: 40px;">
                    </div>
                    <div class="task-info">
                        <h3 class="task-title">${task.title}</h3>
                        <p class="task-description">${task.description}</p>
                    </div>
                    <div class="task-reward">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="9" fill="#FFC857" />
                            <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="10" font-weight="700">G</text>
                        </svg>
                        <span>${task.reward.toLocaleString()}</span>
                    </div>
                </div>
                <div class="task-footer">
                    <button class="task-btn primary" onclick="startTask('${task.id}')" ${task.completed ? 'disabled' : ''}>
                        ${task.completed ? 'Completed' : 'Start Task'}
                    </button>
                    <button class="task-btn secondary" onclick="viewTaskDetails('${task.id}')">
                        Details
                    </button>
                </div>
            `;
            
            return div;
        }

        function updateAds() {
            const watchGrid = document.getElementById('watchGrid');
            if (!watchGrid) return;
            
            watchGrid.innerHTML = '';
            
            if (appState.ads.length === 0) {
                watchGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                        No ads available. Check back tomorrow!
                    </div>
                `;
                return;
            }
            
            appState.ads.forEach(ad => {
                const adElement = createAdElement(ad);
                watchGrid.appendChild(adElement);
            });
            
            updateAdsCounter();
        }

        function createAdElement(ad) {
            const div = document.createElement('div');
            div.className = `video-card ${ad.watched ? 'watched' : ''}`;
            div.dataset.adId = ad.id;
            
            div.innerHTML = `
                <div class="video-thumbnail" onclick="watchAd('${ad.id}')">
                    ${ad.watched ? `
                        <div class="watched-overlay">
                            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="rgba(74, 163, 255, 0.9)" />
                                <path d="M12 20L17 25L28 14" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    ` : `
                        <svg class="play-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="24" cy="24" r="22" fill="rgba(255,255,255,0.9)" />
                            <path d="M19 16L32 24L19 32V16Z" fill="#0B0B0D" />
                        </svg>
                    `}
                    <span class="video-duration">0:${ad.duration.toString().padStart(2, '0')}</span>
                </div>
                <div class="video-info">
                    <div class="video-advertiser">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="14" height="14" rx="3" fill="${getRandomColor()}" />
                        </svg>
                        <span>${ad.source}</span>
                    </div>
                    <h3 class="video-title">${ad.title}</h3>
                    <div class="video-meta">
                        ${ad.watched ? `
                            <span class="collected-badge">Collected</span>
                        ` : `
                            <span>Watch 0:${ad.duration.toString().padStart(2, '0')}  Earn</span>
                        `}
                        <span class="video-reward">+${ad.reward} G-coins</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        function updateCounters() {
            updateTaskCounter();
            updateAdsCounter();
        }

        function updateTaskCounter() {
            const completedTasks = [...appState.tasks, ...appState.randomTasks].filter(t => t.completed).length;
            document.getElementById('taskCounter').textContent = `${completedTasks}/20`;
        }

        function updateAdsCounter() {
            const watchedAds = appState.ads.filter(a => a.watched).length;
            document.getElementById('adsCounter').textContent = `${watchedAds}/20`;
        }

        // ==================== TASK FUNCTIONS ====================
        function filterTasksByPlatform(platformId) {
            const taskList = document.getElementById('taskList');
            if (!taskList) return;
            
            taskList.innerHTML = '';
            
            const filteredTasks = [...appState.tasks, ...appState.randomTasks].filter(task => 
                task.platform === platformId && !task.completed
            );
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        No tasks available for ${PLATFORMS.find(p => p.id === platformId)?.name || 'this platform'}. Check back later!
                    </div>
                `;
                return;
            }
            
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
        }

        async function startTask(taskId) {
            const allTasks = [...appState.tasks, ...appState.randomTasks];
            const task = allTasks.find(t => t.id === taskId);
            
            if (!task || task.completed) return;
            
            if (appState.dailyCounters.tasks >= 20) {
                showToast('Daily task limit reached! Come back tomorrow.', 'warning');
                return;
            }
            
            appState.currentTask = task;
            
            // Send to bot
            if (appState.botCallbackUrl) {
                await sendToBot('task_started', {
                    task_id: task.id,
                    task_title: task.title,
                    platform: task.platform,
                    reward: task.reward
                });
            }
            
            // Handle based on platform and link type
            handleTaskLink(task.link, task.linkType || 'visit', task.duration, {
                id: task.id,
                type: 'task',
                reward: task.reward
            });
        }

        async function completeTask(data) {
            try {
                // Find and mark task as completed
                let task = appState.tasks.find(t => t.id === data.id);
                if (!task) {
                    task = appState.randomTasks.find(t => t.id === data.id);
                }
                
                if (task) {
                    task.completed = true;
                }
                
                // Update daily counter
                appState.dailyCounters.tasks++;
                
                // Save user data
                if (appState.user?.id) {
                    const userData = PersistentStorage.getUserData(appState.user.id);
                    userData.completedTasks = userData.completedTasks || {};
                    userData.completedTasks[data.id] = true;
                    userData.dailyCounters = appState.dailyCounters;
                    PersistentStorage.setUserData(appState.user.id, userData);
                }
                
                // Send completion to bot
                if (appState.botCallbackUrl) {
                    await sendToBot('task_completed', {
                        task_id: data.id,
                        reward: data.reward,
                        daily_count: appState.dailyCounters.tasks
                    });
                }
                
                // Update UI
                updateTasks();
                updateCounters();
                
                showToast(`Task completed! +${data.reward.toLocaleString()} G-Coins`, 'success');
                
            } catch (error) {
                console.error('Task completion error:', error);
                showToast('Failed to complete task', 'error');
            }
        }

        // ==================== AD FUNCTIONS ====================
        async function watchAd(adId) {
            const ad = appState.ads.find(a => a.id === adId);
            if (!ad || ad.watched) return;
            
            if (appState.dailyCounters.ads >= 20) {
                showToast('Daily ad limit reached! Come back tomorrow.', 'warning');
                return;
            }
            
            appState.currentAd = ad;
            
            // Send to bot
            if (appState.botCallbackUrl) {
                await sendToBot('ad_started', {
                    ad_id: ad.id,
                    ad_title: ad.title,
                    duration: ad.duration,
                    reward: ad.reward
                });
            }
            
            // Handle ad viewing
            handleAdViewing(ad.link, ad.duration, {
                id: ad.id,
                type: 'ad',
                reward: ad.reward
            });
        }

        async function handleAdViewing(link, duration, data) {
            // Try Monetag first
            if (typeof show_10274566 === 'function') {
                try {
                    const result = await show_10274566('pop');
                    if (result) {
                        await completeAd(data);
                        return;
                    }
                } catch (error) {
                    console.log('Monetag error, using fallback:', error);
                }
            }
            
            // Fallback to browser modal
            openBrowserModal();
            handleLinkInBrowser(link, duration, data);
        }

        async function completeAd(data) {
            try {
                const ad = appState.ads.find(a => a.id === data.id);
                if (ad) {
                    ad.watched = true;
                }
                
                // Update daily counter
                appState.dailyCounters.ads++;
                
                // Save user data
                if (appState.user?.id) {
                    const userData = PersistentStorage.getUserData(appState.user.id);
                    userData.watchedAds = userData.watchedAds || {};
                    userData.watchedAds[data.id] = true;
                    userData.dailyCounters = appState.dailyCounters;
                    PersistentStorage.setUserData(appState.user.id, userData);
                }
                
                // Send completion to bot
                if (appState.botCallbackUrl) {
                    await sendToBot('ad_completed', {
                        ad_id: data.id,
                        reward: data.reward,
                        daily_count: appState.dailyCounters.ads
                    });
                }
                
                // Update UI
                updateAds();
                updateCounters();
                
                showToast(`Ad watched! +${data.reward} G-Coins`, 'success');
                
            } catch (error) {
                console.error('Ad completion error:', error);
                showToast('Failed to complete ad', 'error');
            }
        }

        function cleanupWatched() {
            appState.ads = appState.ads.filter(ad => !ad.watched);
            appState.tasks = appState.tasks.filter(task => !task.completed);
            appState.randomTasks = appState.randomTasks.filter(task => !task.completed);
            
            updateAds();
            updateTasks();
            showToast('Cleaned up completed items', 'success');
        }

        // ==================== POST FUNCTIONS ====================
        function openComposer() {
            if (!['gold', 'premium', 'silver'].includes(appState.vipLevel)) {
                showToast('Only Silver, Gold, and Premium VIP can create posts', 'error');
                return;
            }
            
            if (appState.balance < 10000) {
                showToast('Minimum 10,000 G-Coins required to create a post', 'error');
                return;
            }
            
            document.getElementById('composerModal').classList.add('active');
        }

        function closeComposer() {
            document.getElementById('composerModal').classList.remove('active');
            document.getElementById('postForm').reset();
            document.getElementById('mediaPreview').innerHTML = '';
        }

        async function submitPost(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('postSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Publishing...';
            submitBtn.disabled = true;
            
            try {
                const content = document.getElementById('postContent').value;
                const link = document.getElementById('postLink').value;
                const linkType = document.getElementById('postLinkType').value;
                const reward = parseInt(document.getElementById('postReward').value);
                
                if (reward < 10000) {
                    throw new Error('Minimum reward is 10,000 G-Coins');
                }
                
                if (reward > appState.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Deduct from balance (bot will verify and update)
                appState.balance -= reward;
                document.getElementById('balanceText').textContent = appState.balance.toLocaleString();
                
                // Get media
                const mediaPreview = document.getElementById('mediaPreview');
                let mediaUrl = null;
                if (mediaPreview.children.length > 0) {
                    const img = mediaPreview.querySelector('img');
                    const video = mediaPreview.querySelector('video');
                    if (img) {
                        mediaUrl = img.src;
                    } else if (video) {
                        mediaUrl = video.src;
                    }
                }
                
                // Create post
                const newPost = {
                    id: `post_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    userId: appState.user?.id || 'anonymous',
                    username: appState.user?.username || 'Anonymous',
                    userAvatar: getInitials(appState.user?.firstName, appState.user?.lastName) || 'A',
                    content: content,
                    media: mediaUrl,
                    link: link,
                    linkType: linkType,
                    reward: reward,
                    likes: 0,
                    comments: [],
                    shares: 0,
                    views: 0,
                    timestamp: 'Just now',
                    createdAt: Date.now()
                };
                
                // Add to global posts
                appState.posts.unshift(newPost);
                PersistentStorage.setGlobalPosts(appState.posts);
                
                // Send to bot
                if (appState.botCallbackUrl) {
                    await sendToBot('post_created', {
                        post_id: newPost.id,
                        content_length: content.length,
                        link_type: linkType,
                        reward: reward
                    });
                }
                
                // Update UI
                updateFeed();
                
                closeComposer();
                showToast('Post created successfully! It\'s now viral!', 'success');
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==================== LINK HANDLING ====================
        function handleTaskAction(postId, link, type, reward) {
            const duration = getDurationForType(type);
            
            // Handle based on link type
            handleTaskLink(link, type, duration, {
                id: postId,
                type: 'post_action',
                reward: reward
            });
        }

        function handleTaskLink(link, type, duration, data) {
            switch (type) {
                case 'join':
                    // Telegram/group links - open directly
                    if (link.includes('t.me') || link.includes('telegram.me')) {
                        if (appState.WebApp) {
                            appState.WebApp.openTelegramLink(link);
                        } else {
                            window.open(link, '_blank');
                        }
                        startTimerDirect(duration, data);
                    } else {
                        // Other join links in browser
                        openBrowserModal();
                        handleLinkInBrowser(link, duration, data);
                    }
                    break;
                    
                case 'install':
                    // App install links - open directly
                    window.open(link, '_blank');
                    startTimerDirect(duration, data);
                    break;
                    
                default:
                    // Visit, watch, signup in browser
                    openBrowserModal();
                    handleLinkInBrowser(link, duration, data);
                    break;
            }
        }

        function handleLinkInBrowser(link, duration, data) {
            const container = document.getElementById('browserIframeContainer');
            const urlDisplay = document.getElementById('browserUrl');
            
            urlDisplay.textContent = link;
            
            // Create iframe with proper attributes
            container.innerHTML = `
                <iframe 
                    src="${link}"
                    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
                    style="width:100%; height:100%; border:none;"
                    id="taskIframe"
                ></iframe>
            `;
            
            startTimer(duration, data.type, data);
        }

        // ==================== TIMER FUNCTIONS ====================
        function startTimer(seconds, type, data) {
            let remaining = seconds;
            const display = document.getElementById('timerDisplay');
            const progressBar = document.getElementById('timerProgressBar');
            const timerLabel = document.getElementById('timerLabel');
            
            timerLabel.textContent = getTimerLabel(type);
            document.getElementById('timerOverlay').style.display = 'flex';
            updateTimerDisplay();
            
            appState.timerInterval = setInterval(() => {
                remaining--;
                updateTimerDisplay();
                
                if (remaining <= 0) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                    
                    if (type === 'task' || type === 'post_action') {
                        completeTask(data);
                    } else if (type === 'ad') {
                        completeAd(data);
                    }
                    
                    closeBrowserModal();
                }
            }, 1000);
            
            function updateTimerDisplay() {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                const progress = ((seconds - remaining) / seconds) * 100;
                progressBar.style.width = `${progress}%`;
            }
        }

        function startTimerDirect(seconds, data) {
            let remaining = seconds;
            
            // Show toast with timer
            const toastId = 'direct_timer_' + Date.now();
            showToast(`Task started. Timer: ${Math.floor(seconds/60)}:${(seconds%60).toString().padStart(2, '0')}`, 'info', 1000000);
            
            const interval = setInterval(() => {
                remaining--;
                
                if (remaining <= 0) {
                    clearInterval(interval);
                    
                    if (data.type === 'task' || data.type === 'post_action') {
                        completeTask(data);
                    } else if (data.type === 'ad') {
                        completeAd(data);
                    }
                    
                    // Remove toast
                    const toast = document.querySelector(`[data-toast-id="${toastId}"]`);
                    if (toast) toast.remove();
                }
            }, 1000);
        }

        function getTimerLabel(type) {
            switch (type) {
                case 'task': return 'Complete the task to earn rewards';
                case 'ad': return 'Watch the ad to earn rewards';
                case 'post_action': return 'Complete the action to earn rewards';
                default: return 'Please wait while we verify completion';
            }
        }

        function getDurationForType(type) {
            switch (type) {
                case 'join': return 45;
                case 'watch': return 90;
                case 'install': return 60;
                case 'signup': return 120;
                default: return 60; // visit
            }
        }

        // ==================== BROWSER MODAL FUNCTIONS ====================
        function openBrowserModal() {
            document.getElementById('browserModal').classList.add('active');
        }

        function closeBrowserModal() {
            document.getElementById('browserModal').classList.remove('active');
            document.getElementById('browserIframeContainer').innerHTML = '';
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
            
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('timerProgressBar').style.width = '0%';
            document.getElementById('timerOverlay').style.display = 'none';
        }

        // ==================== SCREEN NAVIGATION ====================
        function switchScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const screen = document.getElementById(`${screenName}Screen`);
            if (screen) {
                screen.classList.add('active');
            }
            
            const navItem = Array.from(document.querySelectorAll('.nav-item')).find(item => 
                item.textContent.includes(screenName.charAt(0).toUpperCase() + screenName.slice(1).replace('Screen', ''))
            );
            
            if (navItem) {
                navItem.classList.add('active');
            }
            
            window.location.hash = screenName;
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getRandomSmartLink() {
            return SMART_LINKS[Math.floor(Math.random() * SMART_LINKS.length)];
        }

        function getRandomAdTitle() {
            const titles = [
                'Tech Review 2024',
                'Crypto Market Update',
                'Gaming News Today',
                'Product Launch Event',
                'Mobile App Review',
                'Finance Tips Daily',
                'Lifestyle & Wellness',
                'Travel Destination Guide',
                'Food & Cooking Show',
                'Fashion Trends 2024'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function getRandomAdSource() {
            const sources = [
                'TechBrand Co.',
                'CryptoExchange',
                'GameStore',
                'Fashion Brand',
                'Finance Corp',
                'Travel Agency',
                'Food Network',
                'Media Group',
                'Entertainment Inc.',
                'Shopping Mall'
            ];
            return sources[Math.floor(Math.random() * sources.length)];
        }

        function getRandomTaskTitle() {
            const titles = [
                'Website Visit Task',
                'Survey Completion',
                'App Installation',
                'Product Review',
                'Market Research',
                'Social Media Follow',
                'Video Watching',
                'Article Reading',
                'Quiz Participation',
                'Feedback Submission'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function getRandomTaskDescription() {
            const descriptions = [
                'Visit website and stay for specified time',
                'Complete short survey for research',
                'Install app and open for verification',
                'Review product features',
                'Participate in market research',
                'Follow social media account',
                'Watch video completely',
                'Read article carefully',
                'Participate in short quiz',
                'Submit your feedback'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        function getRandomCount() {
            return Math.floor(Math.random() * 10) + 1;
        }

        function getRandomColor() {
            const colors = ['#4AA3FF', '#E33D7A', '#5B2E8A', '#FF98BD', '#FFC857', '#2ECC71', '#9B59B6', '#1ABC9C', '#E67E22', '#3498DB'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getActionText(type) {
            const actions = {
                visit: 'Visit',
                join: 'Join',
                watch: 'Watch',
                install: 'Install',
                signup: 'Sign Up'
            };
            return actions[type] || 'Open';
        }

        function getInitials(firstName, lastName) {
            return ((firstName?.[0] || '') + (lastName?.[0] || '')).toUpperCase() || 'U';
        }

        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const toastId = 'toast_' + Date.now();
            toast.dataset.toastId = toastId;
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${icons[type] || ''}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                const toastEl = document.querySelector(`[data-toast-id="${toastId}"]`);
                if (toastEl && toastEl.parentNode) {
                    toastEl.remove();
                }
            }, duration);
        }

        // ==================== INTERACTION FUNCTIONS ====================
        async function handleLike(postId, button) {
            if (!appState.user?.id) {
                showToast('Please login to like posts', 'warning');
                return;
            }
            
            const post = appState.posts.find(p => p.id === postId);
            if (!post) return;
            
            // Get user data
            const userData = PersistentStorage.getUserData(appState.user.id);
            userData.likedPosts = userData.likedPosts || [];
            
            const wasLiked = userData.likedPosts.includes(postId);
            
            if (wasLiked) {
                // Unlike
                post.likes = Math.max(0, post.likes - 1);
                userData.likedPosts = userData.likedPosts.filter(id => id !== postId);
                button.classList.remove('liked');
            } else {
                // Like
                post.likes++;
                userData.likedPosts.push(postId);
                button.classList.add('liked');
            }
            
            // Update post views
            if (!post.views) post.views = 0;
            post.views++;
            
            // Save changes
            PersistentStorage.setUserData(appState.user.id, userData);
            PersistentStorage.setGlobalPosts(appState.posts);
            
            // Update button text
            button.querySelector('span').textContent = post.likes;
            
            // Send to bot
            if (appState.botCallbackUrl) {
                await sendToBot('post_liked', {
                    post_id: postId,
                    liked: !wasLiked,
                    total_likes: post.likes
                });
            }
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('active');
            }
        }

        async function sendComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            if (!appState.user?.id) {
                showToast('Please login to comment', 'warning');
                return;
            }
            
            const post = appState.posts.find(p => p.id === postId);
            if (!post) return;
            
            const comment = {
                id: `comment_${Date.now()}`,
                userId: appState.user.id,
                username: appState.user.username || 'User',
                text: text,
                timestamp: new Date().toISOString()
            };
            
            post.comments.push(comment);
            
            // Update global storage
            PersistentStorage.setGlobalPosts(appState.posts);
            
            // Update UI
            const commentsContainer = document.getElementById(`comments-container-${postId}`);
            if (commentsContainer) {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.innerHTML = `
                    <div class="comment-avatar">${appState.user.username?.charAt(0) || 'U'}</div>
                    <div class="comment-content">
                        <div class="comment-author">${appState.user.username || 'You'}</div>
                        <div class="comment-text">${text}</div>
                    </div>
                `;
                commentsContainer.appendChild(commentDiv);
            }
            
            input.value = '';
            
            // Send to bot
            if (appState.botCallbackUrl) {
                await sendToBot('comment_added', {
                    post_id: postId,
                    comment_length: text.length,
                    total_comments: post.comments.length
                });
            }
            
            showToast('Comment added!', 'success');
        }

        function viewUserProfile(userId) {
            switchScreen('profile');
            showToast('User profile view coming soon!', 'info');
        }

        function viewTaskDetails(taskId) {
            const task = [...appState.tasks, ...appState.randomTasks].find(t => t.id === taskId);
            if (task) {
                showToast(`${task.title}: ${task.description}`, 'info');
            }
        }

        // ==================== PROFILE FUNCTIONS ====================
        function showProfileSection(section) {
            const modal = document.getElementById('profileSectionModal');
            const title = document.getElementById('profileSectionTitle');
            const content = document.getElementById('profileSectionContent');
            
            if (!modal || !title || !content) return;
            
            let sectionContent = '';
            
            switch (section) {
                case 'edit':
                    title.textContent = 'Edit Profile';
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">Telegram Username</label>
                            <input type="text" class="form-input" value="${appState.user?.username || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-input" value="${appState.user?.id || appState.payloadData?.user_id || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">VIP Level</label>
                            <div class="vip-badge ${appState.vipLevel}" style="margin-top: 8px; display: inline-block;">
                                ${appState.vipLevel.charAt(0).toUpperCase() + appState.vipLevel.slice(1)} VIP
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Balance</label>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10" cy="10" r="9" fill="#FFC857" />
                                    <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="10" font-weight="700">G</text>
                                </svg>
                                <span style="font-weight: 600; color: var(--gcoin-gold);">${appState.balance.toLocaleString()} G-Coins</span>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'transactions':
                    title.textContent = 'Transaction History';
                    // Generate sample transactions
                    const transactions = [
                        { type: 'earn', title: 'Task Reward - YouTube', time: '2 hours ago', amount: 5000 },
                        { type: 'earn', title: 'Ad Watch Reward', time: '5 hours ago', amount: 120 },
                        { type: 'spend', title: 'Post Creation', time: '1 day ago', amount: 10000 },
                        { type: 'earn', title: 'Referral Bonus', time: '2 days ago', amount: 500 },
                        { type: 'earn', title: 'Daily Bonus', time: '3 days ago', amount: 200 }
                    ];
                    
                    sectionContent = `
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${transactions.map(t => `
                                <div class="transaction-item">
                                    <div class="transaction-icon ${t.type}">${t.type === 'earn' ? '+' : '-'}</div>
                                    <div class="transaction-details">
                                        <div class="transaction-title">${t.title}</div>
                                        <div class="transaction-time">${t.time}</div>
                                    </div>
                                    <div class="transaction-amount ${t.type}">${t.type === 'earn' ? '+' : '-'}${t.amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'referrals':
                    title.textContent = 'Referrals';
                    const refLink = `https://t.me/GainGrid_Bot?start=${appState.payloadData?.user_id || 'ref'}`;
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">Your Referral Link</label>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" class="form-input" value="${refLink}" id="refLinkInput" readonly>
                                <button class="submit-btn" style="flex: 0 0 auto; padding: 0 16px;" 
                                        onclick="copyRefLink()">
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="profile-stats" style="margin-top: 24px;">
                            <div class="stat-item">
                                <div class="stat-value">${appState.referrals || 0}</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">0</div>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${(appState.referrals || 0) * 1000}</div>
                                <div class="stat-label">Total Earned</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'settings':
                    title.textContent = 'Settings';
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">App Version</label>
                            <input type="text" class="form-input" value="2.0.0" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Updated</label>
                            <input type="text" class="form-input" value="${new Date().toLocaleDateString()}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session ID</label>
                            <input type="text" class="form-input" value="${appState.sessionId}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Storage Status</label>
                            <div style="margin-top: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #2ECC71;"></div>
                                    <span>Persistent Storage: Active</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #2ECC71;"></div>
                                    <span>Global Posts: ${appState.posts.length}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            content.innerHTML = sectionContent;
            modal.classList.add('active');
        }

        function closeProfileSection() {
            document.getElementById('profileSectionModal').classList.remove('active');
        }

        function openHelpSupport() {
            if (appState.WebApp) {
                appState.WebApp.openTelegramLink('https://t.me/GainGrid_Bot?start=help');
            } else {
                window.open('https://t.me/GainGrid_Bot?start=help', '_blank');
            }
        }

        function copyRefLink() {
            const input = document.getElementById('refLinkInput');
            if (input) {
                input.select();
                document.execCommand('copy');
                showToast('Referral link copied!', 'success');
            }
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            const mainContent = document.getElementById('mainContent');
            const fab = document.getElementById('fabPost');
            
            if (mainContent && fab) {
                mainContent.addEventListener('scroll', () => {
                    const currentScroll = mainContent.scrollTop;
                    
                    if (currentScroll > appState.lastScrollPosition && currentScroll > 100) {
                        fab.classList.add('hidden');
                    } else {
                        fab.classList.remove('hidden');
                    }
                    
                    appState.lastScrollPosition = currentScroll;
                });
            }
            
            // Media upload handling
            const mediaDropArea = document.getElementById('mediaDropArea');
            const mediaInput = document.getElementById('mediaInput');
            
            if (mediaDropArea && mediaInput) {
                mediaDropArea.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-preview')) return;
                    mediaInput.click();
                });
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    mediaDropArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    mediaDropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    mediaDropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    mediaDropArea.classList.add('drag-over');
                }
                
                function unhighlight() {
                    mediaDropArea.classList.remove('drag-over');
                }
                
                mediaDropArea.addEventListener('drop', handleDrop, false);
                mediaInput.addEventListener('change', handleFiles, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFiles({ target: { files } });
                }
                
                function handleFiles(e) {
                    const files = e.target.files;
                    const preview = document.getElementById('mediaPreview');
                    
                    preview.innerHTML = '';
                    
                    Array.from(files).slice(0, 4).forEach(file => {
                        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'video/mp4', 'video/webm', 'video/ogg'];
                        if (!validTypes.includes(file.type)) {
                            showToast(`File type ${file.type} not supported. Please upload images or videos.`, 'error');
                            return;
                        }
                        
                        if (file.size > 10 * 1024 * 1024) {
                            showToast(`File ${file.name} is too large. Max size is 10MB.`, 'error');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'preview-item';
                            
                            if (file.type.startsWith('image/')) {
                                previewItem.innerHTML = `
                                    <img src="${e.target.result}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">
                                    <button class="remove-preview" onclick="this.parentElement.remove()"></button>
                                `;
                            } else if (file.type.startsWith('video/')) {
                                previewItem.innerHTML = `
                                    <video src="${e.target.result}" controls style="width:100%;height:100%;object-fit:cover;"></video>
                                    <button class="remove-preview" onclick="this.parentElement.remove()"></button>
                                `;
                            }
                            
                            preview.appendChild(previewItem);
                        };
                        
                        reader.readAsDataURL(file);
                    });
                }
            }
            
            // Profile menu buttons
            document.getElementById('editProfileBtn')?.addEventListener('click', () => {
                showProfileSection('edit');
            });
            
            document.getElementById('transactionHistoryBtn')?.addEventListener('click', () => {
                showProfileSection('transactions');
            });
            
            document.getElementById('referralsBtn')?.addEventListener('click', () => {
                showProfileSection('referrals');
            });
            
            document.getElementById('settingsBtn')?.addEventListener('click', () => {
                showProfileSection('settings');
            });
            
            document.getElementById('helpSupportBtn')?.addEventListener('click', openHelpSupport);
            
            // Cleanup button
            document.getElementById('cleanupBtn')?.addEventListener('click', cleanupWatched);
            
            // New task button
            document.getElementById('newTaskBtn')?.addEventListener('click', () => {
                showToast('New task feature coming soon!', 'info');
            });
            
            // Hash change for navigation
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.replace('#', '');
                if (hash && hash !== 'iframe') {
                    switchScreen(hash);
                }
            });
            
            // Initialize Monetag ads
            initializeMonetagAds();
        }

        // ==================== PLATFORM AUTO SCROLL ====================
        function initPlatformAutoScroll() {
            const platformGrid = document.getElementById('platformGrid');
            if (!platformGrid) return;
            
            const platformCards = platformGrid.querySelectorAll('.platform-card');
            const totalWidth = Array.from(platformCards).reduce((sum, card) => sum + card.offsetWidth + 16, 0);
            platformGrid.style.width = `${totalWidth * 2}px`;
            
            platformGrid.addEventListener('animationiteration', () => {
                platformGrid.style.transform = 'translateX(0)';
            });
        }

        // ==================== MONETAG AD INTEGRATION ====================
        function initializeMonetagAds() {
            if (typeof monetag !== 'undefined') {
                try {
                    monetag('start');
                } catch (error) {
                    console.log('Monetag setup error:', error);
                }
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        window.switchScreen = switchScreen;
        window.openComposer = openComposer;
        window.closeComposer = closeComposer;
        window.handleLike = handleLike;
        window.handleTaskAction = handleTaskAction;
        window.toggleComments = toggleComments;
        window.sendComment = sendComment;
        window.watchAd = watchAd;
        window.cleanupWatched = cleanupWatched;
        window.startTask = startTask;
        window.viewTaskDetails = viewTaskDetails;
        window.viewUserProfile = viewUserProfile;
        window.copyRefLink = copyRefLink;
        window.closeBrowserModal = closeBrowserModal;
        window.closeProfileSection = closeProfileSection;
        window.showToast = showToast;
        window.submitPost = submitPost;

        // Start initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>