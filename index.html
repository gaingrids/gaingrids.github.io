<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GainGrid Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --deep-purple: #5B2E8A;
            --vivid-magenta: #E33D7A;
            --soft-pink: #FF98BD;
            --electric-blue: #4AA3FF;
            --bg-dark: #0F0F14;
            --bg-panel: #0B0B0D;
            --text-secondary: #9AA0A6;
            --gcoin-gold: #FFC857;
            --white: #FFFFFF;
            --spacing-base: 8px;
            --radius-xs: 6px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--white);
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .app-header {
            width: 100%;
            background: var(--bg-panel);
            padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .app-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .balance-chip {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(227, 61, 122, 0.3));
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 200, 87, 0.3);
        }

        .coin-icon {
            width: 20px;
            height: 20px;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .balance-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--gcoin-gold);
        }

        .main-content {
            flex: 1;
            width: 100%;
            padding: calc(var(--spacing-base) * 3) calc(var(--spacing-base) * 2);
            padding-bottom: calc(var(--spacing-base) * 15);
            overflow-y: auto;
            position: relative;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feed-container {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .post-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
            transition: all 0.3s ease;
        }

        .post-card:hover {
            border-color: rgba(91, 46, 138, 0.4);
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1.5);
            margin-bottom: calc(var(--spacing-base) * 2);
            cursor: pointer;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--deep-purple), var(--electric-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-meta {
            flex: 1;
        }

        .poster-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--white);
            margin-bottom: 2px;
        }

        .post-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--white);
            margin-bottom: calc(var(--spacing-base) * 2);
            word-break: break-word;
        }

        .post-media {
            width: 100%;
            border-radius: var(--radius-sm);
            margin-bottom: calc(var(--spacing-base) * 2);
            overflow: hidden;
            max-height: 400px;
        }

        .post-media img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--radius-sm);
        }

        .post-media video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--radius-sm);
        }

        .earnings-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 200, 87, 0.1);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            border-radius: var(--radius-xs);
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .earnings-label {
            font-size: 12px;
            color: var(--gcoin-gold);
            font-weight: 600;
        }

        .post-actions {
            display: flex;
            gap: calc(var(--spacing-base) * 2);
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .action-btn.liked {
            background: rgba(227, 61, 122, 0.2);
            color: var(--vivid-magenta);
        }

        .action-icon {
            width: 16px;
            height: 16px;
        }

        .comments-section {
            margin-top: calc(var(--spacing-base) * 2);
            padding-top: calc(var(--spacing-base) * 2);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: none;
        }

        .comments-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .comments-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: calc(var(--spacing-base) * 1.5);
        }

        .comment-item {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1);
            margin-bottom: calc(var(--spacing-base) * 1);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-sm);
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--deep-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .comment-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-input-container {
            display: flex;
            gap: calc(var(--spacing-base) * 1);
        }

        .comment-input {
            flex: 1;
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }

        .send-comment-btn {
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: var(--electric-blue);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .task-board-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 2);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .task-counter {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            font-size: 14px;
        }

        .counter-label {
            color: var(--text-secondary);
        }

        .counter-value {
            font-weight: 700;
            color: var(--electric-blue);
        }

        .new-task-btn {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .new-task-btn:hover {
            transform: scale(1.05);
        }

        .platform-grid-container {
            position: relative;
            margin-bottom: calc(var(--spacing-base) * 3);
        }

        .platform-grid {
            display: flex;
            gap: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 1);
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .platform-grid::-webkit-scrollbar {
            display: none;
        }

        .platform-card {
            min-width: 100px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .platform-card:hover {
            transform: translateY(-4px);
            border-color: var(--electric-blue);
            box-shadow: 0 8px 32px rgba(74, 163, 255, 0.2);
        }

        .platform-card.active {
            border-color: var(--vivid-magenta);
            background: rgba(227, 61, 122, 0.1);
        }

        .platform-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto calc(var(--spacing-base) * 1);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            padding: calc(var(--spacing-base) * 1);
        }

        .platform-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }

        .platform-card:hover .platform-icon svg {
            transform: scale(1.1) rotate(5deg);
        }

        .platform-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--white);
            margin-bottom: calc(var(--spacing-base) * 0.5);
        }

        .platform-count {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .task-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
            position: relative;
        }

        .task-card.completed {
            opacity: 0.7;
            border-color: rgba(46, 204, 113, 0.3);
        }

        .task-card.completed::before {
            content: 'COMPLETED';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            padding: 4px 8px;
            border-radius: var(--radius-xs);
            font-size: 10px;
            font-weight: 600;
        }

        .task-header {
            display: flex;
            align-items: start;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-base) * 1);
            color: var(--white);
        }

        .task-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: calc(var(--spacing-base) * 1);
        }

        .task-reward {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 200, 87, 0.15);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 700;
            color: var(--gcoin-gold);
        }

        .task-footer {
            display: flex;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .task-btn {
            flex: 1;
            padding: calc(var(--spacing-base) * 1.5);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .task-btn.primary {
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            color: var(--white);
        }

        .task-btn.primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(91, 46, 138, 0.4);
        }

        .task-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--white);
        }

        .task-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .watch-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 2);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .daily-limit {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cleanup-btn {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.75);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(227, 61, 122, 0.15);
            border: 1px solid rgba(227, 61, 122, 0.3);
            border-radius: var(--radius-sm);
            color: var(--vivid-magenta);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .cleanup-btn:hover {
            background: rgba(227, 61, 122, 0.25);
            transform: scale(1.05);
        }

        .watch-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: calc(var(--spacing-base) * 2);
        }

        .video-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .video-card:hover {
            transform: translateY(-4px);
            border-color: rgba(74, 163, 255, 0.4);
        }

        .video-card.watched {
            opacity: 0.6;
            pointer-events: none;
        }

        .video-thumbnail {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(74, 163, 255, 0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .play-icon {
            width: 48px;
            height: 48px;
            opacity: 0.9;
        }

        .video-duration {
            position: absolute;
            bottom: calc(var(--spacing-base) * 1);
            right: calc(var(--spacing-base) * 1);
            background: rgba(0, 0, 0, 0.8);
            padding: calc(var(--spacing-base) * 0.5) calc(var(--spacing-base) * 1);
            border-radius: var(--radius-xs);
            font-size: 12px;
            font-weight: 600;
        }

        .video-info {
            padding: calc(var(--spacing-base) * 2);
        }

        .video-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-base) * 1);
            line-height: 1.3;
        }

        .video-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .video-reward {
            color: var(--gcoin-gold);
            font-weight: 600;
        }

        .collected-badge {
            color: var(--electric-blue);
            font-weight: 600;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 3);
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 3);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            border: 3px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .profile-username {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: calc(var(--spacing-base) * 2);
            width: 100%;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--electric-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
            overflow: hidden;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 2.5);
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: var(--bg-panel);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-around;
            padding: calc(var(--spacing-base) * 1.5) 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
            text-decoration: none;
        }

        .nav-item:hover {
            color: var(--white);
        }

        .nav-item.active {
            color: var(--electric-blue);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.12s ease;
        }

        .fab {
            position: fixed;
            bottom: calc(var(--spacing-base) * 12);
            right: calc(var(--spacing-base) * 2);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--vivid-magenta), var(--soft-pink));
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(227, 61, 122, 0.4);
            transition: all 0.3s ease;
            z-index: 99;
            opacity: 1;
            transform: translateY(0);
        }

        .fab.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(227, 61, 122, 0.6);
        }

        .fab-icon {
            width: 24px;
            height: 24px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(var(--spacing-base) * 2);
        }

        .modal-content {
            width: 100%;
            max-width: 500px;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .close-icon {
            width: 16px;
            height: 16px;
        }

        .composer-form {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 1);
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.12s ease;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--electric-blue);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .media-attach-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 3);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .media-attach-area:hover {
            border-color: var(--electric-blue);
            background: rgba(74, 163, 255, 0.05);
        }

        .media-attach-area.drag-over {
            border-color: var(--vivid-magenta);
            background: rgba(227, 61, 122, 0.05);
        }

        .attach-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto calc(var(--spacing-base) * 2);
            color: var(--text-secondary);
        }

        .media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: calc(var(--spacing-base) * 1);
            margin-top: calc(var(--spacing-base) * 2);
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submit-btn {
            padding: calc(var(--spacing-base) * 2);
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .submit-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(91, 46, 138, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .browser-frame {
            width: 100%;
            height: 80vh;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .browser-header {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .browser-dots {
            display: flex;
            gap: calc(var(--spacing-base) * 0.75);
        }

        .browser-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .browser-url {
            flex: 1;
            padding: calc(var(--spacing-base) * 0.75) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xs);
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .browser-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .browser-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .timer-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11, 11, 13, 0.95);
            padding: calc(var(--spacing-base) * 2);
            z-index: 10;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .timer-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--electric-blue);
            text-align: center;
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .timer-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--deep-purple), var(--vivid-magenta));
            width: 0%;
            transition: width 1s linear;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--electric-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid var(--electric-blue);
        }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .vip-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: var(--radius-xs);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .vip-badge.none {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .vip-badge.basic {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .vip-badge.silver {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .vip-badge.gold {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .vip-badge.premium {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 430px;
                margin: 0 auto;
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.3);
            }

            .watch-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @keyframes scrollPlatforms {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .platform-grid.auto-scroll {
            animation: scrollPlatforms 30s linear infinite;
        }

        .platform-grid-container:hover .platform-grid.auto-scroll {
            animation-play-state: paused;
        }

        .platform-card.youtube { border-color: rgba(255, 0, 0, 0.3); }
        .platform-card.youtube:hover { border-color: #FF0000; }
        
        .platform-card.telegram { border-color: rgba(0, 136, 204, 0.3); }
        .platform-card.telegram:hover { border-color: #0088cc; }
        
        .platform-card.instagram { border-color: rgba(225, 48, 108, 0.3); }
        .platform-card.instagram:hover { border-color: #E1306C; }
        
        .platform-card.twitter { border-color: rgba(29, 161, 242, 0.3); }
        .platform-card.twitter:hover { border-color: #1DA1F2; }
        
        .platform-card.tiktok { border-color: rgba(0, 0, 0, 0.3); }
        .platform-card.tiktok:hover { border-color: #000000; }
        
        .platform-card.whatsapp { border-color: rgba(37, 211, 102, 0.3); }
        .platform-card.whatsapp:hover { border-color: #25D366; }
        
        .platform-card.discord { border-color: rgba(88, 101, 242, 0.3); }
        .platform-card.discord:hover { border-color: #5865F2; }
        
        .platform-card.facebook { border-color: rgba(24, 119, 242, 0.3); }
        .platform-card.facebook:hover { border-color: #1877F2; }
        
        .platform-card.website { border-color: rgba(74, 163, 255, 0.3); }
        .platform-card.website:hover { border-color: #4AA3FF; }
        
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .transaction-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .transaction-icon.earn {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .transaction-icon.spend {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .transaction-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }
        
        .transaction-amount.earn {
            color: #2ecc71;
        }
        
        .transaction-amount.spend {
            color: #e74c3c;
        }
    </style>
    
    <!-- Monetag Ad SDK -->
    <script>
        (function(m,o,n,e,t,a,g){
            m['MonetagObject']=t;m[t]=m[t]||function(){
                (m[t].q=m[t].q||[]).push(arguments)
            };
            a=o.createElement(n);g=o.getElementsByTagName(n)[0];
            a.async=1;a.src=e;g.parentNode.insertBefore(a,g)
        })(window,document,'script','https://cdn.monetag.com/tag.min.js','monetag');
        monetag('start');
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading GainGrid...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-section">
                <div class="logo-icon">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="url(#logo-gradient)" />
                        <path d="M10 16L14 20L22 12" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        <defs>
                            <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#5B2E8A" />
                                <stop offset="1" stop-color="#E33D7A" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h1 class="app-title" id="appTitle">GainGrid</h1>
            </div>
            <div class="balance-chip">
                <div class="coin-icon">
                    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="9" fill="#FFC857" stroke="#FFD87A" stroke-width="1" />
                        <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="12" font-weight="700">G</text>
                    </svg>
                </div>
                <span class="balance-text" id="balanceText">0</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- GridHome Screen -->
            <section class="screen active" id="gridhomeScreen">
                <div class="feed-container" id="feedContainer">
                    <!-- Posts loaded dynamically -->
                </div>
            </section>

            <!-- Task Board Screen -->
            <section class="screen" id="tasksScreen">
                <div class="task-board-header">
                    <div class="task-counter">
                        <span class="counter-label">Tasks today:</span>
                        <span class="counter-value" id="taskCounter">0/20</span>
                    </div>
                    <button class="new-task-btn" id="newTaskBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>New Task</span>
                    </button>
                </div>

                <!-- Platform Grid -->
                <div class="platform-grid-container">
                    <div class="platform-grid auto-scroll" id="platformGrid">
                        <!-- Platforms loaded dynamically -->
                    </div>
                </div>

                <!-- Task List -->
                <div class="task-list" id="taskList">
                    <!-- Tasks loaded dynamically -->
                </div>
            </section>

            <!-- Watch & Earn Screen -->
            <section class="screen" id="watchScreen">
                <div class="watch-header">
                    <div class="daily-limit">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" />
                            <path d="M10 5V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>Daily Ads: <strong id="adsCounter">0/20</strong></span>
                    </div>
                    <button class="cleanup-btn" id="cleanupBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 4H14M6 7V11M10 7V11M3 4L4 13C4 13.5 4.5 14 5 14H11C11.5 14 12 13.5 12 13L13 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        </svg>
                        <span>Clean Up</span>
                    </button>
                </div>

                <div class="watch-grid" id="watchGrid">
                    <!-- Ads loaded dynamically -->
                </div>
            </section>

            <!-- Profile Screen -->
            <section class="screen" id="profileScreen">
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            <!-- Avatar loaded dynamically -->
                        </div>
                        <h2 class="profile-name" id="profileName">Loading...</h2>
                        <p class="profile-username" id="profileUsername">@username</p>
                        <div class="vip-badge gold" id="vipBadge">VIP Level</div>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="statGcoins">0</div>
                            <div class="stat-label">G-Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statTotalEarned">0</div>
                            <div class="stat-label">Total Earned</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statTasksDone">0</div>
                            <div class="stat-label">Tasks Done</div>
                        </div>
                    </div>

                    <div class="profile-menu">
                        <button class="menu-item" id="editProfileBtn">
                            <span>Edit Profile</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="transactionHistoryBtn">
                            <span>Transaction History</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="referralsBtn">
                            <span>Referrals</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="settingsBtn">
                            <span>Settings</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="helpSupportBtn">
                            <span>Help & Support</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchScreen('gridhome')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>GridHome</span>
            </button>
            <button class="nav-item" onclick="switchScreen('tasks')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Tasks</span>
            </button>
            <button class="nav-item" onclick="switchScreen('watch')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Watch</span>
            </button>
            <button class="nav-item" onclick="switchScreen('profile')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Profile</span>
            </button>
        </nav>

        <!-- Floating Action Button (Post) -->
        <button class="fab" id="fabPost" onclick="openComposer()">
            <svg class="fab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 20H21" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M16.5 3.49998C16.8978 3.10216 17.4374 2.87866 18 2.87866C18.2786 2.87866 18.5544 2.93353 18.8118 3.04014C19.0692 3.14674 19.303 3.303 19.5 3.49998C19.697 3.69697 19.8532 3.93082 19.9598 4.18819C20.0665 4.44556 20.1213 4.72141 20.1213 4.99998C20.1213 5.27856 20.0665 5.55441 19.9598 5.81178C19.8532 6.06915 19.697 6.303 19.5 6.49998L7 19L3 20L4 16L16.5 3.49998Z" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

        <!-- Modals -->
        <!-- Composer Modal -->
        <div class="modal-overlay" id="composerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Post</h2>
                    <button class="close-btn" onclick="closeComposer()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <form class="composer-form" id="postForm" onsubmit="submitPost(event)">
                    <div class="form-group">
                        <label class="form-label" for="postContent">Post Content</label>
                        <textarea class="form-textarea" id="postContent" placeholder="What do you want to share? Use # for hashtags and @ for mentions" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postLink">Link URL</label>
                        <input type="url" class="form-input" id="postLink" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postLinkType">Link Type</label>
                        <select class="form-input" id="postLinkType" required>
                            <option value="visit">Visit Website</option>
                            <option value="join">Join Group/Channel</option>
                            <option value="watch">Watch Video</option>
                            <option value="install">Install App</option>
                            <option value="signup">Sign Up</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postReward">Reward Amount (G-Coins)</label>
                        <input type="number" class="form-input" id="postReward" placeholder="Enter reward amount" min="10000" max="100000" required>
                        <div class="reward-preview">
                            <div class="preview-label">Minimum: 10,000 G-Coins</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Media (Optional)</label>
                        <div class="media-attach-area" id="mediaDropArea">
                            <svg class="attach-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="2" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.5" />
                                <circle cx="7" cy="7" r="2" stroke="currentColor" stroke-width="1.5" />
                                <path d="M2 14L7 9L12 14M10 12L13 9L18 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                            </svg>
                            <div class="file-drop-text">Drag & drop photos/videos or click to upload</div>
                            <div class="file-drop-hint">Max size: 10MB</div>
                            <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;">
                        </div>
                        <div class="media-preview" id="mediaPreview"></div>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="postSubmitBtn">Publish Post</button>
                </form>
            </div>
        </div>

        <!-- Browser Modal -->
        <div class="modal-overlay" id="browserModal">
            <div class="browser-frame">
                <div class="browser-header">
                    <div class="browser-dots">
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                    </div>
                    <div class="browser-url" id="browserUrl">https://gaingrid.com</div>
                    <button class="close-btn" onclick="closeBrowserModal()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <div class="browser-content">
                    <iframe class="browser-iframe" id="browserIframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
                    <div class="timer-overlay" id="timerOverlay">
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        <div class="timer-label" id="timerLabel">Please wait while we verify completion</div>
                        <div class="timer-progress">
                            <div class="timer-progress-bar" id="timerProgressBar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section Modal -->
        <div class="modal-overlay" id="profileSectionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="profileSectionTitle">Profile Section</h2>
                    <button class="close-btn" onclick="closeProfileSection()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="profileSectionContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const appState = {
            user: null,
            balance: 0,
            vipLevel: 'none',
            referrals: {
                completed: 0,
                pending: 0,
                totalEarned: 0
            },
            dailyCounters: {
                tasks: 0,
                ads: 0
            },
            posts: [],
            tasks: [],
            ads: [],
            randomTasks: [],
            platforms: [],
            currentTask: null,
            currentAd: null,
            currentPostId: null,
            timerInterval: null,
            isTelegramWebApp: false,
            WebApp: null,
            lastScrollPosition: 0,
            telegramUserId: null,
            botCallbackUrl: null,
            sessionId: Date.now().toString(),
            lastEventTime: 0,
            payloadProcessed: false
        };

        // ==================== PERSISTENT STORAGE ====================
        const STORAGE_KEYS = {
            POSTS: 'gaingrid_viral_posts',
            USER_STATE: 'gaingrid_user_state',
            APP_DATA: 'gaingrid_app_data',
            TASKS: 'gaingrid_tasks_data',
            ADS: 'gaingrid_ads_data'
        };

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Error loading from storage:', e);
                return null;
            }
        }

        // ==================== BASE64 PAYLOAD PARSING ====================
        function parseBase64Payload(base64String) {
            try {
                // Try different base64 decoding methods
                const decoded = atob(base64String.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch (e1) {
                try {
                    // Try URI component decoding first
                    const decoded = decodeURIComponent(escape(atob(base64String)));
                    return JSON.parse(decoded);
                } catch (e2) {
                    try {
                        // Try direct JSON parse
                        return JSON.parse(base64String);
                    } catch (e3) {
                        console.error('Failed to parse payload:', e3);
                        return null;
                    }
                }
            }
        }

        function extractPayloadFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                
                // Check multiple parameter names
                const payloadSources = [
                    urlParams.get('payload'),
                    urlParams.get('data'),
                    urlParams.get('start'),
                    urlParams.get('p'),
                    hashParams.get('payload'),
                    hashParams.get('data'),
                    hashParams.get('start'),
                    hashParams.get('p')
                ];
                
                for (const source of payloadSources) {
                    if (source) {
                        const payload = parseBase64Payload(source);
                        if (payload) {
                            console.log('Payload extracted:', payload);
                            return payload;
                        }
                    }
                }
                
                // Try direct hash parsing
                if (window.location.hash && window.location.hash.length > 1) {
                    const hash = window.location.hash.substring(1);
                    if (hash.includes('=')) {
                        const hashParams = new URLSearchParams(hash);
                        const payloadParam = hashParams.get('payload') || hashParams.get('data') || hashParams.get('start');
                        if (payloadParam) {
                            const payload = parseBase64Payload(payloadParam);
                            if (payload) return payload;
                        }
                    } else {
                        // Try direct base64 decode of hash
                        try {
                            const payload = parseBase64Payload(hash);
                            if (payload) return payload;
                        } catch (e) {
                            // Not base64
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error extracting payload:', error);
                return null;
            }
        }

        // ==================== BOT COMMUNICATION ====================
        async function sendToBot(action, data) {
            try {
                if (!appState.botCallbackUrl) {
                    console.warn('No bot callback URL set');
                    return { success: false, error: 'No callback URL' };
                }
                
                const payload = {
                    action: action,
                    data: data,
                    timestamp: Date.now(),
                    sessionId: appState.sessionId,
                    userId: appState.telegramUserId,
                    source: 'webapp'
                };
                
                const response = await fetch(appState.botCallbackUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-GainGrid-Source': 'WebApp',
                        'X-GainGrid-User-ID': appState.telegramUserId || 'unknown'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return { success: true, data: result };
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error sending to bot:', error);
                return { success: false, error: error.message };
            }
        }

        // ==================== PROCESS BOT PAYLOAD ====================
        async function processBotPayload(payload) {
            if (!payload || appState.payloadProcessed) return;
            
            console.log('Processing bot payload:', payload);
            
            // Store payload data
            appState.payloadProcessed = true;
            
            // Extract user data from payload
            if (payload.user_id) appState.telegramUserId = payload.user_id;
            if (payload.userId) appState.telegramUserId = payload.userId;
            
            // Extract balance from payload (prioritize bot data)
            if (payload.balance !== undefined && payload.balance !== null) {
                appState.balance = Number(payload.balance);
                updateBalanceDisplay();
            }
            
            // Extract VIP level from payload
            if (payload.vip_level) {
                appState.vipLevel = String(payload.vip_level).toLowerCase();
                updateVipBadge();
            } else if (payload.vipLevel) {
                appState.vipLevel = String(payload.vipLevel).toLowerCase();
                updateVipBadge();
            }
            
            // Extract referral data
            if (payload.referrals) {
                appState.referrals.completed = Number(payload.referrals.completed) || 0;
                appState.referrals.pending = Number(payload.referrals.pending) || 0;
                appState.referrals.totalEarned = Number(payload.referrals.total_earned) || Number(payload.referrals.totalEarned) || 0;
                updateReferralDisplay();
            }
            
            // Extract user info
            if (payload.user) {
                appState.user = {
                    id: payload.user.id || payload.user.user_id,
                    firstName: payload.user.first_name || payload.user.firstName || 'User',
                    lastName: payload.user.last_name || payload.user.lastName || '',
                    username: payload.user.username || '',
                    photoUrl: payload.user.photo_url || payload.user.photoUrl || null
                };
                updateUserProfile();
            }
            
            // Extract tasks from bot
            if (payload.tasks && Array.isArray(payload.tasks)) {
                appState.tasks = payload.tasks.map(task => ({
                    id: task.id || `task_${Date.now()}_${Math.random()}`,
                    platform: task.platform || 'website',
                    title: task.title || 'Task',
                    description: task.description || 'Complete this task',
                    duration: task.duration || 60,
                    reward: task.reward || 100,
                    link: task.link || getRandomSmartLink(),
                    completed: false,
                    fromBot: true
                }));
                updateTasks();
            }
            
            // Store callback URL for future communications
            if (payload.callback_url) {
                appState.botCallbackUrl = payload.callback_url;
            } else if (payload.callbackUrl) {
                appState.botCallbackUrl = payload.callbackUrl;
            }
            
            // Send acknowledgment to bot
            if (appState.botCallbackUrl) {
                setTimeout(() => {
                    sendToBot('payload_received', {
                        userId: appState.telegramUserId,
                        status: 'processed',
                        vipLevel: appState.vipLevel,
                        balance: appState.balance
                    });
                }, 1000);
            }
            
            // Save processed state
            saveAppState();
        }

        // ==================== SMART LINKS & ADS ====================
        const SMART_LINKS = [
            'https://otieu.com/4/10176113',
            'https://otieu.com/4/10176184',
            'https://otieu.com/4/10176114',
            'https://otieu.com/4/10176185'
        ];

        const PLATFORMS = [
            { id: 'youtube', name: 'YouTube', color: '#FF0000', iframe: true },
            { id: 'telegram', name: 'Telegram', color: '#0088CC', iframe: false },
            { id: 'instagram', name: 'Instagram', color: '#E1306C', iframe: true },
            { id: 'twitter', name: 'Twitter', color: '#1DA1F2', iframe: true },
            { id: 'tiktok', name: 'TikTok', color: '#000000', iframe: true },
            { id: 'facebook', name: 'Facebook', color: '#1877F2', iframe: true },
            { id: 'whatsapp', name: 'WhatsApp', color: '#25D366', iframe: false },
            { id: 'discord', name: 'Discord', color: '#5865F2', iframe: false },
            { id: 'website', name: 'Website', color: '#4AA3FF', iframe: true }
        ];

        function getRandomSmartLink() {
            return SMART_LINKS[Math.floor(Math.random() * SMART_LINKS.length)];
        }

        // ==================== VIRAL POSTS SYSTEM ====================
        function loadViralPosts() {
            try {
                const savedPosts = loadFromStorage(STORAGE_KEYS.POSTS);
                if (savedPosts && Array.isArray(savedPosts)) {
                    appState.posts = savedPosts;
                } else {
                    // Load default viral posts
                    appState.posts = [
                        {
                            id: 'post_1',
                            userId: 'admin_001',
                            username: 'GainGridAdmin',
                            userAvatar: 'GG',
                            content: ' Welcome to GainGrid! Start earning G-Coins by completing tasks, watching ads, and creating posts. Join our viral community!',
                            media: null,
                            link: 'https://t.me/GainGridBot',
                            linkType: 'join',
                            reward: 10000,
                            likes: 245,
                            comments: [
                                { id: 'c1', userId: 'user123', username: 'CryptoKing', text: 'Great platform! Already earned 50K G-Coins!' },
                                { id: 'c2', userId: 'user456', username: 'EarnMaster', text: 'Best earning app ever!' }
                            ],
                            shares: 89,
                            views: 1250,
                            timestamp: '2 days ago',
                            userHasLiked: false,
                            viral: true
                        },
                        {
                            id: 'post_2',
                            userId: 'vip_user_001',
                            username: 'VIP_Trader',
                            userAvatar: 'VT',
                            content: ' Just earned 25,000 G-Coins from a single task! The premium VIP rewards are insane! #Earning #VIP',
                            media: null,
                            link: 'https://example.com/premium',
                            linkType: 'visit',
                            reward: 15000,
                            likes: 189,
                            comments: [
                                { id: 'c3', userId: 'user789', username: 'NewbieEarner', text: 'How do I become VIP?' },
                                { id: 'c4', userId: 'vip_user_001', username: 'VIP_Trader', text: 'Complete tasks and upgrade in bot!' }
                            ],
                            shares: 45,
                            views: 890,
                            timestamp: '1 day ago',
                            userHasLiked: false,
                            viral: true
                        },
                        {
                            id: 'post_3',
                            userId: 'task_master_001',
                            username: 'TaskMasterPro',
                            userAvatar: 'TM',
                            content: ' Daily earnings update: Completed 15 tasks, watched 8 ads = 12,500 G-Coins today! Consistency is key!',
                            media: null,
                            link: 'https://example.com/tasks',
                            linkType: 'visit',
                            reward: 8000,
                            likes: 156,
                            comments: [
                                { id: 'c5', userId: 'user101', username: 'EarningNewbie', text: 'Impressive! What tasks pay the most?' },
                                { id: 'c6', userId: 'task_master_001', username: 'TaskMasterPro', text: 'YouTube and Telegram tasks pay 5K+ each!' }
                            ],
                            shares: 32,
                            views: 720,
                            timestamp: '5 hours ago',
                            userHasLiked: false,
                            viral: true
                        },
                        {
                            id: 'post_4',
                            userId: 'crypto_expert_001',
                            username: 'CryptoGuru',
                            userAvatar: 'CG',
                            content: ' NEW: Telegram channel task available! Join and stay for 2 minutes to earn 3,500 G-Coins. Limited spots!',
                            media: null,
                            link: 'https://t.me/GainGridChannel',
                            linkType: 'join',
                            reward: 3500,
                            likes: 98,
                            comments: [
                                { id: 'c7', userId: 'user202', username: 'QuickEarner', text: 'Just completed! Easy money!' },
                                { id: 'c8', userId: 'user303', username: 'DailyGrinder', text: 'Joined and earned, thanks!' }
                            ],
                            shares: 21,
                            views: 450,
                            timestamp: '3 hours ago',
                            userHasLiked: false,
                            viral: true
                        },
                        {
                            id: 'post_5',
                            userId: 'ad_watcher_001',
                            username: 'AdWatcherPro',
                            userAvatar: 'AW',
                            content: ' Watching ads is underrated! Earned 1,200 G-Coins today just from ads. Each ad takes 30-60 seconds!',
                            media: null,
                            link: 'https://example.com/ads',
                            linkType: 'watch',
                            reward: 1200,
                            likes: 87,
                            comments: [
                                { id: 'c9', userId: 'user404', username: 'AdLover', text: 'Same here! Ads are quick money!' },
                                { id: 'c10', userId: 'user505', username: 'TimeIsMoney', text: 'Perfect for short breaks' }
                            ],
                            shares: 18,
                            views: 380,
                            timestamp: '1 hour ago',
                            userHasLiked: false,
                            viral: true
                        }
                    ];
                    saveViralPosts();
                }
                updateFeed();
            } catch (error) {
                console.error('Error loading viral posts:', error);
            }
        }

        function saveViralPosts() {
            saveToStorage(STORAGE_KEYS.POSTS, appState.posts);
        }

        function addViralPost(newPost) {
            // Add post to beginning of array
            appState.posts.unshift({
                ...newPost,
                id: `post_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                likes: 0,
                comments: [],
                shares: 0,
                views: 0,
                timestamp: 'Just now',
                userHasLiked: false,
                viral: true
            });
            
            // Keep only latest 100 posts
            if (appState.posts.length > 100) {
                appState.posts = appState.posts.slice(0, 100);
            }
            
            saveViralPosts();
            updateFeed();
            
            // Notify all users about new viral post
            showToast('New viral post added to feed!', 'success');
        }

        // ==================== TASK MANAGEMENT ====================
        function loadTasks() {
            const savedTasks = loadFromStorage(STORAGE_KEYS.TASKS);
            if (savedTasks && Array.isArray(savedTasks)) {
                appState.tasks = savedTasks;
            } else {
                // Default tasks
                appState.tasks = [
                    {
                        id: 'task_1',
                        platform: 'youtube',
                        title: 'Watch YouTube Video',
                        description: 'Watch full video and like. Stay 2:30 for reward.',
                        duration: 150,
                        reward: 5000,
                        link: getRandomSmartLink(),
                        completed: false
                    },
                    {
                        id: 'task_2',
                        platform: 'telegram',
                        title: 'Join Telegram Channel',
                        description: 'Join channel and stay active for 45 seconds.',
                        duration: 45,
                        reward: 3500,
                        link: getRandomSmartLink(),
                        completed: false
                    }
                ];
                saveTasks();
            }
            generateRandomTasks();
            updateTasks();
        }

        function saveTasks() {
            saveToStorage(STORAGE_KEYS.TASKS, appState.tasks);
        }

        function generateRandomTasks() {
            appState.randomTasks = [];
            const taskCount = Math.min(8, 20 - appState.tasks.length);
            
            for (let i = 0; i < taskCount; i++) {
                appState.randomTasks.push({
                    id: `random_${Date.now()}_${i}`,
                    platform: 'website',
                    title: getRandomTaskTitle(),
                    description: getRandomTaskDescription(),
                    duration: Math.floor(Math.random() * 120) + 60,
                    reward: Math.floor(Math.random() * 201) + 100,
                    link: getRandomSmartLink(),
                    completed: false,
                    isRandom: true
                });
            }
        }

        // ==================== ADS MANAGEMENT ====================
        function loadAds() {
            const savedAds = loadFromStorage(STORAGE_KEYS.ADS);
            if (savedAds && Array.isArray(savedAds)) {
                appState.ads = savedAds;
            } else {
                appState.ads = [];
                for (let i = 0; i < 12; i++) {
                    appState.ads.push({
                        id: `ad_${i + 1}`,
                        title: getRandomAdTitle(),
                        duration: Math.floor(Math.random() * 30) + 30,
                        reward: Math.floor(Math.random() * 61) + 60,
                        source: getRandomAdSource(),
                        link: getRandomSmartLink(),
                        watched: i < 3
                    });
                }
                saveAds();
            }
            updateAds();
        }

        function saveAds() {
            saveToStorage(STORAGE_KEYS.ADS, appState.ads);
        }

        // ==================== APP STATE MANAGEMENT ====================
        function saveAppState() {
            saveToStorage(STORAGE_KEYS.USER_STATE, {
                user: appState.user,
                balance: appState.balance,
                vipLevel: appState.vipLevel,
                referrals: appState.referrals,
                dailyCounters: appState.dailyCounters,
                telegramUserId: appState.telegramUserId,
                botCallbackUrl: appState.botCallbackUrl
            });
        }

        function loadAppState() {
            const savedState = loadFromStorage(STORAGE_KEYS.USER_STATE);
            if (savedState) {
                Object.assign(appState, savedState);
                updateUIFromState();
            }
        }

        // ==================== UI UPDATE FUNCTIONS ====================
        function updateUIFromState() {
            updateBalanceDisplay();
            updateVipBadge();
            updateUserProfile();
            updateReferralDisplay();
            updateCounters();
        }

        function updateBalanceDisplay() {
            document.getElementById('balanceText').textContent = appState.balance.toLocaleString();
            document.getElementById('statGcoins').textContent = appState.balance.toLocaleString();
        }

        function updateVipBadge() {
            const vipBadge = document.getElementById('vipBadge');
            if (!vipBadge) return;
            
            vipBadge.className = `vip-badge ${appState.vipLevel}`;
            
            const badgeText = {
                none: 'No VIP',
                basic: 'Basic VIP',
                silver: 'Silver VIP',
                gold: 'Gold VIP',
                premium: 'Premium VIP',
                free: 'Free VIP'
            }[appState.vipLevel] || 'No VIP';
            
            vipBadge.textContent = badgeText;
        }

        function updateUserProfile() {
            const profileName = document.getElementById('profileName');
            const profileUsername = document.getElementById('profileUsername');
            const profileAvatar = document.getElementById('profileAvatar');
            
            if (appState.user) {
                if (profileName) {
                    const fullName = `${appState.user.firstName || ''} ${appState.user.lastName || ''}`.trim();
                    profileName.textContent = fullName || 'User';
                }
                
                if (profileUsername) {
                    const username = appState.user.username || '';
                    profileUsername.textContent = username.startsWith('@') ? username : `@${username}`;
                }
                
                if (profileAvatar) {
                    if (appState.user.photoUrl) {
                        profileAvatar.innerHTML = `<img src="${appState.user.photoUrl}" alt="Profile">`;
                    } else {
                        const initials = (appState.user.firstName?.[0] || '') + (appState.user.lastName?.[0] || '') || 'U';
                        profileAvatar.textContent = initials;
                    }
                }
            }
        }

        function updateReferralDisplay() {
            // Will be updated in profile section modal
        }

        function updateCounters() {
            updateTaskCounter();
            updateAdsCounter();
            
            const totalEarned = appState.referrals.totalEarned || 0;
            document.getElementById('statTotalEarned').textContent = totalEarned.toLocaleString();
            document.getElementById('statTasksDone').textContent = appState.dailyCounters.tasks.toString();
        }

        function updateTaskCounter() {
            const completedTasks = [...appState.tasks, ...appState.randomTasks].filter(t => t.completed).length;
            document.getElementById('taskCounter').textContent = `${completedTasks}/20`;
        }

        function updateAdsCounter() {
            const watchedAds = appState.ads.filter(a => a.watched).length;
            document.getElementById('adsCounter').textContent = `${watchedAds}/20`;
        }

        // ==================== FEED MANAGEMENT ====================
        function updateFeed() {
            const feedContainer = document.getElementById('feedContainer');
            if (!feedContainer) return;
            
            feedContainer.innerHTML = '';
            
            if (appState.posts.length === 0) {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        No viral posts yet. Be the first to create one!
                    </div>
                `;
                return;
            }
            
            // Sort by timestamp (newest first)
            const sortedPosts = [...appState.posts].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            sortedPosts.forEach(post => {
                const postElement = createPostElement(post);
                feedContainer.appendChild(postElement);
            });
        }

        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = 'post-card';
            div.dataset.postId = post.id;
            
            // Increment views
            if (!post.views) post.views = 0;
            post.views++;
            
            const mediaHtml = post.media ? `
                <div class="post-media">
                    <img src="${post.media}" alt="Post image" onerror="this.style.display='none'">
                </div>
            ` : '';
            
            const actionText = getActionText(post.linkType);
            const platform = PLATFORMS.find(p => p.id === (post.platform || 'website'));
            
            div.innerHTML = `
                <div class="post-header" onclick="viewUserProfile('${post.userId}')">
                    <div class="avatar">
                        ${post.userAvatar || 'U'}
                    </div>
                    <div class="post-meta">
                        <div class="poster-name">${post.username}</div>
                        <div class="post-time">${post.timestamp}  ${post.views || 0} views</div>
                    </div>
                    ${post.viral ? '<span style="font-size:10px; color: var(--vivid-magenta);"> VIRAL</span>' : ''}
                </div>
                <div class="post-content">${post.content}</div>
                ${mediaHtml}
                <div class="earnings-bar">
                    <span class="earnings-label">Earn up to ${post.reward.toLocaleString()} G-coins</span>
                    <span style="font-size: 11px; color: var(--text-secondary);">${actionText}</span>
                </div>
                <div class="post-actions">
                    <button class="action-btn ${post.userHasLiked ? 'liked' : ''}" onclick="handleLike('${post.id}', this)">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 14L2.5 8.5C1.5 7.5 1.5 5.8 2.5 4.8C3.5 3.8 5.2 3.8 6.2 4.8L8 6.6L9.8 4.8C10.8 3.8 12.5 3.8 13.5 4.8C14.5 5.8 14.5 7.5 13.5 8.5L8 14Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                  ${post.userHasLiked ? 'fill="currentColor"' : 'fill="none"'}/>
                        </svg>
                        <span>${post.likes || 0}</span>
                    </button>
                    <button class="action-btn" onclick="handleTaskAction('${post.id}', '${post.link}', '${post.linkType}', ${post.reward}, '${post.platform || 'website'}')">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2L8 8L14 2ZM14 2L9.5 14L8 8L2 6.5L14 2Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>${actionText}</span>
                    </button>
                    <button class="action-btn" onclick="toggleComments('${post.id}')">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 11C14 11.5 13.5 12 13 12H4L2 14V3C2 2.5 2.5 2 3 2H13C13.5 2 14 2.5 14 3V11Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>${post.comments ? post.comments.length : 0}</span>
                    </button>
                </div>
                <div class="comments-section" id="comments-${post.id}">
                    <div class="comments-container" id="comments-container-${post.id}">
                        ${post.comments ? post.comments.map(comment => `
                            <div class="comment-item">
                                <div class="comment-avatar">${comment.username.charAt(0)}</div>
                                <div class="comment-content">
                                    <div class="comment-author">${comment.username}</div>
                                    <div class="comment-text">${comment.text}</div>
                                </div>
                            </div>
                        `).join('') : ''}
                    </div>
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
                        <button class="send-comment-btn" onclick="sendComment('${post.id}')">Send</button>
                    </div>
                </div>
            `;
            
            return div;
        }

        // ==================== TASK ACTIONS ====================
        async function handleTaskAction(postId, link, type, reward, platform) {
            const post = appState.posts.find(p => p.id === postId);
            if (!post) return;
            
            // Find platform config
            const platformConfig = PLATFORMS.find(p => p.id === platform) || PLATFORMS[0];
            
            // Check if link should open in iframe
            const shouldUseIframe = platformConfig.iframe || type === 'visit' || type === 'watch' || type === 'signup';
            
            if (shouldUseIframe) {
                // Open in iframe with timer
                openBrowserModal();
                document.getElementById('browserUrl').textContent = link;
                document.getElementById('browserIframe').src = link;
                
                const duration = type === 'watch' ? 90 : 60;
                startTimer(duration, 'post_task', {
                    id: postId,
                    platform: platform,
                    reward: reward,
                    link: link,
                    linkType: type
                });
            } else {
                // Open directly (for Telegram, WhatsApp, Discord, etc.)
                if (appState.WebApp) {
                    appState.WebApp.openTelegramLink(link);
                } else {
                    window.open(link, '_blank');
                }
                
                // Start timer for direct links
                const duration = 45; // Default duration for direct links
                startDirectTimer(duration, 'post_task', {
                    id: postId,
                    platform: platform,
                    reward: reward,
                    link: link,
                    linkType: type
                });
            }
            
            // Send to bot
            await sendToBot('task_started', {
                postId: postId,
                link: link,
                type: type,
                reward: reward,
                platform: platform
            });
        }

        function startDirectTimer(seconds, type, data) {
            showToast(`Task started! Please complete within ${seconds} seconds.`, 'info');
            
            setTimeout(() => {
                completePostTask(data);
            }, seconds * 1000);
        }

        async function completePostTask(data) {
            try {
                // Send completion to bot
                const result = await sendToBot('task_completed', {
                    ...data,
                    userId: appState.telegramUserId,
                    timestamp: Date.now()
                });
                
                if (result.success && result.data) {
                    // Update balance from bot response
                    if (result.data.balance !== undefined) {
                        appState.balance = Number(result.data.balance);
                        updateBalanceDisplay();
                    }
                    
                    showToast(`Task completed! Reward sent to bot for processing.`, 'success');
                } else {
                    showToast('Task completed! Bot will update your balance.', 'info');
                }
                
            } catch (error) {
                console.error('Error completing post task:', error);
                showToast('Task completed locally!', 'success');
            }
        }

        // ==================== BROWSER MODAL ====================
        function openBrowserModal() {
            document.getElementById('browserModal').classList.add('active');
        }

        function closeBrowserModal() {
            document.getElementById('browserModal').classList.remove('active');
            document.getElementById('browserIframe').src = '';
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
            
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('timerProgressBar').style.width = '0%';
        }

        function startTimer(seconds, type, data) {
            let remaining = seconds;
            const display = document.getElementById('timerDisplay');
            const progressBar = document.getElementById('timerProgressBar');
            const timerLabel = document.getElementById('timerLabel');
            
            timerLabel.textContent = 'Please wait while we verify completion';
            
            document.getElementById('timerOverlay').style.display = 'flex';
            updateTimerDisplay();
            
            appState.timerInterval = setInterval(() => {
                remaining--;
                updateTimerDisplay();
                
                if (remaining <= 0) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                    
                    if (type === 'post_task') {
                        completePostTask(data);
                    }
                    closeBrowserModal();
                }
            }, 1000);
            
            function updateTimerDisplay() {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                const progress = ((seconds - remaining) / seconds) * 100;
                progressBar.style.width = `${progress}%`;
            }
        }

        // ==================== POST FUNCTIONS ====================
        function openComposer() {
            if (!['gold', 'premium', 'silver'].includes(appState.vipLevel)) {
                showToast('Only Silver, Gold, and Premium VIP can create posts', 'error');
                return;
            }
            
            if (appState.balance < 10000) {
                showToast('Minimum 10,000 G-Coins required to create a post', 'error');
                return;
            }
            
            document.getElementById('composerModal').classList.add('active');
        }

        function closeComposer() {
            document.getElementById('composerModal').classList.remove('active');
            document.getElementById('postForm').reset();
            document.getElementById('mediaPreview').innerHTML = '';
        }

        async function submitPost(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('postSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Publishing...';
            submitBtn.disabled = true;
            
            try {
                const content = document.getElementById('postContent').value;
                const link = document.getElementById('postLink').value;
                const linkType = document.getElementById('postLinkType').value;
                const reward = parseInt(document.getElementById('postReward').value);
                
                if (reward < 10000) {
                    throw new Error('Minimum reward is 10,000 G-Coins');
                }
                
                if (reward > appState.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Deduct balance locally
                appState.balance -= reward;
                updateBalanceDisplay();
                
                // Create viral post
                const newPost = {
                    userId: appState.telegramUserId || 'user_' + Date.now(),
                    username: appState.user?.username || 'Anonymous',
                    userAvatar: getInitials(appState.user?.firstName, appState.user?.lastName) || 'U',
                    content: content,
                    link: link,
                    linkType: linkType,
                    reward: reward,
                    platform: getPlatformFromLink(link)
                };
                
                addViralPost(newPost);
                
                // Send to bot
                await sendToBot('post_created', {
                    ...newPost,
                    userId: appState.telegramUserId,
                    balance: appState.balance
                });
                
                closeComposer();
                showToast('Post published virally!', 'success');
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getActionText(type) {
            const actions = {
                visit: 'Visit Website',
                join: 'Join Channel',
                watch: 'Watch Video',
                install: 'Install App',
                signup: 'Sign Up'
            };
            return actions[type] || 'Open Link';
        }

        function getPlatformFromLink(link) {
            if (link.includes('youtube.com') || link.includes('youtu.be')) return 'youtube';
            if (link.includes('t.me') || link.includes('telegram.me')) return 'telegram';
            if (link.includes('instagram.com')) return 'instagram';
            if (link.includes('twitter.com') || link.includes('x.com')) return 'twitter';
            if (link.includes('tiktok.com')) return 'tiktok';
            if (link.includes('facebook.com')) return 'facebook';
            if (link.includes('whatsapp.com')) return 'whatsapp';
            if (link.includes('discord.com') || link.includes('discord.gg')) return 'discord';
            return 'website';
        }

        function getRandomAdTitle() {
            const titles = [
                'Tech Review 2024',
                'Crypto Market Update',
                'Gaming News Today',
                'Product Launch Event',
                'Mobile App Review'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function getRandomAdSource() {
            const sources = [
                'TechBrand Co.',
                'CryptoExchange',
                'GameStore',
                'Fashion Brand',
                'Finance Corp'
            ];
            return sources[Math.floor(Math.random() * sources.length)];
        }

        function getRandomTaskTitle() {
            const titles = [
                'Website Visit Task',
                'Survey Completion',
                'App Installation',
                'Product Review',
                'Market Research'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function getRandomTaskDescription() {
            const descriptions = [
                'Visit website and stay for specified time',
                'Complete short survey for research',
                'Install app and open for verification',
                'Review product features',
                'Participate in market research'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        function getInitials(firstName, lastName) {
            return ((firstName?.[0] || '') + (lastName?.[0] || '')).toUpperCase() || 'U';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${icons[type] || ''}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            try {
                // Load persisted data
                loadAppState();
                loadViralPosts();
                loadTasks();
                loadAds();
                
                // Initialize Telegram Web App
                if (window.Telegram && window.Telegram.WebApp) {
                    appState.WebApp = window.Telegram.WebApp;
                    appState.isTelegramWebApp = true;
                    appState.WebApp.ready();
                    appState.WebApp.expand();
                    
                    const telegramUser = appState.WebApp.initDataUnsafe.user;
                    if (telegramUser) {
                        appState.user = {
                            id: telegramUser.id,
                            firstName: telegramUser.first_name,
                            lastName: telegramUser.last_name || '',
                            username: telegramUser.username,
                            photoUrl: telegramUser.photo_url
                        };
                        appState.telegramUserId = telegramUser.id;
                        updateUserProfile();
                    }
                }
                
                // Extract and process payload
                const payload = extractPayloadFromURL();
                if (payload) {
                    await processBotPayload(payload);
                }
                
                // Setup event listeners
                setupEventListeners();
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    showToast('GainGrid loaded successfully!', 'success');
                }, 1000);
                
                // Auto-save every 30 seconds
                setInterval(() => {
                    saveAppState();
                    saveViralPosts();
                    saveTasks();
                    saveAds();
                }, 30000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize app', 'error');
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);
            }
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Media upload
            const mediaDropArea = document.getElementById('mediaDropArea');
            const mediaInput = document.getElementById('mediaInput');
            
            if (mediaDropArea && mediaInput) {
                mediaDropArea.addEventListener('click', () => mediaInput.click());
                mediaInput.addEventListener('change', handleMediaUpload);
            }
            
            // Profile buttons
            document.getElementById('editProfileBtn')?.addEventListener('click', () => showProfileSection('edit'));
            document.getElementById('transactionHistoryBtn')?.addEventListener('click', () => showProfileSection('transactions'));
            document.getElementById('referralsBtn')?.addEventListener('click', () => showProfileSection('referrals'));
            document.getElementById('settingsBtn')?.addEventListener('click', () => showProfileSection('settings'));
            document.getElementById('helpSupportBtn')?.addEventListener('click', openHelpSupport);
            document.getElementById('cleanupBtn')?.addEventListener('click', cleanupWatched);
            document.getElementById('newTaskBtn')?.addEventListener('click', () => showToast('Task creation feature coming soon!', 'info'));
            
            // Prevent refresh loss
            window.addEventListener('beforeunload', (e) => {
                saveAppState();
                saveViralPosts();
                saveTasks();
                saveAds();
            });
            
            // Hash change for navigation
            window.addEventListener('hashchange', handleHashChange);
        }

        function handleMediaUpload(e) {
            const files = e.target.files;
            const preview = document.getElementById('mediaPreview');
            preview.innerHTML = '';
            
            Array.from(files).slice(0, 4).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-preview" onclick="this.parentElement.remove()"></button>
                    `;
                    preview.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }

        // ==================== INTERACTION FUNCTIONS ====================
        async function handleLike(postId, button) {
            const post = appState.posts.find(p => p.id === postId);
            if (!post) return;
            
            post.userHasLiked = !post.userHasLiked;
            post.likes += post.userHasLiked ? 1 : -1;
            
            button.classList.toggle('liked');
            button.querySelector('span').textContent = post.likes;
            
            saveViralPosts();
            
            // Send to bot
            await sendToBot('post_liked', {
                postId: postId,
                liked: post.userHasLiked,
                likes: post.likes
            });
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('active');
            }
        }

        async function sendComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            const post = appState.posts.find(p => p.id === postId);
            if (!post) return;
            
            if (!post.comments) post.comments = [];
            
            post.comments.push({
                id: `comment_${Date.now()}`,
                userId: appState.telegramUserId || 'anonymous',
                username: appState.user?.username || 'Anonymous',
                text: text
            });
            
            const commentsContainer = document.getElementById(`comments-container-${postId}`);
            if (commentsContainer) {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.innerHTML = `
                    <div class="comment-avatar">${appState.user?.firstName?.[0] || 'A'}</div>
                    <div class="comment-content">
                        <div class="comment-author">${appState.user?.username || 'Anonymous'}</div>
                        <div class="comment-text">${text}</div>
                    </div>
                `;
                commentsContainer.appendChild(commentDiv);
            }
            
            input.value = '';
            saveViralPosts();
            
            // Send to bot
            await sendToBot('comment_added', {
                postId: postId,
                comment: text,
                commentCount: post.comments.length
            });
        }

        function cleanupWatched() {
            appState.ads = appState.ads.filter(ad => !ad.watched);
            appState.tasks = appState.tasks.filter(task => !task.completed);
            appState.randomTasks = appState.randomTasks.filter(task => !task.completed);
            
            saveAds();
            saveTasks();
            updateAds();
            updateTasks();
            showToast('Cleaned up completed items', 'success');
        }

        // ==================== PROFILE FUNCTIONS ====================
        function showProfileSection(section) {
            const modal = document.getElementById('profileSectionModal');
            const title = document.getElementById('profileSectionTitle');
            const content = document.getElementById('profileSectionContent');
            
            if (!modal || !title || !content) return;
            
            let sectionContent = '';
            
            switch (section) {
                case 'edit':
                    title.textContent = 'Edit Profile';
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-input" value="${appState.telegramUserId || 'Not set'}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">VIP Level</label>
                            <div class="vip-badge ${appState.vipLevel}" style="margin-top: 8px; display: inline-block;">
                                ${appState.vipLevel.charAt(0).toUpperCase() + appState.vipLevel.slice(1)} VIP
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Balance (From Bot)</label>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10" cy="10" r="9" fill="#FFC857" />
                                    <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="10" font-weight="700">G</text>
                                </svg>
                                <span style="font-weight: 600; color: var(--gcoin-gold);">${appState.balance.toLocaleString()} G-Coins</span>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'transactions':
                    title.textContent = 'Transaction History';
                    sectionContent = `
                        <div style="max-height: 400px; overflow-y: auto;">
                            <div class="transaction-item">
                                <div class="transaction-icon earn">+</div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Post Creation Reward</div>
                                    <div class="transaction-time">Just now</div>
                                </div>
                                <div class="transaction-amount earn">+5,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon earn">+</div>
                                <div class="transaction-details">
                                    <div class="transaction-title">YouTube Task Completed</div>
                                    <div class="transaction-time">2 hours ago</div>
                                </div>
                                <div class="transaction-amount earn">+3,500</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'referrals':
                    title.textContent = 'Referrals';
                    const refLink = `https://t.me/GainGridBot?start=ref_${appState.telegramUserId || 'new'}`;
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">Your Referral Link</label>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" class="form-input" value="${refLink}" id="refLinkInput" readonly>
                                <button class="submit-btn" style="flex: 0 0 auto; padding: 0 16px;" 
                                        onclick="copyRefLink()">
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="profile-stats" style="margin-top: 24px;">
                            <div class="stat-item">
                                <div class="stat-value">${appState.referrals.completed}</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${appState.referrals.pending}</div>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${appState.referrals.totalEarned.toLocaleString()}</div>
                                <div class="stat-label">Total Earned</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'settings':
                    title.textContent = 'Settings';
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">App Version</label>
                            <input type="text" class="form-input" value="2.0.0" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session ID</label>
                            <input type="text" class="form-input" value="${appState.sessionId}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Posts in Feed</label>
                            <input type="text" class="form-input" value="${appState.posts.length}" readonly>
                        </div>
                    `;
                    break;
            }
            
            content.innerHTML = sectionContent;
            modal.classList.add('active');
        }

        function closeProfileSection() {
            document.getElementById('profileSectionModal').classList.remove('active');
        }

        function openHelpSupport() {
            if (appState.WebApp) {
                appState.WebApp.openTelegramLink('https://t.me/GainGridSupport');
            } else {
                window.open('https://t.me/GainGridSupport', '_blank');
            }
        }

        function copyRefLink() {
            const input = document.getElementById('refLinkInput');
            if (input) {
                input.select();
                document.execCommand('copy');
                showToast('Referral link copied!', 'success');
            }
        }

        // ==================== NAVIGATION ====================
        function switchScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            const screen = document.getElementById(`${screenName}Screen`);
            if (screen) screen.classList.add('active');
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.includes(screenName.charAt(0).toUpperCase() + screenName.slice(1))) {
                    item.classList.add('active');
                }
            });
            
            window.location.hash = screenName;
        }

        function handleHashChange() {
            const hash = window.location.hash.replace('#', '');
            if (hash && hash !== 'iframe') {
                switchScreen(hash);
            }
        }

        function viewUserProfile(userId) {
            switchScreen('profile');
        }

        // ==================== MONETAG ADS ====================
        function initializeMonetagAds() {
            if (typeof monetag !== 'undefined') {
                try {
                    monetag('start');
                } catch (error) {
                    console.log('Monetag initialization error:', error);
                }
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        window.switchScreen = switchScreen;
        window.openComposer = openComposer;
        window.closeComposer = closeComposer;
        window.handleLike = handleLike;
        window.handleTaskAction = handleTaskAction;
        window.toggleComments = toggleComments;
        window.sendComment = sendComment;
        window.watchAd = async function(adId) {
            const ad = appState.ads.find(a => a.id === adId);
            if (!ad || ad.watched) return;
            
            openBrowserModal();
            document.getElementById('browserUrl').textContent = ad.link;
            document.getElementById('browserIframe').src = ad.link;
            
            startTimer(ad.duration, 'ad', {
                id: adId,
                reward: ad.reward
            });
            
            ad.watched = true;
            saveAds();
            updateAds();
            
            // Send to bot
            await sendToBot('ad_watched', {
                adId: adId,
                reward: ad.reward,
                duration: ad.duration
            });
        };
        window.cleanupWatched = cleanupWatched;
        window.startTask = async function(taskId) {
            const allTasks = [...appState.tasks, ...appState.randomTasks];
            const task = allTasks.find(t => t.id === taskId);
            if (!task || task.completed) return;
            
            openBrowserModal();
            document.getElementById('browserUrl').textContent = task.link;
            document.getElementById('browserIframe').src = task.link;
            
            startTimer(task.duration, 'task', {
                id: taskId,
                reward: task.reward
            });
            
            task.completed = true;
            saveTasks();
            updateTasks();
            
            // Send to bot
            await sendToBot('task_completed', {
                taskId: taskId,
                reward: task.reward,
                duration: task.duration
            });
        };
        window.viewTaskDetails = function(taskId) {
            showToast('Task details coming soon!', 'info');
        };
        window.viewUserProfile = viewUserProfile;
        window.copyRefLink = copyRefLink;
        window.closeBrowserModal = closeBrowserModal;
        window.closeProfileSection = closeProfileSection;
        window.showToast = showToast;
        window.submitPost = submitPost;

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>