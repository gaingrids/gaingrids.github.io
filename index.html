<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GainGrid Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --deep-purple: #5B2E8A;
            --vivid-magenta: #E33D7A;
            --soft-pink: #FF98BD;
            --electric-blue: #4AA3FF;
            --bg-dark: #0F0F14;
            --bg-panel: #0B0B0D;
            --text-secondary: #9AA0A6;
            --gcoin-gold: #FFC857;
            --white: #FFFFFF;
            --spacing-base: 8px;
            --radius-xs: 6px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--white);
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .app-header {
            width: 100%;
            background: var(--bg-panel);
            padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .app-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .balance-chip {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(227, 61, 122, 0.3));
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 200, 87, 0.3);
        }

        .coin-icon {
            width: 20px;
            height: 20px;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .balance-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--gcoin-gold);
        }

        .main-content {
            flex: 1;
            width: 100%;
            padding: calc(var(--spacing-base) * 3) calc(var(--spacing-base) * 2);
            padding-bottom: calc(var(--spacing-base) * 15);
            overflow-y: auto;
            position: relative;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feed-container {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .post-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
            transition: all 0.3s ease;
        }

        .post-card:hover {
            border-color: rgba(91, 46, 138, 0.4);
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1.5);
            margin-bottom: calc(var(--spacing-base) * 2);
            cursor: pointer;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--deep-purple), var(--electric-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-meta {
            flex: 1;
        }

        .poster-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--white);
            margin-bottom: 2px;
        }

        .post-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--white);
            margin-bottom: calc(var(--spacing-base) * 2);
            word-break: break-word;
        }

        .post-media {
            width: 100%;
            border-radius: var(--radius-sm);
            margin-bottom: calc(var(--spacing-base) * 2);
            overflow: hidden;
            max-height: 400px;
        }

        .post-media img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--radius-sm);
        }

        .post-media video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--radius-sm);
        }

        .earnings-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 200, 87, 0.1);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            border-radius: var(--radius-xs);
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .earnings-label {
            font-size: 12px;
            color: var(--gcoin-gold);
            font-weight: 600;
        }

        .post-actions {
            display: flex;
            gap: calc(var(--spacing-base) * 2);
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .action-btn.liked {
            background: rgba(227, 61, 122, 0.2);
            color: var(--vivid-magenta);
        }

        .action-icon {
            width: 16px;
            height: 16px;
        }

        .comments-section {
            margin-top: calc(var(--spacing-base) * 2);
            padding-top: calc(var(--spacing-base) * 2);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: none;
        }

        .comments-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .comments-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: calc(var(--spacing-base) * 1.5);
        }

        .comment-item {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1);
            margin-bottom: calc(var(--spacing-base) * 1);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-sm);
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--deep-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .comment-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-input-container {
            display: flex;
            gap: calc(var(--spacing-base) * 1);
        }

        .comment-input {
            flex: 1;
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }

        .send-comment-btn {
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: var(--electric-blue);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .task-board-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 2);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .task-counter {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            font-size: 14px;
        }

        .counter-label {
            color: var(--text-secondary);
        }

        .counter-value {
            font-weight: 700;
            color: var(--electric-blue);
        }

        .new-task-btn {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .new-task-btn:hover {
            transform: scale(1.05);
        }

        .platform-grid-container {
            position: relative;
            margin-bottom: calc(var(--spacing-base) * 3);
        }

        .platform-grid {
            display: flex;
            gap: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 1);
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .platform-grid::-webkit-scrollbar {
            display: none;
        }

        .platform-card {
            min-width: 100px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .platform-card:hover {
            transform: translateY(-4px);
            border-color: var(--electric-blue);
            box-shadow: 0 8px 32px rgba(74, 163, 255, 0.2);
        }

        .platform-card.active {
            border-color: var(--vivid-magenta);
            background: rgba(227, 61, 122, 0.1);
        }

        .platform-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto calc(var(--spacing-base) * 1);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            padding: calc(var(--spacing-base) * 1);
        }

        .platform-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }

        .platform-card:hover .platform-icon svg {
            transform: scale(1.1) rotate(5deg);
        }

        .platform-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--white);
            margin-bottom: calc(var(--spacing-base) * 0.5);
        }

        .platform-count {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .task-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
            position: relative;
        }

        .task-card.completed {
            opacity: 0.7;
            border-color: rgba(46, 204, 113, 0.3);
        }

        .task-card.completed::before {
            content: 'COMPLETED';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            padding: 4px 8px;
            border-radius: var(--radius-xs);
            font-size: 10px;
            font-weight: 600;
        }

        .task-header {
            display: flex;
            align-items: start;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-base) * 1);
            color: var(--white);
        }

        .task-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: calc(var(--spacing-base) * 1);
        }

        .task-reward {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 200, 87, 0.15);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 700;
            color: var(--gcoin-gold);
        }

        .task-footer {
            display: flex;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .task-btn {
            flex: 1;
            padding: calc(var(--spacing-base) * 1.5);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .task-btn.primary {
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            color: var(--white);
        }

        .task-btn.primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(91, 46, 138, 0.4);
        }

        .task-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--white);
        }

        .task-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .watch-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 2);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .daily-limit {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cleanup-btn {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.75);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            background: rgba(227, 61, 122, 0.15);
            border: 1px solid rgba(227, 61, 122, 0.3);
            border-radius: var(--radius-sm);
            color: var(--vivid-magenta);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .cleanup-btn:hover {
            background: rgba(227, 61, 122, 0.25);
            transform: scale(1.05);
        }

        .watch-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: calc(var(--spacing-base) * 2);
        }

        .video-card {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .video-card:hover {
            transform: translateY(-4px);
            border-color: rgba(74, 163, 255, 0.4);
        }

        .video-card.watched {
            opacity: 0.6;
            pointer-events: none;
        }

        .video-thumbnail {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(74, 163, 255, 0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .play-icon {
            width: 48px;
            height: 48px;
            opacity: 0.9;
        }

        .video-duration {
            position: absolute;
            bottom: calc(var(--spacing-base) * 1);
            right: calc(var(--spacing-base) * 1);
            background: rgba(0, 0, 0, 0.8);
            padding: calc(var(--spacing-base) * 0.5) calc(var(--spacing-base) * 1);
            border-radius: var(--radius-xs);
            font-size: 12px;
            font-weight: 600;
        }

        .video-info {
            padding: calc(var(--spacing-base) * 2);
        }

        .video-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-base) * 1);
            line-height: 1.3;
        }

        .video-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .video-reward {
            color: var(--gcoin-gold);
            font-weight: 600;
        }

        .collected-badge {
            color: var(--electric-blue);
            font-weight: 600;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 3);
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 2);
            padding: calc(var(--spacing-base) * 3);
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            border: 3px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .profile-username {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: calc(var(--spacing-base) * 2);
            width: 100%;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--electric-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.06);
            overflow: hidden;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 2.5);
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: var(--bg-panel);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-around;
            padding: calc(var(--spacing-base) * 1.5) 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5);
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
            text-decoration: none;
        }

        .nav-item:hover {
            color: var(--white);
        }

        .nav-item.active {
            color: var(--electric-blue);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.12s ease;
        }

        .fab {
            position: fixed;
            bottom: calc(var(--spacing-base) * 12);
            right: calc(var(--spacing-base) * 2);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--vivid-magenta), var(--soft-pink));
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(227, 61, 122, 0.4);
            transition: all 0.3s ease;
            z-index: 99;
            opacity: 1;
            transform: translateY(0);
        }

        .fab.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(227, 61, 122, 0.6);
        }

        .fab-icon {
            width: 24px;
            height: 24px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(var(--spacing-base) * 2);
        }

        .modal-content {
            width: 100%;
            max-width: 500px;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-base) * 3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .close-icon {
            width: 16px;
            height: 16px;
        }

        .composer-form {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 2);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 1);
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.12s ease;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--electric-blue);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .media-attach-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 3);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .media-attach-area:hover {
            border-color: var(--electric-blue);
            background: rgba(74, 163, 255, 0.05);
        }

        .media-attach-area.drag-over {
            border-color: var(--vivid-magenta);
            background: rgba(227, 61, 122, 0.05);
        }

        .attach-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto calc(var(--spacing-base) * 2);
            color: var(--text-secondary);
        }

        .media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: calc(var(--spacing-base) * 1);
            margin-top: calc(var(--spacing-base) * 2);
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submit-btn {
            padding: calc(var(--spacing-base) * 2);
            background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .submit-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(91, 46, 138, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .browser-frame {
            width: 100%;
            height: 80vh;
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .browser-header {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            padding: calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .browser-dots {
            display: flex;
            gap: calc(var(--spacing-base) * 0.75);
        }

        .browser-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .browser-url {
            flex: 1;
            padding: calc(var(--spacing-base) * 0.75) calc(var(--spacing-base) * 1.5);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xs);
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .browser-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .browser-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .timer-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11, 11, 13, 0.95);
            padding: calc(var(--spacing-base) * 2);
            z-index: 10;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .timer-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--electric-blue);
            text-align: center;
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .timer-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--deep-purple), var(--vivid-magenta));
            width: 0%;
            transition: width 1s linear;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--electric-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: calc(var(--spacing-base) * 2);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2);
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid var(--electric-blue);
        }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-base) * 1.5);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .vip-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: var(--radius-xs);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .vip-badge.none {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .vip-badge.basic {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .vip-badge.silver {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .vip-badge.gold {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .vip-badge.premium {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 430px;
                margin: 0 auto;
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.3);
            }

            .watch-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @keyframes scrollPlatforms {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .platform-grid.auto-scroll {
            animation: scrollPlatforms 30s linear infinite;
        }

        .platform-grid-container:hover .platform-grid.auto-scroll {
            animation-play-state: paused;
        }

        .platform-card.youtube { border-color: rgba(255, 0, 0, 0.3); }
        .platform-card.youtube:hover { border-color: #FF0000; }
        
        .platform-card.telegram { border-color: rgba(0, 136, 204, 0.3); }
        .platform-card.telegram:hover { border-color: #0088cc; }
        
        .platform-card.instagram { border-color: rgba(225, 48, 108, 0.3); }
        .platform-card.instagram:hover { border-color: #E1306C; }
        
        .platform-card.twitter { border-color: rgba(29, 161, 242, 0.3); }
        .platform-card.twitter:hover { border-color: #1DA1F2; }
        
        .platform-card.tiktok { border-color: rgba(0, 0, 0, 0.3); }
        .platform-card.tiktok:hover { border-color: #000000; }
        
        .platform-card.whatsapp { border-color: rgba(37, 211, 102, 0.3); }
        .platform-card.whatsapp:hover { border-color: #25D366; }
        
        .platform-card.discord { border-color: rgba(88, 101, 242, 0.3); }
        .platform-card.discord:hover { border-color: #5865F2; }
        
        .platform-card.facebook { border-color: rgba(24, 119, 242, 0.3); }
        .platform-card.facebook:hover { border-color: #1877F2; }
        
        .platform-card.website { border-color: rgba(74, 163, 255, 0.3); }
        .platform-card.website:hover { border-color: #4AA3FF; }
        
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .transaction-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .transaction-icon.earn {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .transaction-icon.spend {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .transaction-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }
        
        .transaction-amount.earn {
            color: #2ecc71;
        }
        
        .transaction-amount.spend {
            color: #e74c3c;
        }
    </style>
    <script src='//libtl.com/sdk.js' data-zone='10274566' data-sdk='show_10274566'></script>
    
    <!-- Monetag Ad SDK -->
    <script>
        (function(m,o,n,e,t,a,g){
            m['MonetagObject']=t;m[t]=m[t]||function(){
                (m[t].q=m[t].q||[]).push(arguments)
            };
            a=o.createElement(n);g=o.getElementsByTagName(n)[0];
            a.async=1;a.src=e;g.parentNode.insertBefore(a,g)
        })(window,document,'script','https://cdn.monetag.com/tag.min.js','monetag');
        monetag('start');
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading GainGrid...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-section">
                <div class="logo-icon">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="url(#logo-gradient)" />
                        <path d="M10 16L14 20L22 12" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        <defs>
                            <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#5B2E8A" />
                                <stop offset="1" stop-color="#E33D7A" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h1 class="app-title" id="appTitle">GainGrid</h1>
            </div>
            <div class="balance-chip">
                <div class="coin-icon">
                    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="9" fill="#FFC857" stroke="#FFD87A" stroke-width="1" />
                        <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="12" font-weight="700">G</text>
                    </svg>
                </div>
                <span class="balance-text" id="balanceText">0</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- GridHome Screen -->
            <section class="screen active" id="gridhomeScreen">
                <div class="feed-container" id="feedContainer">
                    <!-- Posts loaded dynamically -->
                </div>
            </section>

            <!-- Task Board Screen -->
            <section class="screen" id="tasksScreen">
                <div class="task-board-header">
                    <div class="task-counter">
                        <span class="counter-label">Tasks today:</span>
                        <span class="counter-value" id="taskCounter">0/20</span>
                    </div>
                    <button class="new-task-btn" id="newTaskBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>New Task</span>
                    </button>
                </div>

                <!-- Platform Grid -->
                <div class="platform-grid-container">
                    <div class="platform-grid auto-scroll" id="platformGrid">
                        <!-- Platforms loaded dynamically -->
                    </div>
                </div>

                <!-- Task List -->
                <div class="task-list" id="taskList">
                    <!-- Tasks loaded dynamically -->
                </div>
            </section>

            <!-- Watch & Earn Screen -->
            <section class="screen" id="watchScreen">
                <div class="watch-header">
                    <div class="daily-limit">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" />
                            <path d="M10 5V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>Daily Ads: <strong id="adsCounter">0/20</strong></span>
                    </div>
                    <button class="cleanup-btn" id="cleanupBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 4H14M6 7V11M10 7V11M3 4L4 13C4 13.5 4.5 14 5 14H11C11.5 14 12 13.5 12 13L13 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        </svg>
                        <span>Clean Up</span>
                    </button>
                </div>

                <div class="watch-grid" id="watchGrid">
                    <!-- Ads loaded dynamically -->
                </div>
            </section>

            <!-- Profile Screen -->
            <section class="screen" id="profileScreen">
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            <!-- Avatar loaded dynamically -->
                        </div>
                        <h2 class="profile-name" id="profileName">Loading...</h2>
                        <p class="profile-username" id="profileUsername">@username</p>
                        <div class="vip-badge gold" id="vipBadge">VIP Level</div>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="statGcoins">0</div>
                            <div class="stat-label">G-Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statTotalEarned">0</div>
                            <div class="stat-label">Total Earned</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statTasksDone">0</div>
                            <div class="stat-label">Tasks Done</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statReferrals">0</div>
                            <div class="stat-label">Referrals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statPendingRefs">0</div>
                            <div class="stat-label">Pending Refs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statRefEarned">0</div>
                            <div class="stat-label">Ref Earned</div>
                        </div>
                    </div>

                    <div class="profile-menu">
                        <button class="menu-item" id="editProfileBtn">
                            <span>Edit Profile</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="transactionHistoryBtn">
                            <span>Transaction History</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="referralsBtn">
                            <span>Referrals</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="settingsBtn">
                            <span>Settings</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button class="menu-item" id="helpSupportBtn">
                            <span>Help & Support</span>
                            <svg class="menu-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchScreen('gridhome')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>GridHome</span>
            </button>
            <button class="nav-item" onclick="switchScreen('tasks')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Tasks</span>
            </button>
            <button class="nav-item" onclick="switchScreen('watch')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Watch</span>
            </button>
            <button class="nav-item" onclick="switchScreen('profile')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Profile</span>
            </button>
        </nav>

        <!-- Floating Action Button (Post) -->
        <button class="fab" id="fabPost" onclick="openComposer()">
            <svg class="fab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 20H21" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M16.5 3.49998C16.8978 3.10216 17.4374 2.87866 18 2.87866C18.2786 2.87866 18.5544 2.93353 18.8118 3.04014C19.0692 3.14674 19.303 3.303 19.5 3.49998C19.697 3.69697 19.8532 3.93082 19.9598 4.18819C20.0665 4.44556 20.1213 4.72141 20.1213 4.99998C20.1213 5.27856 20.0665 5.55441 19.9598 5.81178C19.8532 6.06915 19.697 6.303 19.5 6.49998L7 19L3 20L4 16L16.5 3.49998Z" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

        <!-- Modals -->
        <!-- Composer Modal -->
        <div class="modal-overlay" id="composerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Post</h2>
                    <button class="close-btn" onclick="closeComposer()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <form class="composer-form" id="postForm" onsubmit="submitPost(event)">
                    <div class="form-group">
                        <label class="form-label" for="postContent">Post Content</label>
                        <textarea class="form-textarea" id="postContent" placeholder="What do you want to share? Use # for hashtags and @ for mentions" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postLink">Link URL</label>
                        <input type="url" class="form-input" id="postLink" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postLinkType">Link Type</label>
                        <select class="form-input" id="postLinkType" required>
                            <option value="visit">Visit Website</option>
                            <option value="join">Join Group/Channel</option>
                            <option value="watch">Watch Video</option>
                            <option value="install">Install App</option>
                            <option value="signup">Sign Up</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="postReward">Reward Amount (G-Coins)</label>
                        <input type="number" class="form-input" id="postReward" placeholder="Enter reward amount" min="10000" max="100000" required>
                        <div class="reward-preview">
                            <div class="preview-label">Minimum: 10,000 G-Coins</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Media (Optional)</label>
                        <div class="media-attach-area" id="mediaDropArea">
                            <svg class="attach-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="2" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.5" />
                                <circle cx="7" cy="7" r="2" stroke="currentColor" stroke-width="1.5" />
                                <path d="M2 14L7 9L12 14M10 12L13 9L18 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                            </svg>
                            <div class="file-drop-text">Drag & drop photos/videos or click to upload</div>
                            <div class="file-drop-hint">Max size: 10MB</div>
                            <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;">
                        </div>
                        <div class="media-preview" id="mediaPreview"></div>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="postSubmitBtn">Publish Post</button>
                </form>
            </div>
        </div>

        <!-- Browser Modal -->
        <div class="modal-overlay" id="browserModal">
            <div class="browser-frame">
                <div class="browser-header">
                    <div class="browser-dots">
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                    </div>
                    <div class="browser-url" id="browserUrl">https://gaingrid.com</div>
                    <button class="close-btn" onclick="closeBrowserModal()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <div class="browser-content">
                    <iframe class="browser-iframe" id="browserIframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox" allow="autoplay; fullscreen"></iframe>
                    <div class="timer-overlay" id="timerOverlay">
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        <div class="timer-label" id="timerLabel">Please wait while we verify completion</div>
                        <div class="timer-progress">
                            <div class="timer-progress-bar" id="timerProgressBar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section Modal -->
        <div class="modal-overlay" id="profileSectionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="profileSectionTitle">Profile Section</h2>
                    <button class="close-btn" onclick="closeProfileSection()">
                        <svg class="close-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="profileSectionContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const appState = {
            user: null,
            balance: 0,
            vipLevel: 'none',
            referrals: 0,
            pendingReferrals: 0,
            totalRefEarned: 0,
            dailyCounters: {
                tasks: 0,
                ads: 0
            },
            posts: [],
            viralPosts: [],
            tasks: [],
            ads: [],
            randomTasks: [],
            platforms: [],
            currentTask: null,
            currentAd: null,
            currentPostId: null,
            timerInterval: null,
            isTelegramWebApp: false,
            WebApp: null,
            lastScrollPosition: 0,
            telegramUserId: null,
            botCallbackUrl: null,
            botPayload: null,
            sessionId: Date.now().toString(),
            lastDataSync: 0
        };

        // ==================== STORAGE MANAGEMENT ====================
        const STORAGE_KEYS = {
            VIRAL_POSTS: 'gainGrid_viral_posts',
            USER_DATA: 'gainGrid_user_data',
            APP_STATE: 'gainGrid_app_state',
            TASKS: 'gainGrid_tasks',
            ADS: 'gainGrid_ads',
            DAILY_COUNTERS: 'gainGrid_daily_counters'
        };

        // ==================== SMART LINKS ====================
        const SMART_LINKS = [
            'https://otieu.com/4/10176113',
            'https://otieu.com/4/10176184',
            'https://otieu.com/4/10176114',
            'https://otieu.com/4/10176185'
        ];

        // ==================== PLATFORMS ====================
        const PLATFORMS = [
            { id: 'youtube', name: 'YouTube', color: '#FF0000' },
            { id: 'telegram', name: 'Telegram', color: '#0088CC' },
            { id: 'instagram', name: 'Instagram', color: '#E1306C' },
            { id: 'twitter', name: 'Twitter', color: '#1DA1F2' },
            { id: 'tiktok', name: 'TikTok', color: '#000000' },
            { id: 'facebook', name: 'Facebook', color: '#1877F2' },
            { id: 'whatsapp', name: 'WhatsApp', color: '#25D366' },
            { id: 'discord', name: 'Discord', color: '#5865F2' },
            { id: 'website', name: 'Website', color: '#4AA3FF' }
        ];

// ==================== BASE64 DECODING - FIXED ====================
function decodeBase64Payload(base64String) {
    try {
        // Handle URL-safe Base64 and multiple encoding formats
        let cleanString = base64String.toString().trim();
        
        // Remove any URL encoding
        cleanString = decodeURIComponent(cleanString);
        
        // Handle URL-safe Base64 characters
        let base64 = cleanString.replace(/-/g, '+').replace(/_/g, '/');
        
        // Add padding if needed
        const padLength = (4 - (base64.length % 4)) % 4;
        base64 += '='.repeat(padLength);
        
        // Decode Base64
        const decoded = atob(base64);
        
        // Try to parse JSON - might be already JSON or stringified
        try {
            return JSON.parse(decoded);
        } catch (e) {
            // If not JSON, try to parse the string as JSON
            try {
                return JSON.parse(decoded);
            } catch (e2) {
                // Return as raw string if not JSON
                return { raw: decoded };
            }
        }
    } catch (error) {
        console.error('Base64 decode error:', error);
        
        // Fallback: Try direct Base64 decode without URL-safe replacement
        try {
            const decoded = atob(base64String);
            try {
                return JSON.parse(decoded);
            } catch (e) {
                return { error: 'Invalid JSON after decode', data: decoded };
            }
        } catch (e) {
            return null;
        }
    }
}

// ==================== URL PAYLOAD PARSING - FIXED ====================
function parseUrlPayload() {
    try {
        console.log('Parsing URL payload...');
        
        // Get full URL for debugging
        const currentUrl = window.location.href;
        console.log('Current URL:', currentUrl);
        
        // Method 1: Check URL search parameters
        const urlParams = new URLSearchParams(window.location.search);
        let startParam = urlParams.get('start');
        
        console.log('URL Search Params:', Object.fromEntries(urlParams.entries()));
        
        // Method 2: Check hash parameters
        if (!startParam && window.location.hash) {
            const hash = window.location.hash.substring(1);
            console.log('Hash found:', hash);
            
            // Try to extract start parameter from hash
            if (hash.includes('start=')) {
                const hashMatch = hash.match(/start=([^&]+)/);
                if (hashMatch && hashMatch[1]) {
                    startParam = hashMatch[1];
                }
            } else {
                // Hash might be the payload itself
                startParam = hash;
            }
        }
        
        // Method 3: Check for base64 in entire URL
        if (!startParam) {
            const base64Pattern = /([A-Za-z0-9+/=_-]{20,})/;
            const urlMatch = currentUrl.match(base64Pattern);
            if (urlMatch && urlMatch[1]) {
                startParam = urlMatch[1];
            }
        }
        
        if (startParam) {
            console.log('Found start parameter:', startParam.substring(0, 50) + '...');
            
            const payload = decodeBase64Payload(startParam);
            console.log('Decoded payload:', payload);
            
            if (payload && (payload.type === 'gaingrid_dashboard' || payload.user_id)) {
                console.log('Valid dashboard payload received');
                return payload;
            }
            
            // If no type but has user_id, still accept it
            if (payload && payload.user_id) {
                payload.type = 'gaingrid_dashboard'; // Add type for compatibility
                return payload;
            }
        }
        
        console.log('No valid payload found');
        return null;
    } catch (error) {
        console.error('URL payload parsing error:', error);
        return null;
    }
}

// ==================== BOT COMMUNICATION - FIXED ====================
async function sendToBot(action, data) {
    try {
        if (!appState.botCallbackUrl) {
            console.warn('No bot callback URL available');
            return { success: false, error: 'No callback URL' };
        }
        
        // Construct payload matching BBJS webhook structure
        const payload = {
            action: action,
            user_id: appState.telegramUserId || appState.user?.id,
            data: data,
            timestamp: new Date().toISOString(),
            session_id: appState.sessionId,
            source: 'gainGrid_dashboard_v2'
        };
        
        console.log('Sending to bot webhook:', {
            url: appState.botCallbackUrl,
            payload: payload
        });
        
        // Use fetch with proper headers for BBJS webhook
        const response = await fetch(appState.botCallbackUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(payload),
            // Note: Using 'cors' mode instead of 'no-cors' to see errors
            mode: 'cors',
            credentials: 'omit'
        });
        
        // Log response for debugging
        console.log('Bot response status:', response.status);
        
        if (response.ok) {
            try {
                const responseData = await response.text();
                console.log('Bot response data:', responseData);
                return { success: true, data: responseData };
            } catch (e) {
                return { success: true };
            }
        } else {
            const errorText = await response.text();
            console.error('Bot responded with error:', response.status, errorText);
            return { 
                success: false, 
                error: `HTTP ${response.status}: ${errorText.substring(0, 100)}` 
            };
        }
    } catch (error) {
        console.error('Bot communication error:', error);
        
        // Fallback: Try with different content type
        try {
            const formData = new FormData();
            formData.append('action', action);
            formData.append('user_id', appState.telegramUserId || '');
            formData.append('data', JSON.stringify(data));
            
            const fallbackResponse = await fetch(appState.botCallbackUrl, {
                method: 'POST',
                body: formData,
                mode: 'no-cors'
            });
            
            return { success: true, fallback: true };
        } catch (fallbackError) {
            return { 
                success: false, 
                error: error.message 
            };
        }
    }
}

// ==================== PAYLOAD HANDLING - FIXED ====================
function handleBotPayload(payload) {
    if (!payload) {
        console.log('No payload to handle');
        return;
    }
    
    console.log('Handling bot payload:', payload);
    
    // Store payload
    appState.botPayload = payload;
    
    // Set user data from payload - REQUIRED FIELDS
    appState.telegramUserId = payload.user_id || payload.userId || payload.telegramUserId;
    
    // IMPORTANT: Balance from bot ONLY - no defaults
    if (payload.gcoin !== undefined) {
        appState.balance = Number(payload.gcoin);
        console.log('Balance set from bot:', appState.balance);
    } else if (payload.balance !== undefined) {
        appState.balance = Number(payload.balance);
        console.log('Balance set from bot (balance field):', appState.balance);
    }
    
    // VIP Level mapping - wait for bot payload, no guessing
    if (payload.vip_level !== undefined) {
        const vipRaw = String(payload.vip_level).toLowerCase().trim();
        console.log('Raw VIP from bot:', vipRaw);
        
        // Map all possible VIP formats from bot
        if (vipRaw.includes('premium') || vipRaw.includes('plat') || vipRaw === 'premium') {
            appState.vipLevel = 'premium';
        } else if (vipRaw.includes('gold') || vipRaw === 'gold') {
            appState.vipLevel = 'gold';
        } else if (vipRaw.includes('silver') || vipRaw === 'silver') {
            appState.vipLevel = 'silver';
        } else if (vipRaw.includes('basic') || vipRaw === 'basic') {
            appState.vipLevel = 'basic';
        } else if (vipRaw.includes('none') || vipRaw === 'none' || vipRaw === ' no vip') {
            appState.vipLevel = 'none';
        } else {
            // Default to none if unrecognized
            appState.vipLevel = 'none';
        }
        console.log('Mapped VIP level:', appState.vipLevel);
    }
    
    // Referrals data - wait for bot payload
    appState.referrals = Number(payload.referrals || 0);
    appState.pendingReferrals = Number(payload.pending_referrals || payload.pendingReferrals || 0);
    appState.totalRefEarned = Number(payload.total_ref_earned || payload.totalRefEarned || 0);
    
    // Set callback URL for webhook communication
    appState.botCallbackUrl = payload.callback_url || payload.callbackUrl;
    console.log('Bot callback URL set:', appState.botCallbackUrl);
    
    // Handle viral posts from bot - merge with existing posts
    if (payload.viral_posts && Array.isArray(payload.viral_posts)) {
        console.log('Adding viral posts from bot:', payload.viral_posts.length);
        updateViralPosts(payload.viral_posts);
    }
    
    // Handle tasks from bot - replace or merge
    if (payload.tasks && Array.isArray(payload.tasks)) {
        console.log('Updating tasks from bot:', payload.tasks.length);
        updateTasksFromBot(payload.tasks);
    }
    
    // Handle ads from bot
    if (payload.ads && Array.isArray(payload.ads)) {
        console.log('Updating ads from bot:', payload.ads.length);
        updateAdsFromBot(payload.ads);
    }
    
    // Update UI with bot data
    updateUIFromPayload();
    
    // Send confirmation to bot's webhook
    setTimeout(() => {
        sendToBot('dashboard_loaded', { 
            status: 'ready',
            user_id: appState.telegramUserId,
            vip_level: appState.vipLevel,
            balance: appState.balance
        }).then(result => {
            console.log('Dashboard loaded confirmation sent:', result.success);
        });
    }, 1000);
}

        // ==================== VIRAL POSTS MANAGEMENT ====================
        function updateViralPosts(newPosts) {
            // Load existing viral posts
            const existingPosts = JSON.parse(localStorage.getItem(STORAGE_KEYS.VIRAL_POSTS) || '[]');
            
            // Merge with new posts, avoiding duplicates
            const allPostsMap = new Map();
            
            // Add existing posts
            existingPosts.forEach(post => {
                allPostsMap.set(post.id, post);
            });
            
            // Add/update new posts from bot
            newPosts.forEach(post => {
                allPostsMap.set(post.id, {
                    ...post,
                    timestamp: post.timestamp || new Date().toISOString(),
                    likes: post.likes || 0,
                    comments: post.comments || [],
                    shares: post.shares || 0,
                    views: post.views || 0
                });
            });
            
            // Convert back to array and sort by timestamp
            const allPosts = Array.from(allPostsMap.values())
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Save to storage
            localStorage.setItem(STORAGE_KEYS.VIRAL_POSTS, JSON.stringify(allPosts));
            
            // Update app state
            appState.viralPosts = allPosts;
            
            return allPosts;
        }

        function addViralPost(post) {
            const viralPosts = JSON.parse(localStorage.getItem(STORAGE_KEYS.VIRAL_POSTS) || '[]');
            
            const newPost = {
                ...post,
                id: `viral_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                timestamp: new Date().toISOString(),
                likes: 0,
                comments: [],
                shares: 0,
                views: 0,
                viral: true
            };
            
            viralPosts.unshift(newPost);
            localStorage.setItem(STORAGE_KEYS.VIRAL_POSTS, JSON.stringify(viralPosts));
            
            // Send to bot for distribution
            sendToBot('new_viral_post', newPost);
            
            return newPost;
        }

        // ==================== TASKS MANAGEMENT ====================
        function updateTasksFromBot(botTasks) {
            const existingTasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.TASKS) || '[]');
            
            // Merge tasks
            const tasksMap = new Map();
            existingTasks.forEach(task => tasksMap.set(task.id, task));
            botTasks.forEach(task => tasksMap.set(task.id, task));
            
            const allTasks = Array.from(tasksMap.values());
            localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(allTasks));
            
            appState.tasks = allTasks;
            generateRandomTasks();
            
            return allTasks;
        }

        function generateRandomTasks() {
            const randomTasks = [];
            const taskCount = Math.min(10, 20 - appState.tasks.length);
            
            for (let i = 0; i < taskCount; i++) {
                randomTasks.push({
                    id: `random_${Date.now()}_${i}`,
                    platform: 'website',
                    title: getRandomTaskTitle(),
                    description: getRandomTaskDescription(),
                    duration: Math.floor(Math.random() * 120) + 60,
                    reward: Math.floor(Math.random() * 201) + 100,
                    link: getRandomSmartLink(),
                    completed: false,
                    isRandom: true,
                    created_at: new Date().toISOString()
                });
            }
            
            appState.randomTasks = randomTasks;
            return randomTasks;
        }

        // ==================== ADS MANAGEMENT ====================
        function updateAdsFromBot(botAds) {
            const existingAds = JSON.parse(localStorage.getItem(STORAGE_KEYS.ADS) || '[]');
            
            // Reset daily counters at midnight
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem('last_daily_reset');
            if (lastReset !== today) {
                resetDailyCounters();
            }
            
            // Merge ads
            const adsMap = new Map();
            existingAds.forEach(ad => adsMap.set(ad.id, ad));
            botAds.forEach(ad => adsMap.set(ad.id, ad));
            
            const allAds = Array.from(adsMap.values());
            localStorage.setItem(STORAGE_KEYS.ADS, JSON.stringify(allAds));
            
            appState.ads = allAds;
            return allAds;
        }

        function resetDailyCounters() {
            const today = new Date().toDateString();
            appState.dailyCounters.tasks = 0;
            appState.dailyCounters.ads = 0;
            localStorage.setItem('last_daily_reset', today);
            localStorage.setItem(STORAGE_KEYS.DAILY_COUNTERS, JSON.stringify(appState.dailyCounters));
        }

        // ==================== TELEGRAM INTEGRATION ====================
        function initializeTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    appState.WebApp = window.Telegram.WebApp;
                    appState.isTelegramWebApp = true;
                    
                    // Initialize Telegram Web App
                    appState.WebApp.ready();
                    appState.WebApp.expand();
                    
                    // Get Telegram user data
                    const tgUser = appState.WebApp.initDataUnsafe.user;
                    if (tgUser) {
                        appState.user = {
                            id: tgUser.id,
                            firstName: tgUser.first_name,
                            lastName: tgUser.last_name || '',
                            username: tgUser.username || '',
                            photoUrl: tgUser.photo_url || null,
                            languageCode: tgUser.language_code || 'en'
                        };
                        appState.telegramUserId = tgUser.id;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Telegram initialization error:', error);
                    return false;
                }
            }
            return false;
        }

        // ==================== UI UPDATES ====================
        function updateUIFromPayload() {
            // Update balance
            document.getElementById('balanceText').textContent = appState.balance.toLocaleString();
            document.getElementById('statGcoins').textContent = appState.balance.toLocaleString();
            
            // Update VIP badge
            updateVipBadge();
            
            // Update referrals
            document.getElementById('statReferrals').textContent = appState.referrals;
            document.getElementById('statPendingRefs').textContent = appState.pendingReferrals;
            document.getElementById('statRefEarned').textContent = appState.totalRefEarned;
            
            // Update profile info
            if (appState.user) {
                const profileName = document.getElementById('profileName');
                const profileUsername = document.getElementById('profileUsername');
                const profileAvatar = document.getElementById('profileAvatar');
                
                if (profileName) {
                    const fullName = `${appState.user.firstName || ''} ${appState.user.lastName || ''}`.trim();
                    profileName.textContent = fullName || 'Telegram User';
                }
                
                if (profileUsername) {
                    const username = appState.user.username || '';
                    profileUsername.textContent = username.startsWith('@') ? username : `@${username}`;
                }
                
                if (profileAvatar) {
                    if (appState.user.photoUrl) {
                        profileAvatar.innerHTML = `<img src="${appState.user.photoUrl}" alt="Profile" onerror="this.style.display='none'; this.parentElement.textContent='${getInitials(appState.user.firstName, appState.user.lastName)}'">`;
                    } else {
                        const initials = getInitials(appState.user.firstName, appState.user.lastName);
                        profileAvatar.textContent = initials;
                    }
                }
            }
            
            // Update counters
            updateCounters();
            
            // Load viral posts
            loadViralPosts();
        }

        function updateVipBadge() {
            const vipBadge = document.getElementById('vipBadge');
            if (!vipBadge) return;
            
            // Map VIP levels
            const vipMap = {
                'none': { class: 'none', text: 'No VIP' },
                'basic': { class: 'basic', text: 'Basic VIP' },
                'silver': { class: 'silver', text: 'Silver VIP' },
                'gold': { class: 'gold', text: 'Gold VIP' },
                'premium': { class: 'premium', text: 'Premium VIP' },
                ' No VIP': { class: 'none', text: 'No VIP' }
            };
            
            const vipInfo = vipMap[appState.vipLevel] || vipMap.none;
            
            vipBadge.className = `vip-badge ${vipInfo.class}`;
            vipBadge.textContent = vipInfo.text;
        }

        // ==================== POSTS DISPLAY ====================
        function loadViralPosts() {
            const viralPosts = JSON.parse(localStorage.getItem(STORAGE_KEYS.VIRAL_POSTS) || '[]');
            appState.viralPosts = viralPosts;
            updateFeed();
        }

        function updateFeed() {
            const feedContainer = document.getElementById('feedContainer');
            if (!feedContainer) return;
            
            feedContainer.innerHTML = '';
            
            // Combine viral posts and user posts
            const allPosts = [...appState.viralPosts];
            
            if (allPosts.length === 0) {
                // Load demo posts if no viral posts
                loadDemoPosts();
                updateFeed();
                return;
            }
            
            // Display posts
            allPosts.forEach(post => {
                const postElement = createPostElement(post);
                feedContainer.appendChild(postElement);
            });
        }

        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = 'post-card';
            div.dataset.postId = post.id;
            
            // Calculate time ago
            const timeAgo = getTimeAgo(post.timestamp);
            
            // Media HTML
            let mediaHtml = '';
            if (post.media) {
                if (post.media.type === 'video' || post.media.includes('.mp4') || post.media.includes('.webm')) {
                    mediaHtml = `
                        <div class="post-media">
                            <video controls>
                                <source src="${post.media}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                } else {
                    mediaHtml = `
                        <div class="post-media">
                            <img src="${post.media}" alt="Post image" onerror="this.style.display='none'">
                        </div>
                    `;
                }
            }
            
            // Action text based on link type
            const actionText = getActionText(post.linkType || 'visit');
            
            div.innerHTML = `
                <div class="post-header" onclick="viewUserProfile('${post.userId || 'unknown'}')">
                    <div class="avatar">
                        ${post.userAvatar || 'U'}
                    </div>
                    <div class="post-meta">
                        <div class="poster-name">${post.username || 'Anonymous'}</div>
                        <div class="post-time">${timeAgo}  ${post.views || 0} views</div>
                    </div>
                </div>
                <div class="post-content">${post.content || ''}</div>
                ${mediaHtml}
                <div class="earnings-bar">
                    <span class="earnings-label">Earn up to ${(post.reward || 0).toLocaleString()} G-coins</span>
                </div>
                <div class="post-actions">
                    <button class="action-btn ${post.userHasLiked ? 'liked' : ''}" onclick="handleLike('${post.id}', this)">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 14L2.5 8.5C1.5 7.5 1.5 5.8 2.5 4.8C3.5 3.8 5.2 3.8 6.2 4.8L8 6.6L9.8 4.8C10.8 3.8 12.5 3.8 13.5 4.8C14.5 5.8 14.5 7.5 13.5 8.5L8 14Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                  ${post.userHasLiked ? 'fill="currentColor"' : 'fill="none"'}/>
                        </svg>
                        <span>${post.likes || 0}</span>
                    </button>
                    <button class="action-btn" onclick="handleTaskAction('${post.id}', '${post.link || ''}', '${post.linkType || 'visit'}', ${post.reward || 0})">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2L8 8L14 2ZM14 2L9.5 14L8 8L2 6.5L14 2Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>${actionText}</span>
                    </button>
                    <button class="action-btn" onclick="toggleComments('${post.id}')">
                        <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 11C14 11.5 13.5 12 13 12H4L2 14V3C2 2.5 2.5 2 3 2H13C13.5 2 14 2.5 14 3V11Z" 
                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>${(post.comments || []).length}</span>
                    </button>
                </div>
                <div class="comments-section" id="comments-${post.id}">
                    <div class="comments-container" id="comments-container-${post.id}">
                        ${(post.comments || []).map(comment => `
                            <div class="comment-item">
                                <div class="comment-avatar">${comment.username.charAt(0)}</div>
                                <div class="comment-content">
                                    <div class="comment-author">${comment.username}</div>
                                    <div class="comment-text">${comment.text}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
                        <button class="send-comment-btn" onclick="sendComment('${post.id}')">Send</button>
                    </div>
                </div>
            `;
            
            return div;
        }

        // ==================== TASKS DISPLAY ====================
        function updateTasks() {
            const taskList = document.getElementById('taskList');
            if (!taskList) return;
            
            taskList.innerHTML = '';
            
            const allTasks = [...appState.tasks, ...appState.randomTasks];
            
            if (allTasks.length === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        No tasks available. Check back later!
                    </div>
                `;
                return;
            }
            
            allTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
            
            updateTaskCounter();
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task-card ${task.completed ? 'completed' : ''}`;
            div.dataset.taskId = task.id;
            
            const platform = PLATFORMS.find(p => p.id === task.platform) || PLATFORMS[0];
            
            div.innerHTML = `
                <div class="task-header">
                    <div class="platform-icon ${platform.id}" style="color: ${platform.color}; width: 40px; height: 40px;">
                    </div>
                    <div class="task-info">
                        <h3 class="task-title">${task.title}</h3>
                        <p class="task-description">${task.description}</p>
                    </div>
                    <div class="task-reward">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="9" fill="#FFC857" />
                            <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="10" font-weight="700">G</text>
                        </svg>
                        <span>${task.reward.toLocaleString()}</span>
                    </div>
                </div>
                <div class="task-footer">
                    <button class="task-btn primary" onclick="startTask('${task.id}')" ${task.completed ? 'disabled' : ''}>
                        ${task.completed ? 'Completed' : 'Start Task'}
                    </button>
                    <button class="task-btn secondary" onclick="viewTaskDetails('${task.id}')">
                        Details
                    </button>
                </div>
            `;
            
            return div;
        }

        // ==================== ADS DISPLAY ====================
        function updateAds() {
            const watchGrid = document.getElementById('watchGrid');
            if (!watchGrid) return;
            
            watchGrid.innerHTML = '';
            
            if (appState.ads.length === 0) {
                watchGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                        No ads available. Check back later!
                    </div>
                `;
                return;
            }
            
            appState.ads.forEach(ad => {
                const adElement = createAdElement(ad);
                watchGrid.appendChild(adElement);
            });
            
            updateAdsCounter();
        }

        function createAdElement(ad) {
            const div = document.createElement('div');
            div.className = `video-card ${ad.watched ? 'watched' : ''}`;
            div.dataset.adId = ad.id;
            
            div.innerHTML = `
                <div class="video-thumbnail" onclick="watchAd('${ad.id}')">
                    ${ad.watched ? `
                        <div class="watched-overlay">
                            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="rgba(74, 163, 255, 0.9)" />
                                <path d="M12 20L17 25L28 14" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    ` : `
                        <svg class="play-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="24" cy="24" r="22" fill="rgba(255,255,255,0.9)" />
                            <path d="M19 16L32 24L19 32V16Z" fill="#0B0B0D" />
                        </svg>
                    `}
                    <span class="video-duration">0:${ad.duration.toString().padStart(2, '0')}</span>
                </div>
                <div class="video-info">
                    <div class="video-advertiser">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="14" height="14" rx="3" fill="${getRandomColor()}" />
                        </svg>
                        <span>${ad.source}</span>
                    </div>
                    <h3 class="video-title">${ad.title}</h3>
                    <div class="video-meta">
                        ${ad.watched ? `
                            <span class="collected-badge">Collected</span>
                        ` : `
                            <span>Watch 0:${ad.duration.toString().padStart(2, '0')}  Earn</span>
                        `}
                        <span class="video-reward">+${ad.reward} G-coins</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // ==================== BROWSER HANDLING ====================
        function handleTaskAction(postId, link, type, reward) {
            // Determine if link should open in iframe or directly
            const shouldOpenInIframe = shouldOpenInBrowser(link, type);
            
            if (shouldOpenInIframe) {
                openBrowserModal();
                document.getElementById('browserUrl').textContent = link;
                document.getElementById('browserIframe').src = link;
                
                const duration = type === 'watch' ? 90 : 60;
                startTimer(duration, 'task', {
                    id: postId,
                    platform: 'website',
                    reward: reward
                });
            } else {
                // Open directly in new tab/window
                if (appState.WebApp && type === 'join') {
                    // Use Telegram's openTelegramLink for Telegram links
                    appState.WebApp.openTelegramLink(link);
                } else {
                    window.open(link, '_blank');
                }
                
                // Start timer for direct links too
                const duration = type === 'watch' ? 90 : 60;
                startDirectTimer(duration, 'task', {
                    id: postId,
                    platform: 'website',
                    reward: reward
                });
            }
            
            // Send to bot
            sendToBot('post_action_started', {
                post_id: postId,
                action: type,
                reward: reward,
                link: link
            });
        }

        function shouldOpenInBrowser(link, type) {
            // Don't open in iframe for these types
            if (['join', 'install', 'signup'].includes(type)) {
                return false;
            }
            
            // Check if it's a Telegram link
            if (link.includes('t.me') || link.includes('telegram.me')) {
                return false;
            }
            
            // Check if it's an app store link
            if (link.includes('play.google.com') || link.includes('apps.apple.com')) {
                return false;
            }
            
            return true;
        }

        function openBrowserModal() {
            document.getElementById('browserModal').classList.add('active');
        }

        function closeBrowserModal() {
            document.getElementById('browserModal').classList.remove('active');
            document.getElementById('browserIframe').src = '';
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
            
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('timerProgressBar').style.width = '0%';
        }

        // ==================== TIMER FUNCTIONS ====================
        function startTimer(seconds, type, data) {
            let remaining = seconds;
            const display = document.getElementById('timerDisplay');
            const progressBar = document.getElementById('timerProgressBar');
            const timerLabel = document.getElementById('timerLabel');
            
            timerLabel.textContent = type === 'task' 
                ? 'Complete the task to earn rewards' 
                : 'Watch the ad to earn rewards';
            
            document.getElementById('timerOverlay').style.display = 'flex';
            updateTimerDisplay();
            
            appState.timerInterval = setInterval(() => {
                remaining--;
                updateTimerDisplay();
                
                if (remaining <= 0) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                    
                    if (type === 'task') {
                        completeTask(data);
                    } else if (type === 'ad') {
                        completeAd(data);
                    }
                }
            }, 1000);
            
            function updateTimerDisplay() {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                const progress = ((seconds - remaining) / seconds) * 100;
                progressBar.style.width = `${progress}%`;
            }
        }

        function startDirectTimer(seconds, type, data) {
            let remaining = seconds;
            const timerLabel = type === 'task' ? 'Complete the task' : 'Watch the ad';
            
            showToast(`${timerLabel} - ${seconds}s remaining`, 'info');
            
            const interval = setInterval(() => {
                remaining--;
                
                if (remaining <= 0) {
                    clearInterval(interval);
                    
                    if (type === 'task') {
                        completeTask(data);
                    } else if (type === 'ad') {
                        completeAd(data);
                    }
                } else if (remaining % 30 === 0) {
                    showToast(`${timerLabel} - ${remaining}s remaining`, 'info');
                }
            }, 1000);
        }

        // ==================== TASK/AD COMPLETION ====================
        async function completeTask(data) {
            try {
                // Find and mark task as completed
                let task = appState.tasks.find(t => t.id === data.id);
                if (!task) {
                    task = appState.randomTasks.find(t => t.id === data.id);
                }
                
                if (task) {
                    task.completed = true;
                }
                
                // Update daily counter
                appState.dailyCounters.tasks++;
                
                // Send completion to bot
                await sendToBot('task_completed', {
                    task_id: data.id,
                    task_type: data.platform,
                    reward: data.reward,
                    user_id: appState.telegramUserId
                });
                
                // Show success message
                showToast(`Task completed! +${data.reward.toLocaleString()} G-Coins`, 'success');
                
                // Update UI
                updateTasks();
                updateCounters();
                
            } catch (error) {
                console.error('Task completion error:', error);
                showToast('Failed to complete task', 'error');
            }
        }

        async function completeAd(data) {
            try {
                // Find and mark ad as watched
                const ad = appState.ads.find(a => a.id === data.id);
                if (ad) {
                    ad.watched = true;
                }
                
                // Update daily counter
                appState.dailyCounters.ads++;
                
                // Send completion to bot
                await sendToBot('ad_completed', {
                    ad_id: data.id,
                    reward: data.reward,
                    user_id: appState.telegramUserId
                });
                
                // Show success message
                showToast(`Ad watched! +${data.reward} G-Coins`, 'success');
                
                // Update UI
                updateAds();
                updateCounters();
                
            } catch (error) {
                console.error('Ad completion error:', error);
                showToast('Failed to complete ad', 'error');
            }
        }

        // ==================== POST CREATION ====================
        function openComposer() {
            if (!['gold', 'premium', 'silver'].includes(appState.vipLevel)) {
                showToast('Only Silver, Gold, and Premium VIP can create posts', 'error');
                return;
            }
            
            if (appState.balance < 10000) {
                showToast('Minimum 10,000 G-Coins required to create a post', 'error');
                return;
            }
            
            document.getElementById('composerModal').classList.add('active');
        }

        function closeComposer() {
            document.getElementById('composerModal').classList.remove('active');
            document.getElementById('postForm').reset();
            document.getElementById('mediaPreview').innerHTML = '';
        }

        async function submitPost(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('postSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Publishing...';
            submitBtn.disabled = true;
            
            try {
                const content = document.getElementById('postContent').value;
                const link = document.getElementById('postLink').value;
                const linkType = document.getElementById('postLinkType').value;
                const reward = parseInt(document.getElementById('postReward').value);
                
                if (reward < 10000) {
                    throw new Error('Minimum reward is 10,000 G-Coins');
                }
                
                if (reward > appState.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Get media file
                const mediaInput = document.getElementById('mediaInput');
                let mediaUrl = null;
                let mediaType = null;
                
                if (mediaInput.files && mediaInput.files[0]) {
                    // In real app, upload to server and get URL
                    // For demo, create object URL
                    const file = mediaInput.files[0];
                    mediaUrl = URL.createObjectURL(file);
                    mediaType = file.type.includes('video') ? 'video' : 'image';
                }
                
                // Create post object
                const newPost = {
                    userId: appState.telegramUserId,
                    username: appState.user?.username || 'user',
                    userAvatar: getInitials(appState.user?.firstName, appState.user?.lastName) || 'U',
                    content: content,
                    link: link,
                    linkType: linkType,
                    reward: reward,
                    media: mediaUrl,
                    mediaType: mediaType
                };
                
                // Add to viral posts
                const viralPost = addViralPost(newPost);
                
                // Update feed
                loadViralPosts();
                
                // Deduct balance (bot will update this)
                await sendToBot('post_created', {
                    post: viralPost,
                    reward_deducted: reward
                });
                
                closeComposer();
                showToast('Post created successfully! Going viral...', 'success');
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getTimeAgo(timestamp) {
            const now = new Date();
            const postDate = new Date(timestamp);
            const diffMs = now - postDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return postDate.toLocaleDateString();
        }

        function getRandomSmartLink() {
            return SMART_LINKS[Math.floor(Math.random() * SMART_LINKS.length)];
        }

        function getRandomAdTitle() {
            const titles = [
                'Tech Review 2024',
                'Crypto Market Update',
                'Gaming News Today',
                'Product Launch Event',
                'Mobile App Review'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function getRandomAdSource() {
            const sources = [
                'TechBrand Co.',
                'CryptoExchange',
                'GameStore',
                'Fashion Brand',
                'Finance Corp'
            ];
            return sources[Math.floor(Math.random() * sources.length)];
        }

        function getRandomTaskTitle() {
            const titles = [
                'Website Visit Task',
                'Survey Completion',
                'App Installation',
                'Product Review',
                'Market Research'
            ];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function getRandomTaskDescription() {
            const descriptions = [
                'Visit website and stay for specified time',
                'Complete short survey for research',
                'Install app and open for verification',
                'Review product features',
                'Participate in market research'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        function getRandomCount() {
            return Math.floor(Math.random() * 10) + 1;
        }

        function getRandomColor() {
            const colors = ['#4AA3FF', '#E33D7A', '#5B2E8A', '#FF98BD', '#FFC857'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getActionText(type) {
            const actions = {
                visit: 'Visit',
                join: 'Join',
                watch: 'Watch',
                install: 'Install',
                signup: 'Sign Up'
            };
            return actions[type] || 'Open';
        }

        function getVipBonus(level) {
            const bonuses = {
                none: 0,
                basic: 20,
                silver: 40,
                gold: 60,
                premium: 100
            };
            return bonuses[level] || 0;
        }

        function getInitials(firstName, lastName) {
            return ((firstName?.[0] || '') + (lastName?.[0] || '')).toUpperCase() || 'U';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${icons[type] || ''}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        // ==================== DEMO DATA ====================
        function loadDemoPosts() {
            const demoPosts = [
                {
                    id: 'demo1',
                    userId: '123456',
                    username: 'johndoe',
                    userAvatar: 'JD',
                    content: ' Just earned 5,000 G-Coins by completing a simple YouTube task! The process was smooth and rewards were instant. Highly recommend trying out GainGrid! #EarnMoney #GainGrid',
                    media: 'https://images.unsplash.com/photo-1611224923853-80b023f02d71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://example.com/join',
                    linkType: 'join',
                    reward: 5000,
                    likes: 24,
                    comments: [
                        { id: 'c1', userId: 'user1', username: 'Alice', text: 'Great opportunity!' },
                        { id: 'c2', userId: 'user2', username: 'Bob', text: 'Just completed!' },
                        { id: 'c3', userId: 'user3', username: 'Charlie', text: 'How long did it take?' }
                    ],
                    shares: 12,
                    views: 150,
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                    userHasLiked: false
                },
                {
                    id: 'demo2',
                    userId: '789012',
                    username: 'sarahkim',
                    userAvatar: 'SK',
                    content: ' New task alert! Complete this survey and earn instant rewards. Takes only 5 minutes! Perfect for quick earnings during break time. #Survey #EasyMoney',
                    media: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://example.com/survey',
                    linkType: 'visit',
                    reward: 3000,
                    likes: 18,
                    comments: [
                        { id: 'c4', userId: 'user4', username: 'David', text: 'Easy money!' },
                        { id: 'c5', userId: 'user5', username: 'Eva', text: 'Completed in 4 mins!' }
                    ],
                    shares: 3,
                    views: 89,
                    timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                    userHasLiked: true
                },
                {
                    id: 'demo3',
                    userId: '345678',
                    username: 'techguru',
                    userAvatar: 'TG',
                    content: ' Pro tip: Complete 3 tasks daily to unlock bonus rewards! The more consistent you are, the higher your VIP level becomes. Keep grinding! #Tips #GainGrid',
                    media: null,
                    link: 'https://example.com/tips',
                    linkType: 'visit',
                    reward: 2000,
                    likes: 42,
                    comments: [
                        { id: 'c6', userId: 'user6', username: 'Frank', text: 'Thanks for the tip!' },
                        { id: 'c7', userId: 'user7', username: 'Grace', text: 'Working on it!' },
                        { id: 'c8', userId: 'user8', username: 'Henry', text: 'Already completed 2 today!' }
                    ],
                    shares: 7,
                    views: 210,
                    timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    userHasLiked: false
                },
                {
                    id: 'demo4',
                    userId: '901234',
                    username: 'cryptomaster',
                    userAvatar: 'CM',
                    content: ' Just watched an ad and earned 120 G-Coins instantly! The ads are short and relevant. Perfect for passive earning while doing other things. #PassiveIncome #Ads',
                    media: 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    link: 'https://example.com/watch',
                    linkType: 'watch',
                    reward: 120,
                    likes: 31,
                    comments: [
                        { id: 'c9', userId: 'user9', username: 'Ivy', text: 'Love these short ads!' },
                        { id: 'c10', userId: 'user10', username: 'Jack', text: 'Easy 120 coins!' }
                    ],
                    shares: 5,
                    views: 175,
                    timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                    userHasLiked: true
                }
            ];
            
            // Add to viral posts
            demoPosts.forEach(post => {
                updateViralPosts([post]);
            });
            
            updateFeed();
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            try {
                // Initialize Telegram
                initializeTelegram();
                
                // Parse payload from URL
                const payload = parseUrlPayload();
                if (payload) {
                    handleBotPayload(payload);
                } else {
                    // Load from localStorage if no payload
                    loadFromLocalStorage();
                }
                
                // Load platforms
                loadPlatforms();
                
                // Load demo data if needed
                if (appState.viralPosts.length === 0) {
                    loadDemoPosts();
                }
                
                // Load tasks
                if (appState.tasks.length === 0) {
                    await loadTasks();
                }
                
                // Load ads
                if (appState.ads.length === 0) {
                    await loadAds();
                }
                
                // Setup event listeners
                setupEventListeners();
                initPlatformAutoScroll();
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize app', 'error');
                
                // Still hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);
            }
        }

        function loadFromLocalStorage() {
            try {
                const userData = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DATA) || '{}');
                const appStateData = JSON.parse(localStorage.getItem(STORAGE_KEYS.APP_STATE) || '{}');
                const viralPosts = JSON.parse(localStorage.getItem(STORAGE_KEYS.VIRAL_POSTS) || '[]');
                const tasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.TASKS) || '[]');
                const ads = JSON.parse(localStorage.getItem(STORAGE_KEYS.ADS) || '[]');
                const dailyCounters = JSON.parse(localStorage.getItem(STORAGE_KEYS.DAILY_COUNTERS) || '{"tasks":0,"ads":0}');
                
                // Merge with appState
                Object.assign(appState, appStateData);
                appState.user = userData;
                appState.viralPosts = viralPosts;
                appState.tasks = tasks;
                appState.ads = ads;
                appState.dailyCounters = dailyCounters;
                
                // Update UI
                updateUIFromPayload();
                
            } catch (error) {
                console.error('Load from storage error:', error);
            }
        }

        async function loadTasks() {
            const tasks = [
                {
                    id: 'task1',
                    platform: 'youtube',
                    title: 'Watch YouTube Video',
                    description: 'Watch full video and like. Stay 02:30 for reward.',
                    duration: 150,
                    reward: 5000,
                    link: getRandomSmartLink(),
                    completed: false
                },
                {
                    id: 'task2',
                    platform: 'telegram',
                    title: 'Join Telegram Channel',
                    description: 'Join channel and stay active. Stay 00:45 for reward.',
                    duration: 45,
                    reward: 3500,
                    link: getRandomSmartLink(),
                    completed: false
                },
                {
                    id: 'task3',
                    platform: 'instagram',
                    title: 'Follow Instagram Account',
                    description: 'Follow account and like 3 posts.',
                    duration: 120,
                    reward: 4000,
                    link: getRandomSmartLink(),
                    completed: false
                },
                {
                    id: 'task4',
                    platform: 'twitter',
                    title: 'Follow Twitter Account',
                    description: 'Follow account and retweet 1 post.',
                    duration: 90,
                    reward: 3000,
                    link: getRandomSmartLink(),
                    completed: false
                },
                {
                    id: 'task5',
                    platform: 'website',
                    title: 'Visit Website',
                    description: 'Visit website and stay for 2 minutes.',
                    duration: 120,
                    reward: 2500,
                    link: getRandomSmartLink(),
                    completed: false
                }
            ];
            
            appState.tasks = tasks;
            generateRandomTasks();
            updateTasks();
        }

        async function loadAds() {
            const ads = [];
            for (let i = 0; i < 8; i++) {
                ads.push({
                    id: `ad${i + 1}`,
                    title: getRandomAdTitle(),
                    duration: Math.floor(Math.random() * 30) + 30,
                    reward: Math.floor(Math.random() * 61) + 60,
                    source: getRandomAdSource(),
                    link: getRandomSmartLink(),
                    watched: i < 2
                });
            }
            
            appState.ads = ads;
            updateAds();
        }

        function loadPlatforms() {
            const platformGrid = document.getElementById('platformGrid');
            if (!platformGrid) return;
            
            platformGrid.innerHTML = '';
            
            PLATFORMS.forEach(platform => {
                const platformElement = createPlatformElement(platform);
                platformGrid.appendChild(platformElement);
                const platformElement2 = createPlatformElement(platform);
                platformGrid.appendChild(platformElement2);
            });
        }

        function createPlatformElement(platform) {
            const div = document.createElement('div');
            div.className = `platform-card ${platform.id}`;
            div.onclick = () => filterTasksByPlatform(platform.id);
            
            let svgIcon = '';
            
            switch (platform.id) {
                case 'youtube':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47.13-1.33.22-2.65.28-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z"/></svg>';
                    break;
                case 'telegram':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>';
                    break;
                default:
                    svgIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
            }
            
            div.innerHTML = `
                <div class="platform-icon" style="color: ${platform.color}">
                    ${svgIcon}
                </div>
                <div class="platform-name">${platform.name}</div>
                <div class="platform-count">${getRandomCount()} tasks</div>
            `;
            
            return div;
        }

        function updateCounters() {
            updateTaskCounter();
            updateAdsCounter();
            
            const totalEarned = parseInt(localStorage.getItem('gaingrid_total_earned') || '0');
            document.getElementById('statTotalEarned').textContent = totalEarned.toLocaleString();
            document.getElementById('statTasksDone').textContent = appState.dailyCounters.tasks.toString();
        }

        function updateTaskCounter() {
            const completedTasks = [...appState.tasks, ...appState.randomTasks].filter(t => t.completed).length;
            document.getElementById('taskCounter').textContent = `${completedTasks}/20`;
        }

        function updateAdsCounter() {
            const watchedAds = appState.ads.filter(a => a.watched).length;
            document.getElementById('adsCounter').textContent = `${watchedAds}/20`;
        }

        function filterTasksByPlatform(platformId) {
            const taskList = document.getElementById('taskList');
            if (!taskList) return;
            
            taskList.innerHTML = '';
            
            const filteredTasks = [...appState.tasks, ...appState.randomTasks].filter(task => 
                task.platform === platformId && !task.completed
            );
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        No tasks available for ${PLATFORMS.find(p => p.id === platformId)?.name || 'this platform'}. Check back later!
                    </div>
                `;
                return;
            }
            
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            const mainContent = document.getElementById('mainContent');
            const fab = document.getElementById('fabPost');
            
            if (mainContent && fab) {
                mainContent.addEventListener('scroll', () => {
                    const currentScroll = mainContent.scrollTop;
                    
                    if (currentScroll > appState.lastScrollPosition && currentScroll > 100) {
                        fab.classList.add('hidden');
                    } else {
                        fab.classList.remove('hidden');
                    }
                    
                    appState.lastScrollPosition = currentScroll;
                });
            }
            
            // Media upload handling
            const mediaDropArea = document.getElementById('mediaDropArea');
            const mediaInput = document.getElementById('mediaInput');
            
            if (mediaDropArea && mediaInput) {
                mediaDropArea.addEventListener('click', () => mediaInput.click());
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    mediaDropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    mediaDropArea.addEventListener(eventName, () => mediaDropArea.classList.add('drag-over'), false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    mediaDropArea.addEventListener(eventName, () => mediaDropArea.classList.remove('drag-over'), false);
                });
                
                mediaDropArea.addEventListener('drop', handleDrop, false);
                mediaInput.addEventListener('change', handleFiles, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFiles({ target: { files } });
                }
                
                function handleFiles(e) {
                    const files = e.target.files;
                    const preview = document.getElementById('mediaPreview');
                    
                    preview.innerHTML = '';
                    
                    Array.from(files).slice(0, 4).forEach(file => {
                        if (file.size > 10 * 1024 * 1024) {
                            showToast(`File ${file.name} is too large. Max size is 10MB.`, 'error');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'preview-item';
                            
                            if (file.type.startsWith('image/')) {
                                previewItem.innerHTML = `
                                    <img src="${e.target.result}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">
                                    <button class="remove-preview" onclick="this.parentElement.remove()"></button>
                                `;
                            } else if (file.type.startsWith('video/')) {
                                previewItem.innerHTML = `
                                    <video src="${e.target.result}" controls style="width:100%;height:100%;object-fit:cover;"></video>
                                    <button class="remove-preview" onclick="this.parentElement.remove()"></button>
                                `;
                            }
                            
                            preview.appendChild(previewItem);
                        };
                        
                        reader.readAsDataURL(file);
                    });
                }
            }
            
            // Profile buttons
            document.getElementById('editProfileBtn')?.addEventListener('click', () => {
                showProfileSection('edit');
            });
            
            document.getElementById('transactionHistoryBtn')?.addEventListener('click', () => {
                showProfileSection('transactions');
            });
            
            document.getElementById('referralsBtn')?.addEventListener('click', () => {
                showProfileSection('referrals');
            });
            
            document.getElementById('settingsBtn')?.addEventListener('click', () => {
                showProfileSection('settings');
            });
            
            document.getElementById('helpSupportBtn')?.addEventListener('click', () => {
                openHelpSupport();
            });
            
            document.getElementById('cleanupBtn')?.addEventListener('click', cleanupWatched);
            
            document.getElementById('newTaskBtn')?.addEventListener('click', () => {
                showToast('Task creation feature coming soon!', 'info');
            });
            
            // Hash change for navigation
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.replace('#', '');
                if (hash) {
                    switchScreen(hash);
                }
            });
            
            // Initialize Monetag
            initializeMonetagAds();
        }

        // ==================== SCREEN NAVIGATION ====================
        function switchScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const screen = document.getElementById(`${screenName}Screen`);
            if (screen) {
                screen.classList.add('active');
            }
            
            const navItem = Array.from(document.querySelectorAll('.nav-item')).find(item => 
                item.textContent.includes(screenName.charAt(0).toUpperCase() + screenName.slice(1).replace('Screen', ''))
            );
            
            if (navItem) {
                navItem.classList.add('active');
            }
            
            window.location.hash = screenName;
        }

        // ==================== PROFILE SECTIONS ====================
        function showProfileSection(section) {
            const modal = document.getElementById('profileSectionModal');
            const title = document.getElementById('profileSectionTitle');
            const content = document.getElementById('profileSectionContent');
            
            if (!modal || !title || !content) return;
            
            let sectionContent = '';
            
            switch (section) {
                case 'edit':
                    title.textContent = 'Edit Profile';
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">Telegram Username</label>
                            <input type="text" class="form-input" value="${appState.user?.username || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-input" value="${appState.telegramUserId || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">VIP Level</label>
                            <div class="vip-badge ${appState.vipLevel}" style="margin-top: 8px; display: inline-block;">
                                ${appState.vipLevel.charAt(0).toUpperCase() + appState.vipLevel.slice(1)} VIP
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Balance</label>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10" cy="10" r="9" fill="#FFC857" />
                                    <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="10" font-weight="700">G</text>
                                </svg>
                                <span style="font-weight: 600; color: var(--gcoin-gold);">${appState.balance.toLocaleString()} G-Coins</span>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'transactions':
                    title.textContent = 'Transaction History';
                    sectionContent = `
                        <div style="max-height: 400px; overflow-y: auto;">
                            <div class="transaction-item">
                                <div class="transaction-icon earn">+</div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Task Reward - YouTube</div>
                                    <div class="transaction-time">2 hours ago</div>
                                </div>
                                <div class="transaction-amount earn">+5,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon earn">+</div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Ad Watch Reward</div>
                                    <div class="transaction-time">5 hours ago</div>
                                </div>
                                <div class="transaction-amount earn">+120</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon spend">-</div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Post Creation</div>
                                    <div class="transaction-time">1 day ago</div>
                                </div>
                                <div class="transaction-amount spend">-10,000</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'referrals':
                    title.textContent = 'Referrals';
                    const refLink = `https://t.me/GridGain_Bot?start=${appState.telegramUserId || 'ref'}`;
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">Your Referral Link</label>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" class="form-input" value="${refLink}" id="refLinkInput" readonly>
                                <button class="submit-btn" style="flex: 0 0 auto; padding: 0 16px;" 
                                        onclick="copyRefLink()">
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="profile-stats" style="margin-top: 24px;">
                            <div class="stat-item">
                                <div class="stat-value">${appState.referrals}</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${appState.pendingReferrals}</div>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${appState.totalRefEarned}</div>
                                <div class="stat-label">Total Earned</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'settings':
                    title.textContent = 'Settings';
                    sectionContent = `
                        <div class="form-group">
                            <label class="form-label">App Version</label>
                            <input type="text" class="form-input" value="2.0.0" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Updated</label>
                            <input type="text" class="form-input" value="${new Date().toLocaleDateString()}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session ID</label>
                            <input type="text" class="form-input" value="${appState.sessionId}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Sync</label>
                            <button class="submit-btn" onclick="syncWithBot()">Sync with Bot</button>
                        </div>
                    `;
                    break;
            }
            
            content.innerHTML = sectionContent;
            modal.classList.add('active');
        }

        function closeProfileSection() {
            document.getElementById('profileSectionModal').classList.remove('active');
        }

        function openHelpSupport() {
            if (appState.WebApp) {
                appState.WebApp.openTelegramLink('https://t.me/GridGain_Bot?start=help');
            } else {
                window.open('https://t.me/GridGain_Bot?start=help', '_blank');
            }
        }

        function copyRefLink() {
            const input = document.getElementById('refLinkInput');
            if (input) {
                input.select();
                document.execCommand('copy');
                showToast('Referral link copied!', 'success');
            }
        }

        async function syncWithBot() {
            showToast('Syncing with bot...', 'info');
            
            // Request fresh data from bot
            await sendToBot('data_sync_request', {
                user_id: appState.telegramUserId,
                timestamp: Date.now()
            });
            
            showToast('Sync request sent to bot', 'success');
        }

        // ==================== INTERACTION FUNCTIONS ====================
        async function handleLike(postId, button) {
            const post = appState.viralPosts.find(p => p.id === postId);
            if (!post) return;
            
            const wasLiked = post.userHasLiked;
            post.userHasLiked = !wasLiked;
            post.likes += wasLiked ? -1 : 1;
            
            button.classList.toggle('liked');
            button.querySelector('span').textContent = post.likes;
            
            // Save to storage
            localStorage.setItem(STORAGE_KEYS.VIRAL_POSTS, JSON.stringify(appState.viralPosts));
            
            // Send to bot
            await sendToBot('post_liked', {
                post_id: postId,
                liked: !wasLiked,
                likes: post.likes
            });
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('active');
            }
        }

        async function sendComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            const post = appState.viralPosts.find(p => p.id === postId);
            if (!post) return;
            
            // Add comment
            if (!post.comments) post.comments = [];
            post.comments.push({
                id: Date.now().toString(),
                userId: appState.telegramUserId || 'user',
                username: appState.user?.username || 'You',
                text: text
            });
            
            // Update UI
            const commentsContainer = document.getElementById(`comments-container-${postId}`);
            if (commentsContainer) {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.innerHTML = `
                    <div class="comment-avatar">${appState.user?.firstName?.[0] || 'U'}</div>
                    <div class="comment-content">
                        <div class="comment-author">${appState.user?.username || 'You'}</div>
                        <div class="comment-text">${text}</div>
                    </div>
                `;
                commentsContainer.appendChild(commentDiv);
            }
            
            input.value = '';
            
            // Save to storage
            localStorage.setItem(STORAGE_KEYS.VIRAL_POSTS, JSON.stringify(appState.viralPosts));
            
            // Send to bot
            await sendToBot('comment_added', {
                post_id: postId,
                comment: text,
                comment_count: post.comments.length
            });
        }

        function viewUserProfile(userId) {
            switchScreen('profile');
            showToast('User profile view coming soon!', 'info');
        }

        function viewTaskDetails(taskId) {
            showToast('Task details coming soon!', 'info');
        }

        function cleanupWatched() {
            appState.ads = appState.ads.filter(ad => !ad.watched);
            appState.tasks = appState.tasks.filter(task => !task.completed);
            appState.randomTasks = appState.randomTasks.filter(task => !task.completed);
            
            updateAds();
            updateTasks();
            showToast('Cleaned up completed items', 'success');
        }

        // ==================== MONETAG INTEGRATION ====================
        function initializeMonetagAds() {
            if (typeof monetag !== 'undefined') {
                try {
                    monetag('start');
                    
                    

// In-App Interstitial

show_10274566({
  type: 'inApp',
  inAppSettings: {
    frequency: 2,
    capping: 0.1,
    interval: 30,
    timeout: 5,
    everyPage: false
  }
})
                    
                } catch (error) {
                    console.log('Monetag setup error:', error);
                }
            }
        }

        // ==================== PLATFORM AUTO SCROLL ====================
        function initPlatformAutoScroll() {
            const platformGrid = document.getElementById('platformGrid');
            if (!platformGrid) return;
            
            const platformCards = platformGrid.querySelectorAll('.platform-card');
            const totalWidth = Array.from(platformCards).reduce((sum, card) => sum + card.offsetWidth + 16, 0);
            platformGrid.style.width = `${totalWidth * 2}px`;
            
            platformGrid.addEventListener('animationiteration', () => {
                platformGrid.style.transform = 'translateX(0)';
            });
        }

        // ==================== TASK FUNCTIONS ====================
        async function startTask(taskId) {
            const allTasks = [...appState.tasks, ...appState.randomTasks];
            const task = allTasks.find(t => t.id === taskId);
            
            if (!task || task.completed) return;
            
            if (appState.dailyCounters.tasks >= 20) {
                showToast('Daily task limit reached! Come back tomorrow.', 'warning');
                return;
            }
            
            appState.currentTask = task;
            
            // Check if should open in browser or directly
            const shouldOpenInIframe = shouldOpenInBrowser(task.link, task.platform);
            
            if (shouldOpenInIframe) {
                openBrowserModal();
                document.getElementById('browserUrl').textContent = task.link;
                document.getElementById('browserIframe').src = task.link;
                startTimer(task.duration, 'task', task);
            } else {
                // Open directly
                if (appState.WebApp && (task.platform === 'telegram' || task.link.includes('t.me'))) {
                    appState.WebApp.openTelegramLink(task.link);
                } else {
                    window.open(task.link, '_blank');
                }
                
                startDirectTimer(task.duration, 'task', task);
            }
            
            // Send to bot
            await sendToBot('task_started', {
                task_id: taskId,
                task_type: task.platform,
                reward: task.reward,
                duration: task.duration
            });
        }

        async function watchAd(adId) {
            const ad = appState.ads.find(a => a.id === adId);
            if (!ad || ad.watched) return;
            
            if (appState.dailyCounters.ads >= 20) {
                showToast('Daily ad limit reached! Come back tomorrow.', 'warning');
                return;
            }
            
            appState.currentAd = ad;
            
            // Try Monetag first
            if (typeof show_10274566 === 'function') {
                try {
                    await show_10274566('pop');
                    await completeAd(ad);
                    return;
                } catch (error) {
                    console.log('Monetag ad failed, using fallback:', error);
                }
            }
            
            // Fallback to browser
            openBrowserModal();
            document.getElementById('browserUrl').textContent = ad.link;
            document.getElementById('browserIframe').src = ad.link;
            startTimer(ad.duration, 'ad', ad);
            
            // Send to bot
            await sendToBot('ad_started', {
                ad_id: adId,
                reward: ad.reward,
                duration: ad.duration
            });
        }

        // ==================== EXPORT FUNCTIONS ====================
        window.switchScreen = switchScreen;
        window.openComposer = openComposer;
        window.closeComposer = closeComposer;
        window.handleLike = handleLike;
        window.handleTaskAction = handleTaskAction;
        window.toggleComments = toggleComments;
        window.sendComment = sendComment;
        window.watchAd = watchAd;
        window.cleanupWatched = cleanupWatched;
        window.startTask = startTask;
        window.viewTaskDetails = viewTaskDetails;
        window.viewUserProfile = viewUserProfile;
        window.copyRefLink = copyRefLink;
        window.closeBrowserModal = closeBrowserModal;
        window.closeProfileSection = closeProfileSection;
        window.showToast = showToast;
        window.submitPost = submitPost;
        window.syncWithBot = syncWithBot;

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>