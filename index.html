<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GainGrid Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Monetag SDK -->
  <script src="https://cdn.monetag.com/tag.min.js" data-manual="true"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --deep-purple: #5B2E8A;
      --vivid-magenta: #E33D7A;
      --soft-pink: #FF98BD;
      --electric-blue: #4AA3FF;
      --bg-dark: #0F0F14;
      --bg-panel: #0B0B0D;
      --text-secondary: #9AA0A6;
      --gcoin-gold: #FFC857;
      --white: #FFFFFF;
      --spacing-base: 8px;
      --radius-xs: 6px;
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-dark);
      color: var(--white);
      overflow-x: hidden;
    }

    .app-container {
      width: 100%;
      min-height: 100%;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Header */
    .app-header {
      width: 100%;
      background: var(--bg-panel);
      padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1.5);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .balance-chip {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1);
      background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(227, 61, 122, 0.3));
      padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 200, 87, 0.3);
    }

    .coin-icon {
      width: 20px;
      height: 20px;
      animation: spin 3s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }

    .balance-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--gcoin-gold);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      width: 100%;
      padding: calc(var(--spacing-base) * 3) calc(var(--spacing-base) * 2);
      padding-bottom: calc(var(--spacing-base) * 10);
      overflow-y: auto;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Feed Cards */
    .feed-container {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing-base) * 2);
    }

    .post-card {
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      padding: calc(var(--spacing-base) * 2);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .post-card:hover {
      border-color: rgba(91, 46, 138, 0.4);
      transform: translateY(-2px);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1.5);
      margin-bottom: calc(var(--spacing-base) * 2);
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--deep-purple), var(--electric-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      overflow: hidden;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-meta {
      flex: 1;
    }

    .poster-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--white);
      margin-bottom: 2px;
    }

    .post-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .post-content {
      font-size: 14px;
      line-height: 1.5;
      color: var(--white);
      margin-bottom: calc(var(--spacing-base) * 2);
    }

    .post-media {
      width: 100%;
      border-radius: var(--radius-sm);
      margin-bottom: calc(var(--spacing-base) * 2);
      overflow: hidden;
      max-height: 400px;
    }

    .post-media img,
    .post-media video {
      width: 100%;
      height: auto;
      display: block;
      border-radius: var(--radius-sm);
    }

    .earnings-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 200, 87, 0.1);
      padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
      border-radius: var(--radius-xs);
      margin-bottom: calc(var(--spacing-base) * 2);
    }

    .earnings-label {
      font-size: 12px;
      color: var(--gcoin-gold);
      font-weight: 600;
    }

    .post-actions {
      display: flex;
      gap: calc(var(--spacing-base) * 2);
    }

    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: calc(var(--spacing-base) * 1);
      padding: calc(var(--spacing-base) * 1.5);
      background: rgba(255, 255, 255, 0.05);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--white);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    .action-btn.liked {
      background: rgba(227, 61, 122, 0.2);
      color: var(--vivid-magenta);
    }

    .action-icon {
      width: 16px;
      height: 16px;
    }

    /* Comments Section */
    .comments-section {
      margin-top: calc(var(--spacing-base) * 2);
      padding: calc(var(--spacing-base) * 2);
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-sm);
      display: none;
    }

    .comments-section.active {
      display: block;
    }

    .comment-item {
      padding: calc(var(--spacing-base) * 1.5);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1);
      margin-bottom: 4px;
    }

    .comment-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--deep-purple), var(--electric-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
    }

    .comment-user {
      font-size: 12px;
      font-weight: 600;
    }

    .comment-text {
      font-size: 13px;
      color: var(--text-secondary);
      margin-left: 32px;
    }

    .comment-input-container {
      display: flex;
      gap: calc(var(--spacing-base) * 1);
      margin-top: calc(var(--spacing-base) * 2);
    }

    .comment-input {
      flex: 1;
      padding: calc(var(--spacing-base) * 1.5);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      color: var(--white);
      font-size: 13px;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--electric-blue);
    }

    .send-comment-btn {
      padding: calc(var(--spacing-base) * 1.5);
      background: var(--electric-blue);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      cursor: pointer;
    }

    /* Task Board */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing-base) * 2);
    }

    .task-card {
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      padding: calc(var(--spacing-base) * 2);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }

    .task-header {
      display: flex;
      align-items: start;
      justify-content: space-between;
      margin-bottom: calc(var(--spacing-base) * 2);
    }

    .task-info {
      flex: 1;
    }

    .task-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: calc(var(--spacing-base) * 1);
    }

    .task-description {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .task-reward {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 0.5);
      padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
      background: rgba(255, 200, 87, 0.15);
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 700;
      color: var(--gcoin-gold);
    }

    .task-footer {
      display: flex;
      gap: calc(var(--spacing-base) * 1.5);
    }

    .task-btn {
      flex: 1;
      padding: calc(var(--spacing-base) * 1.5);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .task-btn.primary {
      background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
      color: var(--white);
    }

    .task-btn.primary:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(91, 46, 138, 0.4);
    }

    .task-btn.secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--white);
    }

    .task-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Platform Grid */
    .platform-grid-container {
      width: 100%;
      overflow-x: auto;
      margin-bottom: calc(var(--spacing-base) * 3);
      padding-bottom: calc(var(--spacing-base) * 1);
    }

    .platform-grid {
      display: flex;
      gap: calc(var(--spacing-base) * 2);
      min-width: max-content;
      padding: calc(var(--spacing-base) * 1);
      animation: scrollPlatforms 30s linear infinite;
    }

    @keyframes scrollPlatforms {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .platform-grid:hover {
      animation-play-state: paused;
    }

    .platform-card {
      flex: 0 0 auto;
      width: 80px;
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      padding: calc(var(--spacing-base) * 1.5);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: calc(var(--spacing-base) * 1);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .platform-card:hover {
      transform: translateY(-4px);
      border-color: var(--electric-blue);
      box-shadow: 0 4px 12px rgba(74, 163, 255, 0.2);
    }

    .platform-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .platform-name {
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }

    /* Watch & Earn */
    .watch-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: calc(var(--spacing-base) * 2);
    }

    .video-card {
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.06);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .video-card:hover {
      transform: translateY(-4px);
      border-color: rgba(74, 163, 255, 0.4);
    }

    .video-thumbnail {
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, rgba(91, 46, 138, 0.3), rgba(74, 163, 255, 0.3));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .play-icon {
      width: 48px;
      height: 48px;
      opacity: 0.9;
    }

    .video-duration {
      position: absolute;
      bottom: calc(var(--spacing-base) * 1);
      right: calc(var(--spacing-base) * 1);
      background: rgba(0, 0, 0, 0.8);
      padding: calc(var(--spacing-base) * 0.5) calc(var(--spacing-base) * 1);
      border-radius: var(--radius-xs);
      font-size: 12px;
      font-weight: 600;
    }

    .video-info {
      padding: calc(var(--spacing-base) * 2);
    }

    .video-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: calc(var(--spacing-base) * 1);
    }

    .video-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .video-reward {
      color: var(--gcoin-gold);
      font-weight: 600;
    }

    /* Profile */
    .profile-section {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing-base) * 3);
    }

    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: calc(var(--spacing-base) * 2);
      padding: calc(var(--spacing-base) * 3);
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 700;
      border: 3px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 20px;
      font-weight: 700;
    }

    .profile-username {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: calc(var(--spacing-base) * 2);
      width: 100%;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: calc(var(--spacing-base) * 0.5);
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--electric-blue);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .profile-menu {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.06);
      overflow: hidden;
    }

    .menu-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(var(--spacing-base) * 2) calc(var(--spacing-base) * 2.5);
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--white);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .menu-icon {
      width: 20px;
      height: 20px;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: var(--bg-panel);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-around;
      padding: calc(var(--spacing-base) * 1.5) 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: calc(var(--spacing-base) * 0.5);
      padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
      text-decoration: none;
    }

    .nav-item:hover {
      color: var(--white);
    }

    .nav-item.active {
      color: var(--electric-blue);
    }

    .nav-item.active .nav-icon {
      transform: scale(1.1);
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      transition: transform 0.12s ease;
    }

    /* FAB - Post Button */
    .fab {
      position: fixed;
      bottom: calc(var(--spacing-base) * 10);
      right: calc(var(--spacing-base) * 2);
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--vivid-magenta), var(--soft-pink));
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(227, 61, 122, 0.4);
      transition: all 0.3s ease;
      z-index: 99;
      opacity: 1;
      transform: translateY(0);
    }

    .fab.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }

    .fab:hover {
      transform: scale(1.1) translateY(-5px);
      box-shadow: 0 6px 24px rgba(227, 61, 122, 0.6);
    }

    .fab-icon {
      width: 24px;
      height: 24px;
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 200;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: calc(var(--spacing-base) * 2);
    }

    .modal-content {
      width: 100%;
      max-width: 500px;
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      padding: calc(var(--spacing-base) * 3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      position: relative;
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: calc(var(--spacing-base) * 3);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .close-btn {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.05);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .close-icon {
      width: 16px;
      height: 16px;
    }

    .composer-form {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing-base) * 2);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing-base) * 1);
    }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: calc(var(--spacing-base) * 1.5);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      color: var(--white);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.12s ease;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--electric-blue);
      background: rgba(255, 255, 255, 0.08);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .submit-btn {
      padding: calc(var(--spacing-base) * 2);
      background: linear-gradient(135deg, var(--deep-purple), var(--vivid-magenta));
      border: none;
      border-radius: var(--radius-sm);
      color: var(--white);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .submit-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(91, 46, 138, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Browser Frame Modal */
    .browser-frame {
      width: 100%;
      height: 70%;
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .browser-header {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1);
      padding: calc(var(--spacing-base) * 1.5);
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .browser-dots {
      display: flex;
      gap: calc(var(--spacing-base) * 0.75);
    }

    .browser-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .browser-url {
      flex: 1;
      padding: calc(var(--spacing-base) * 0.75) calc(var(--spacing-base) * 1.5);
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-xs);
      font-size: 12px;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .browser-content {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .browser-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    .timer-container {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(11, 11, 13, 0.95);
      padding: calc(var(--spacing-base) * 2);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: calc(var(--spacing-base) * 1);
      z-index: 10;
    }

    .timer-display {
      font-size: 24px;
      font-weight: 700;
      color: var(--electric-blue);
    }

    .timer-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
    }

    .timer-progress {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }

    .timer-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--electric-blue), var(--soft-pink));
      width: 0%;
      transition: width 1s linear;
    }

    /* File Drop Area */
    .file-drop-area {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-sm);
      padding: calc(var(--spacing-base) * 3);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-drop-area:hover {
      border-color: var(--electric-blue);
      background: rgba(74, 163, 255, 0.05);
    }

    .file-drop-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: calc(var(--spacing-base) * 1);
    }

    .file-drop-hint {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .media-preview {
      margin-top: calc(var(--spacing-base) * 2);
    }

    .media-preview img,
    .media-preview video {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: var(--radius-sm);
    }

    /* Task Board Header */
    .task-board-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: calc(var(--spacing-base) * 2);
      padding: calc(var(--spacing-base) * 2);
      background: var(--bg-panel);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .task-counter {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1);
      font-size: 14px;
    }

    .counter-label {
      color: var(--text-secondary);
    }

    .counter-value {
      font-weight: 700;
      color: var(--electric-blue);
    }

    /* VIP Badge */
    .vip-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      margin-top: calc(var(--spacing-base) * 1);
    }

    .vip-badge.none {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
    }

    .vip-badge.basic {
      background: rgba(120, 119, 116, 0.2);
      color: #787774;
    }

    .vip-badge.silver {
      background: rgba(169, 169, 169, 0.2);
      color: #A9A9A9;
    }

    .vip-badge.gold {
      background: rgba(255, 200, 87, 0.2);
      color: var(--gcoin-gold);
    }

    .vip-badge.premium {
      background: rgba(227, 61, 122, 0.2);
      color: var(--vivid-magenta);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--electric-blue);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-panel);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      padding: calc(var(--spacing-base) * 2);
      max-width: 300px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-base) * 1.5);
    }

    .toast.success {
      border-left: 4px solid var(--success-green);
    }

    .toast.error {
      border-left: 4px solid var(--error-red);
    }

    .toast.warning {
      border-left: 4px solid var(--warning-orange);
    }

    .toast-icon {
      width: 20px;
      height: 20px;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .toast-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (min-width: 768px) {
      .app-container {
        max-width: 430px;
        margin: 0 auto;
      }

      .watch-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
 </head>
 <body>
  <div class="app-container">
   <!-- Header -->
   <header class="app-header">
    <div class="logo-section">
     <svg class="logo-icon" viewbox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="32" height="32" rx="8" fill="url(#logo-gradient)" />
      <path d="M10 16L14 20L22 12" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
      <defs>
       <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
        <stop stop-color="#5B2E8A" />
        <stop offset="1" stop-color="#E33D7A" />
       </linearGradient>
      </defs>
     </svg>
     <h1 class="app-title" id="app-title">GainGrid</h1>
    </div>
    <div class="balance-chip">
     <svg class="coin-icon" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="10" cy="10" r="9" fill="#FFC857" stroke="#FFD87A" stroke-width="1" />
      <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="12" font-weight="700">G</text>
     </svg>
     <span class="balance-text" id="balance-text">0</span>
    </div>
   </header>

   <!-- Main Content -->
   <main class="main-content">
    <!-- GridHome / Feed -->
    <section class="screen active" id="gridhome">
     <div class="feed-container" id="feedContainer">
      <!-- Posts will be loaded here dynamically -->
     </div>
    </section>

    <!-- Task Board -->
    <section class="screen" id="tasks">
     <div class="task-board-header">
      <div class="task-counter">
       <span class="counter-label">Tasks today:</span>
       <span class="counter-value" id="task-counter">0/20</span>
      </div>
     </div>
     
     <!-- Platform Grid -->
     <div class="platform-grid-container">
      <div class="platform-grid" id="platformGrid">
       <!-- Platforms will be loaded here -->
      </div>
     </div>
     
     <div class="task-list" id="taskList">
      <!-- Tasks will be loaded here -->
     </div>
    </section>

    <!-- Watch & Earn -->
    <section class="screen" id="watch">
     <div class="watch-header">
      <div class="daily-limit">
       <svg width="20" height="20" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" />
        <path d="M10 5V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
       </svg>
       <span>Daily Ads: <strong id="ads-counter">0/20</strong></span>
      </div>
      <button class="cleanup-btn" onclick="cleanupWatchedAds()">
       <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 4H14M6 7V11M10 7V11M3 4L4 13C4 13.5 4.5 14 5 14H11C11.5 14 12 13.5 12 13L13 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
       </svg>
       <span>Clean Up</span>
      </button>
     </div>
     
     <div class="watch-grid" id="watchGrid">
      <!-- Ads will be loaded here -->
     </div>
    </section>

    <!-- Profile -->
    <section class="screen" id="profile">
     <div class="profile-section">
      <div class="profile-header">
       <div class="profile-avatar" id="profileAvatar"></div>
       <h2 class="profile-name" id="profileName">Loading...</h2>
       <p class="profile-username" id="profileUsername">@username</p>
       <div class="vip-badge none" id="vipBadge">No VIP</div>
       <div class="profile-stats">
        <div class="stat-item">
         <div class="stat-value" id="statGcoins">0</div>
         <div class="stat-label">G-Coins</div>
        </div>
        <div class="stat-item">
         <div class="stat-value" id="statTotalEarned">0</div>
         <div class="stat-label">Total Earned</div>
        </div>
        <div class="stat-item">
         <div class="stat-value" id="statTasksDone">0</div>
         <div class="stat-label">Tasks Done</div>
        </div>
       </div>
      </div>
      
      <div class="profile-menu">
       <button class="menu-item" onclick="openProfileSection('transactions')">
        <span>Transaction History</span>
        <svg class="menu-icon" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
         <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
       </button>
       <button class="menu-item" onclick="openProfileSection('referrals')">
        <span>Referrals</span>
        <svg class="menu-icon" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
         <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
       </button>
       <button class="menu-item" onclick="openProfileSection('settings')">
        <span>Settings</span>
        <svg class="menu-icon" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
         <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
       </button>
       <button class="menu-item" onclick="openHelpSupport()">
        <span>Help & Support</span>
        <svg class="menu-icon" viewbox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
         <path d="M8 16L14 10L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
       </button>
      </div>
     </div>
    </section>
   </main>

   <!-- Bottom Navigation -->
   <nav class="bottom-nav">
    <button class="nav-item active" onclick="switchScreen('gridhome')">
     <svg class="nav-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
     </svg>
     <span>GridHome</span>
    </button>
    <button class="nav-item" onclick="switchScreen('tasks')">
     <svg class="nav-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
     </svg>
     <span>Tasks</span>
    </button>
    <button class="nav-item" onclick="switchScreen('watch')">
     <svg class="nav-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
     </svg>
     <span>Watch</span>
    </button>
    <button class="nav-item" onclick="switchScreen('profile')">
     <svg class="nav-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
     </svg>
     <span>Profile</span>
    </button>
   </nav>

   <!-- FAB - Post Button -->
   <button class="fab" id="fabButton" onclick="openComposer()">
    <svg class="fab-icon" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
     <path d="M12 20H21" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
     <path d="M16.5 3.49998C16.8978 3.10216 17.4374 2.87866 18 2.87866C18.2786 2.87866 18.5544 2.93353 18.8118 3.04014C19.0692 3.14674 19.303 3.303 19.5 3.49998C19.697 3.69697 19.8532 3.93082 19.9598 4.18819C20.0665 4.44556 20.1213 4.72141 20.1213 4.99998C20.1213 5.27856 20.0665 5.55441 19.9598 5.81178C19.8532 6.06915 19.697 6.303 19.5 6.49998L7 19L3 20L4 16L16.5 3.49998Z" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
   </button>

   <!-- Composer Modal -->
   <div class="modal-overlay" id="composer-modal">
    <div class="modal-content">
     <div class="modal-header">
      <h2 class="modal-title">Create Post</h2>
      <button class="close-btn" onclick="closeComposer()">
       <svg class="close-icon" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
       </svg>
      </button>
     </div>
     <form class="composer-form" onsubmit="handlePostSubmit(event)">
      <div class="form-group">
       <label class="form-label" for="post-content">Post Content</label>
       <textarea class="form-textarea" id="post-content" placeholder="What do you want to share?" required></textarea>
      </div>
      
      <div class="form-group">
       <label class="form-label" for="post-link">Link URL</label>
       <input type="url" class="form-input" id="post-link" placeholder="https://example.com" required>
      </div>
      
      <div class="form-group">
       <label class="form-label" for="post-reward">Reward Amount (G-Coins)</label>
       <input type="number" class="form-input" id="post-reward" placeholder="Enter reward amount" min="10000" max="20000" value="10000" required>
       <div class="reward-preview">
        <div class="preview-label">You will pay: <span id="preview-reward">10000</span> G-Coins</div>
       </div>
      </div>
      
      <div class="form-group">
       <label class="form-label">Media (Optional)</label>
       <div class="file-drop-area" id="fileDropArea" onclick="document.getElementById('fileInput').click()">
        <div class="file-drop-text">Drop image/video here or click to upload</div>
        <div class="file-drop-hint">Max size: 10MB</div>
       </div>
       <input type="file" id="fileInput" accept="image/*,video/*" style="display: none;" onchange="handleFileSelect(event)">
       <div class="media-preview" id="mediaPreview"></div>
      </div>
      
      <button type="submit" class="submit-btn" id="postSubmitBtn">Publish Post</button>
     </form>
    </div>
   </div>

   <!-- Browser Modal -->
   <div class="modal-overlay" id="task-modal">
    <div class="browser-frame">
     <div class="browser-header">
      <div class="browser-dots">
       <div class="browser-dot"></div>
       <div class="browser-dot"></div>
       <div class="browser-dot"></div>
      </div>
      <div class="browser-url" id="browserUrl">https://task.gaingrid.com</div>
      <button class="close-btn" onclick="closeTaskModal()">
       <svg class="close-icon" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
       </svg>
      </button>
     </div>
     <div class="browser-content">
      <iframe class="browser-iframe" id="browserIframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
      <div class="timer-container" id="timerContainer">
       <div class="timer-display" id="timerDisplay">00:00</div>
       <div class="timer-label">Complete the task to earn rewards</div>
       <div class="timer-progress">
        <div class="timer-progress-bar" id="timerProgressBar"></div>
       </div>
      </div>
     </div>
    </div>
   </div>

   <!-- Profile Section Modal -->
   <div class="modal-overlay" id="profile-modal">
    <div class="modal-content">
     <div class="modal-header">
      <h2 class="modal-title" id="profileModalTitle">Profile Section</h2>
      <button class="close-btn" onclick="closeProfileModal()">
       <svg class="close-icon" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
       </svg>
      </button>
     </div>
     <div class="modal-body" id="profileModalContent">
      <!-- Content will be loaded dynamically -->
     </div>
    </div>
   </div>
  </div>

  <script>
    // ==================== GLOBAL STATE ====================
    const AppState = {
      user: null,
      balance: 0,
      vipLevel: 'none',
      dailyCounters: {
        tasks: 0,
        ads: 0
      },
      posts: [],
      tasks: [],
      ads: [],
      currentTask: null,
      currentAd: null,
      timerInterval: null,
      isTelegram: false,
      WebApp: null,
      botId: '123456789', // Will be replaced by bot.id from template
      webhookUrl: 'onWebhook' // Bots.Business webhook endpoint
    };

    // ==================== SMART LINKS ====================
    const SMART_LINKS = [
      'https://otieu.com/4/10176113',
      'https://otieu.com/4/10176184',
      'https://otieu.com/4/10176114',
      'https://otieu.com/4/10176185'
    ];

    // ==================== PLATFORM CONFIG ====================
    const PLATFORMS = {
      youtube: {
        name: 'YouTube',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FF0000"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>`
      },
      telegram: {
        name: 'Telegram',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#0088cc"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.06-.2-.08-.06-.19-.04-.27-.02-.12.03-1.98 1.26-5.6 3.7-.53.37-1.01.55-1.44.54-.48-.01-1.4-.27-2.08-.5-.84-.27-1.51-.42-1.45-.89.03-.24.27-.48.74-.73 2.89-1.26 4.83-2.1 5.82-2.51 2.78-1.16 3.36-1.36 3.74-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .1z"/></svg>`
      },
      instagram: {
        name: 'Instagram',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E4405F"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>`
      },
      twitter: {
        name: 'Twitter',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1DA1F2"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.213c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>`
      },
      tiktok: {
        name: 'TikTok',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#000000"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64c.3.045.59.136.86.27v-3.28a6.53 6.53 0 00-1-.08A6.53 6.53 0 005 15.53a6.47 6.47 0 0013 1.14v-6a8.29 8.29 0 004.52 1.38v-3.4a4.85 4.85 0 01-3.93-1.76z"/></svg>`
      },
      facebook: {
        name: 'Facebook',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1877F2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>`
      },
      whatsapp: {
        name: 'WhatsApp',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.76.982.998-3.675-.236-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.9 6.994c-.004 5.45-4.438 9.88-9.888 9.88m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.333.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.333 11.893-11.893 0-3.18-1.24-6.162-3.495-8.411"/></svg>`
      },
      discord: {
        name: 'Discord',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#5865F2"><path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515a.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0a12.64 12.64 0 00-.617-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057a19.9 19.9 0 005.993 3.03a.078.078 0 00.084-.028a14.09 14.09 0 001.226-1.994a.076.076 0 00-.041-.106a13.107 13.107 0 01-1.872-.892a.077.077 0 01-.008-.128c.125-.094.25-.188.372-.284a.076.076 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.076.076 0 01.078.01c.12.096.245.19.37.284a.077.077 0 01-.006.127a12.3 12.3 0 01-1.873.892a.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028a19.839 19.839 0 006.002-3.03a.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.331c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/></svg>`
      },
      website: {
        name: 'Website',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#4AA3FF"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`
      }
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
          AppState.WebApp = window.Telegram.WebApp;
          AppState.isTelegram = true;
          AppState.WebApp.ready();
          AppState.WebApp.expand();
          
          const telegramUser = AppState.WebApp.initDataUnsafe.user;
          if (telegramUser) {
            AppState.user = {
              id: telegramUser.id,
              firstName: telegramUser.first_name,
              lastName: telegramUser.last_name || '',
              username: telegramUser.username,
              photoUrl: telegramUser.photo_url
            };
          }
        }

        // Parse URL parameters and hash
        await handleURLParameters();
        
        // Initialize app
        await initializeApp();
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize Monetag ads
        initializeMonetagAds();
        
        // Update UI
        updateUI();

      } catch (error) {
        console.error('Initialization error:', error);
        showToast('Error initializing app', 'error');
      }
    });

    // ==================== URL PARAMETER HANDLING ====================
    async function handleURLParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const hash = window.location.hash.replace('#', '');
      
      // Handle payload from bot
      const payload = urlParams.get('payload');
      if (payload) {
        try {
          const decoded = atob(payload);
          const data = JSON.parse(decoded);
          
          // Update app state with payload data
          if (data.user) {
            AppState.user = { ...AppState.user, ...data.user };
          }
          if (data.balance !== undefined) {
            AppState.balance = data.balance;
            updateBalance();
          }
          if (data.vipLevel) {
            AppState.vipLevel = data.vipLevel;
            updateVIPBadge();
          }
          if (data.posts) {
            AppState.posts = data.posts;
            updateFeed();
          }
          if (data.tasks) {
            AppState.tasks = data.tasks;
            updateTasks();
          }
          
        } catch (error) {
          console.error('Error decoding payload:', error);
        }
      }
      
      // Handle hash navigation
      if (hash) {
        if (hash === 'iframe') {
          // Direct iframe call from bot
          openDirectIframe();
        } else {
          setTimeout(() => switchScreen(hash), 100);
        }
      }
    }

// ==================== BOT COMMUNICATION ====================
async function sendToBot(event, data) {
  try {
    // build payload (keep same fields as your original)
    const payload = {
      event: event,
      userId: (window.AppState && AppState.user) ? AppState.user.id : (window.AppState && AppState.userId) ? AppState.userId : null,
      timestamp: new Date().toISOString(),
      ...data
    };

    // safe base64 encode (browser)
    let encodedPayload;
    try {
      encodedPayload = btoa(JSON.stringify(payload));
    } catch (e) {
      // fallback: try to encode in chunks (rare)
      try {
        encodedPayload = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      } catch (err) {
        console.warn('btoa failed; sending unencoded payload as fallback', err);
        encodedPayload = JSON.stringify(payload);
      }
    }

    // This is how Bots.Business expects data
    // The bot will have an onWebhook command that receives this
    console.log('Sending to bot (local payload):', payload);

    // For Bots.Business, we use their specific format
    const botPayload = {
      type: 'webhook',
      data: encodedPayload,
      botId: (window.AppState && AppState.botId) ? AppState.botId : undefined
    };

    // Try to discover callback URL (bot should provide it via AppState.callbackUrl or query param)
    function getCallbackUrl() {
      // 1) AppState.callbackUrl
      if (window.AppState && AppState.callbackUrl) return AppState.callbackUrl;

      // 2) AppState.webhook or botApiUrl
      if (window.AppState && (AppState.webhook || AppState.botApiUrl)) return AppState.webhook || AppState.botApiUrl;

      // 3) query param ?callback=...
      try {
        const params = new URLSearchParams(window.location.search);
        const cb = params.get('callback') || params.get('callbackUrl') || params.get('cb');
        if (cb) {
          try { return decodeURIComponent(cb); } catch (e) { return cb; }
        }
      } catch (e) { /* ignore */ }

      // 4) fallback to origin + /webhook (useful for local testing)
      try {
        return window.location.origin + '/webhook';
      } catch (e) {
        return null;
      }
    }

    const callbackUrl = getCallbackUrl();
    if (callbackUrl) {
      // Attempt to POST in a few reasonable formats (wrapper, raw JSON, minimal {data})
      const headers = { 'Content-Type': 'application/json' };

      // Attempt A: bot wrapper (preferred)
      try {
        const resp = await fetch(callbackUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify(botPayload),
          credentials: 'omit'
        });
        console.log(`sendToBot: POST wrapper -> ${callbackUrl} status: ${resp.status}`);
        // Don't throw on non-OK  some webhook endpoints respond differently; log and continue
      } catch (err) {
        console.warn('sendToBot: wrapper POST failed', err);
      }

      // Attempt B: raw decoded JSON (some webhooks expect the raw payload)
      try {
        const resp2 = await fetch(callbackUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
          credentials: 'omit'
        });
        console.log(`sendToBot: POST raw payload -> ${callbackUrl} status: ${resp2.status}`);
      } catch (err) {
        console.warn('sendToBot: raw payload POST failed', err);
      }

      // Attempt C: minimal wrapper { data: base64 } (another common format)
      try {
        const resp3 = await fetch(callbackUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify({ data: encodedPayload }),
          credentials: 'omit'
        });
        console.log(`sendToBot: POST {data} -> ${callbackUrl} status: ${resp3.status}`);
      } catch (err) {
        console.warn('sendToBot: {data} POST failed', err);
      }
    } else {
      console.warn('sendToBot: no callbackUrl discovered (AppState.callbackUrl or ?callback). Returning botPayload only.');
    }

    // Return the botPayload (keeps existing contract unchanged)
    return botPayload;

  } catch (error) {
    console.error('Error sending to bot:', error);
    throw error;
  }
}

    // ==================== APP INITIALIZATION ====================
    async function initializeApp() {
      // Load demo data if no payload
      if (AppState.posts.length === 0) {
        await loadDemoData();
      }
      
      if (!AppState.user) {
        AppState.user = {
          id: Math.floor(Math.random() * 1000000000),
          firstName: 'User',
          lastName: '',
          username: 'user_' + Math.floor(Math.random() * 10000)
        };
      }
      
      updateUserInfo();
      updateBalance();
      updateVIPBadge();
    }

    async function loadDemoData() {
      // Demo posts with images
      AppState.posts = [
        {
          id: '1',
          userId: '123456',
          username: 'johndoe',
          userAvatar: 'JD',
          content: 'Check out this amazing opportunity to earn G-coins! Join our community and start earning today. Limited spots available! ',
          media: 'https://images.unsplash.com/photo-1611224923853-80b023f02d71?w=400&h=300&fit=crop',
          link: 'https://example.com/join',
          linkType: 'join',
          reward: 50,
          likes: 24,
          comments: [
            { id: 'c1', user: 'Alex', text: 'Great opportunity!', time: '1 hour ago' },
            { id: 'c2', user: 'Maria', text: 'Just completed, thanks!', time: '30 minutes ago' }
          ],
          shares: 12,
          timestamp: '2 hours ago',
          userHasLiked: false
        },
        {
          id: '2',
          userId: '789012',
          username: 'sarahkim',
          userAvatar: 'SK',
          content: 'New task alert! Complete this survey and earn instant rewards. Takes only 5 minutes! ',
          media: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=400&h-300&fit=crop',
          link: 'https://example.com/survey',
          linkType: 'visit',
          reward: 30,
          likes: 18,
          comments: [
            { id: 'c3', user: 'Tom', text: 'How long does it take?', time: '15 minutes ago' }
          ],
          shares: 3,
          timestamp: '5 hours ago',
          userHasLiked: true
        },
        {
          id: '3',
          userId: '345678',
          username: 'mikepeters',
          userAvatar: 'MP',
          content: 'Watch this short video and get rewarded! No sign-up required. Just watch and earn! ',
          media: 'https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?w=400&h=300&fit=crop',
          link: 'https://example.com/watch',
          linkType: 'watch',
          reward: 25,
          likes: 42,
          comments: [
            { id: 'c4', user: 'John', text: 'Easy to complete!', time: '2 hours ago' },
            { id: 'c5', user: 'Lisa', text: 'Got my reward instantly!', time: '1 hour ago' }
          ],
          shares: 8,
          timestamp: '1 day ago',
          userHasLiked: false
        }
      ];
      
      // Demo tasks
      AppState.tasks = generateDailyTasks(10); // 10 random tasks per day
      
      // Demo ads
      AppState.ads = generateDailyAds(20); // 20 ads per day
    }

    // ==================== UI UPDATES ====================
    function updateUI() {
      updateFeed();
      updatePlatformGrid();
      updateTasks();
      updateAds();
      updateCounters();
    }

    function updateUserInfo() {
      if (!AppState.user) return;
      
      const userName = AppState.user.firstName + (AppState.user.lastName ? ' ' + AppState.user.lastName : '');
      document.getElementById('profileName').textContent = userName;
      document.getElementById('profileUsername').textContent = AppState.user.username ? '@' + AppState.user.username : '';
      
      // Update avatar
      const avatarEl = document.getElementById('profileAvatar');
      if (AppState.user.photoUrl) {
        avatarEl.innerHTML = `<img src="${AppState.user.photoUrl}" alt="Avatar">`;
      } else {
        const initials = (AppState.user.firstName?.[0] || '') + (AppState.user.lastName?.[0] || '');
        avatarEl.textContent = initials || 'U';
      }
    }

    function updateBalance() {
      document.getElementById('balance-text').textContent = AppState.balance.toLocaleString();
      document.getElementById('statGcoins').textContent = AppState.balance.toLocaleString();
    }

    function updateVIPBadge() {
      const vipBadge = document.getElementById('vipBadge');
      vipBadge.className = `vip-badge ${AppState.vipLevel}`;
      
      let badgeText = 'No VIP';
      switch (AppState.vipLevel) {
        case 'basic': badgeText = 'Basic VIP'; break;
        case 'silver': badgeText = 'Silver VIP'; break;
        case 'gold': badgeText = 'Gold VIP'; break;
        case 'premium': badgeText = 'Premium VIP'; break;
      }
      vipBadge.textContent = badgeText;
    }

    function updateFeed() {
      const feedContainer = document.getElementById('feedContainer');
      feedContainer.innerHTML = '';
      
      AppState.posts.forEach(post => {
        const postElement = createPostElement(post);
        feedContainer.appendChild(postElement);
      });
    }

    function createPostElement(post) {
      const div = document.createElement('div');
      div.className = 'post-card';
      div.dataset.postId = post.id;
      
      const mediaHtml = post.media ? `
        <div class="post-media">
          <img src="${post.media}" alt="Post media">
        </div>
      ` : '';
      
      const commentsHtml = post.comments ? post.comments.map(comment => `
        <div class="comment-item">
          <div class="comment-header">
            <div class="comment-avatar">${comment.user[0]}</div>
            <span class="comment-user">${comment.user}</span>
            <small>${comment.time}</small>
          </div>
          <div class="comment-text">${comment.text}</div>
        </div>
      `).join('') : '';
      
      div.innerHTML = `
        <div class="post-header">
          <div class="avatar">${post.userAvatar}</div>
          <div class="post-meta">
            <div class="poster-name">${post.username}</div>
            <div class="post-time">${post.timestamp}</div>
          </div>
        </div>
        <p class="post-content">${post.content}</p>
        ${mediaHtml}
        <div class="earnings-bar">
          <span class="earnings-label"> Earn up to ${post.reward} G-coins</span>
        </div>
        <div class="post-actions">
          <button class="action-btn ${post.userHasLiked ? 'liked' : ''}" onclick="handleLike('${post.id}', this)">
            <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 14L2.5 8.5C1.5 7.5 1.5 5.8 2.5 4.8C3.5 3.8 5.2 3.8 6.2 4.8L8 6.6L9.8 4.8C10.8 3.8 12.5 3.8 13.5 4.8C14.5 5.8 14.5 7.5 13.5 8.5L8 14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>${post.likes}</span>
          </button>
          <button class="action-btn" onclick="handlePostAction('${post.id}', '${post.link}', '${post.linkType}')">
            <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14 2L8 8L14 2ZM14 2L9.5 14L8 8L2 6.5L14 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>${getActionText(post.linkType)}</span>
          </button>
          <button class="action-btn" onclick="toggleComments('${post.id}', this)">
            <svg class="action-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14 11C14 11.5 13.5 12 13 12H4L2 14V3C2 2.5 2.5 2 3 2H13C13.5 2 14 2.5 14 3V11Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>${post.comments.length}</span>
          </button>
        </div>
        <div class="comments-section" id="comments-${post.id}">
          ${commentsHtml}
          <div class="comment-input-container">
            <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
            <button class="send-comment-btn" onclick="addComment('${post.id}')">Send</button>
          </div>
        </div>
      `;
      
      return div;
    }

    function updatePlatformGrid() {
      const platformGrid = document.getElementById('platformGrid');
      platformGrid.innerHTML = '';
      
      // Duplicate platforms for infinite scroll effect
      const platformsArray = Object.entries(PLATFORMS);
      for (let i = 0; i < 2; i++) { // Double the array for seamless scrolling
        platformsArray.forEach(([key, platform]) => {
          const card = document.createElement('div');
          card.className = 'platform-card';
          card.onclick = () => filterTasksByPlatform(key);
          card.innerHTML = `
            <div class="platform-icon">${platform.icon}</div>
            <div class="platform-name">${platform.name}</div>
          `;
          platformGrid.appendChild(card);
        });
      }
    }

    function updateTasks() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      
      // Show tasks for selected platform or all tasks
      AppState.tasks.forEach(task => {
        if (task.completed) return;
        
        const taskElement = createTaskElement(task);
        taskList.appendChild(taskElement);
      });
      
      updateTaskCounter();
    }

    function createTaskElement(task) {
      const platform = PLATFORMS[task.platform] || PLATFORMS.website;
      const div = document.createElement('article');
      div.className = 'task-card';
      
      div.innerHTML = `
        <div class="task-header">
          <div class="platform-icon" style="color: ${getPlatformColor(task.platform)}">
            ${platform.icon}
          </div>
          <div class="task-info">
            <h3 class="task-title">${task.title}</h3>
            <p class="task-description">${task.description}</p>
            <div class="task-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
              <span class="progress-text">Not started</span>
            </div>
          </div>
          <div class="task-reward">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="9" fill="#FFC857" />
              <text x="10" y="14" text-anchor="middle" fill="#0B0B0D" font-size="10" font-weight="700">G</text>
            </svg>
            <span>${task.reward}</span>
          </div>
        </div>
        <div class="task-footer">
          <button class="task-btn primary" onclick="startTask('${task.id}')">Start Task</button>
          <button class="task-btn secondary">Details</button>
        </div>
      `;
      
      return div;
    }

    function updateAds() {
      const watchGrid = document.getElementById('watchGrid');
      watchGrid.innerHTML = '';
      
      AppState.ads.forEach(ad => {
        const adElement = createAdElement(ad);
        watchGrid.appendChild(adElement);
      });
      
      updateAdsCounter();
    }

    function createAdElement(ad) {
      const div = document.createElement('article');
      div.className = `video-card ${ad.watched ? 'watched' : ''}`;
      div.dataset.adId = ad.id;
      
      if (ad.watched) {
        div.innerHTML = `
          <div class="video-thumbnail">
            <div class="watched-overlay">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="20" cy="20" r="18" fill="rgba(74, 163, 255, 0.9)" />
                <path d="M12 20L17 25L28 14" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
            <span class="video-duration">0:${ad.duration.toString().padStart(2, '0')}</span>
          </div>
          <div class="video-info">
            <div class="video-advertiser">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="14" height="14" rx="3" fill="#5B2E8A" />
              </svg>
              <span>${ad.source}</span>
            </div>
            <h3 class="video-title">${ad.title}</h3>
            <div class="video-meta">
              <span class="collected-badge"> Collected</span>
              <span class="video-reward">+${ad.reward} G-coins</span>
            </div>
          </div>
        `;
      } else {
        div.innerHTML = `
          <div class="video-thumbnail" onclick="watchAd('${ad.id}', this)">
            <svg class="play-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="24" cy="24" r="22" fill="rgba(255,255,255,0.9)" />
              <path d="M19 16L32 24L19 32V16Z" fill="#0B0B0D" />
            </svg>
            <span class="video-duration">0:${ad.duration.toString().padStart(2, '0')}</span>
          </div>
          <div class="video-info">
            <div class="video-advertiser">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="14" height="14" rx="3" fill="#4AA3FF" />
              </svg>
              <span>${ad.source}</span>
            </div>
            <h3 class="video-title">${ad.title}</h3>
            <div class="video-meta">
              <span>Watch 0:${ad.duration.toString().padStart(2, '0')}  Earn</span>
              <span class="video-reward">+${ad.reward} G-coins</span>
            </div>
          </div>
        `;
      }
      
      return div;
    }

    function updateCounters() {
      updateTaskCounter();
      updateAdsCounter();
    }

    function updateTaskCounter() {
      const completed = AppState.tasks.filter(t => t.completed).length;
      const total = AppState.tasks.length;
      document.getElementById('task-counter').textContent = `${completed}/${total}`;
      document.getElementById('statTasksDone').textContent = completed;
      
      // Update total earned
      const totalEarned = AppState.tasks
        .filter(t => t.completed)
        .reduce((sum, t) => sum + t.reward, 0);
      document.getElementById('statTotalEarned').textContent = totalEarned.toLocaleString();
    }

    function updateAdsCounter() {
      const watched = AppState.ads.filter(a => a.watched).length;
      document.getElementById('ads-counter').textContent = `${watched}/20`;
      AppState.dailyCounters.ads = watched;
    }

    // ==================== EVENT HANDLERS ====================
    function setupEventListeners() {
      // Scroll event for FAB visibility
      const mainContent = document.querySelector('.main-content');
      const fab = document.getElementById('fabButton');
      
      mainContent.addEventListener('scroll', () => {
        if (mainContent.scrollTop > 100) {
          fab.classList.add('hidden');
        } else {
          fab.classList.remove('hidden');
        }
      });
      
      // File drag and drop
      const fileDropArea = document.getElementById('fileDropArea');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        fileDropArea.style.borderColor = 'var(--electric-blue)';
        fileDropArea.style.background = 'rgba(74, 163, 255, 0.1)';
      }
      
      function unhighlight() {
        fileDropArea.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        fileDropArea.style.background = 'transparent';
      }
      
      fileDropArea.addEventListener('drop', handleDrop, false);
    }

    // ==================== SCREEN NAVIGATION ====================
    function switchScreen(screenId) {
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      
      // Remove active from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected screen
      const screen = document.getElementById(screenId);
      if (screen) {
        screen.classList.add('active');
      }
      
      // Update active nav item
      const navItem = Array.from(document.querySelectorAll('.nav-item')).find(item => 
        item.onclick && item.onclick.toString().includes(screenId)
      );
      if (navItem) {
        navItem.classList.add('active');
      }
      
      // Update URL hash
      window.location.hash = screenId;
    }

    // ==================== MODAL FUNCTIONS ====================
    function openComposer() {
      // Check VIP level
      if (!['gold', 'premium'].includes(AppState.vipLevel)) {
        showToast('Only Gold and Premium VIP can create posts', 'error');
        return;
      }
      
      // Check balance
      const minBalance = 10000;
      if (AppState.balance < minBalance) {
        showToast(`Minimum ${minBalance.toLocaleString()} G-Coins required to post`, 'error');
        return;
      }
      
      document.getElementById('composer-modal').classList.add('active');
    }

    function closeComposer() {
      document.getElementById('composer-modal').classList.remove('active');
      document.getElementById('mediaPreview').innerHTML = '';
      document.getElementById('post-content').value = '';
      document.getElementById('post-link').value = '';
      document.getElementById('post-reward').value = '10000';
    }

    function openTaskModal(taskId) {
      const task = AppState.tasks.find(t => t.id === taskId);
      if (!task) return;
      
      // Check daily limit
      if (AppState.dailyCounters.tasks >= 20) {
        showToast('Daily task limit reached!', 'warning');
        return;
      }
      
      AppState.currentTask = task;
      document.getElementById('task-modal').classList.add('active');
      
      // Start with smartlink
      const smartLink = getRandomSmartLink();
      document.getElementById('browserUrl').textContent = smartLink;
      document.getElementById('browserIframe').src = smartLink;
      
      // Start timer
      startTaskTimer(task.duration, 'task', task);
    }

    function closeTaskModal() {
      document.getElementById('task-modal').classList.remove('active');
      document.getElementById('browserIframe').src = '';
      
      if (AppState.timerInterval) {
        clearInterval(AppState.timerInterval);
        AppState.timerInterval = null;
      }
    }

    // ==================== POST FUNCTIONS ====================
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'video/mp4', 'video/webm'];
      if (!validTypes.includes(file.type)) {
        showToast('Please select an image or video file', 'error');
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('mediaPreview');
        if (file.type.includes('image')) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        } else {
          preview.innerHTML = `<video src="${e.target.result}" controls></video>`;
        }
      };
      reader.readAsDataURL(file);
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        handleFileSelect({ target: { files: [files[0]] } });
      }
    }

    async function handlePostSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('postSubmitBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Publishing...';
      submitBtn.disabled = true;
      
      try {
        const content = document.getElementById('post-content').value;
        const link = document.getElementById('post-link').value;
        const reward = parseInt(document.getElementById('post-reward').value);
        const mediaPreview = document.getElementById('mediaPreview');
        const mediaSrc = mediaPreview.querySelector('img, video')?.src;
        
        // Validate reward amount
        if (reward < 10000 || reward > 20000) {
          throw new Error('Reward must be between 10,000 and 20,000 G-Coins');
        }
        
        if (reward > AppState.balance) {
          throw new Error('Insufficient balance');
        }
        
        // Send to bot
        const botData = await sendToBot('post_created', {
          content: content,
          link: link,
          reward: reward,
          media: mediaSrc ? true : false,
          vipLevel: AppState.vipLevel,
          balance: AppState.balance
        });
        
        // Create new post
        const newPost = {
          id: Date.now().toString(),
          userId: AppState.user?.id,
          username: AppState.user?.username || 'user',
          userAvatar: getInitials(AppState.user?.firstName, AppState.user?.lastName),
          content: content,
          media: mediaSrc,
          link: link,
          linkType: 'visit',
          reward: reward,
          likes: 0,
          comments: [],
          shares: 0,
          timestamp: 'Just now',
          userHasLiked: false
        };
        
        AppState.posts.unshift(newPost);
        updateFeed();
        
        // Close modal and show success
        closeComposer();
        showToast('Post published successfully!', 'success');
        
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function handleLike(postId, button) {
      const post = AppState.posts.find(p => p.id === postId);
      if (!post) return;
      
      const wasLiked = post.userHasLiked;
      post.userHasLiked = !wasLiked;
      post.likes += wasLiked ? -1 : 1;
      
      // Update UI
      button.classList.toggle('liked');
      button.querySelector('span').textContent = post.likes;
      
      // Send to bot
      await sendToBot('post_liked', {
        postId: postId,
        liked: !wasLiked
      });
    }

    async function handlePostAction(postId, link, type) {
      const post = AppState.posts.find(p => p.id === postId);
      if (!post) return;
      
      // Open browser modal
      document.getElementById('task-modal').classList.add('active');
      document.getElementById('browserUrl').textContent = link;
      document.getElementById('browserIframe').src = link;
      
      // Start timer
      const duration = getDurationForAction(type);
      startTaskTimer(duration, 'post_action', { postId, link, type });
      
      // Send to bot
      await sendToBot('action_started', {
        postId: postId,
        action: type,
        link: link
      });
    }

    function toggleComments(postId, button) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      commentsSection.classList.toggle('active');
    }

    async function addComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      
      if (!text) return;
      
      const post = AppState.posts.find(p => p.id === postId);
      if (!post) return;
      
      const newComment = {
        id: 'c' + Date.now(),
        user: AppState.user?.username || 'You',
        text: text,
        time: 'Just now'
      };
      
      post.comments.push(newComment);
      
      // Update UI
      const commentsSection = document.getElementById(`comments-${postId}`);
      const commentHtml = `
        <div class="comment-item">
          <div class="comment-header">
            <div class="comment-avatar">${newComment.user[0]}</div>
            <span class="comment-user">${newComment.user}</span>
            <small>${newComment.time}</small>
          </div>
          <div class="comment-text">${newComment.text}</div>
        </div>
      `;
      
      commentsSection.insertAdjacentHTML('afterbegin', commentHtml);
      input.value = '';
      
      // Send to bot
      await sendToBot('comment_added', {
        postId: postId,
        comment: text
      });
    }

    // ==================== TASK FUNCTIONS ====================
    function generateDailyTasks(count) {
      const tasks = [];
      const platforms = Object.keys(PLATFORMS);
      const taskTitles = [
        'Watch this video',
        'Join our channel',
        'Visit website',
        'Complete survey',
        'Install app',
        'Follow account',
        'Like post',
        'Share content',
        'Subscribe',
        'Comment'
      ];
      
      const smartLinks = [...SMART_LINKS];
      
      for (let i = 0; i < count; i++) {
        const platform = platforms[Math.floor(Math.random() * platforms.length)];
        const title = taskTitles[Math.floor(Math.random() * taskTitles.length)];
        const duration = Math.floor(Math.random() * 120) + 30; // 30-150 seconds
        const reward = Math.floor(Math.random() * 200) + 100; // 100-300 coins
        
        // Use smartlink, cycling through them
        const smartLink = smartLinks[i % smartLinks.length];
        
        tasks.push({
          id: 'task_' + i,
          platform: platform,
          title: `${title} on ${PLATFORMS[platform].name}`,
          description: `Complete this task to earn ${reward} G-coins`,
          duration: duration,
          reward: reward,
          link: smartLink,
          completed: false,
          type: 'random'
        });
      }
      
      return tasks;
    }

    function filterTasksByPlatform(platform) {
      const filteredTasks = AppState.tasks.filter(task => 
        task.platform === platform && !task.completed
      );
      
      if (filteredTasks.length === 0) {
        showToast(`No tasks available for ${PLATFORMS[platform].name}`, 'info');
        return;
      }
      
      // Update task list to show only filtered tasks
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      
      filteredTasks.forEach(task => {
        const taskElement = createTaskElement(task);
        taskList.appendChild(taskElement);
      });
    }

    function startTask(taskId) {
      const task = AppState.tasks.find(t => t.id === taskId);
      if (!task) return;
      
      openTaskModal(taskId);
    }

    async function completeTask(taskId) {
      const task = AppState.tasks.find(t => t.id === taskId);
      if (!task) return;
      
      task.completed = true;
      AppState.dailyCounters.tasks++;
      
      // Calculate reward with VIP bonus
      const baseReward = task.reward;
      const vipBonus = getVIPBonus(AppState.vipLevel);
      const totalReward = baseReward + vipBonus;
      
      // Update balance
      AppState.balance += totalReward;
      
      // Update UI
      updateBalance();
      updateTasks();
      updateCounters();
      
      // Send to bot
      await sendToBot('task_completed', {
        taskId: taskId,
        platform: task.platform,
        baseReward: baseReward,
        vipBonus: vipBonus,
        totalReward: totalReward,
        newBalance: AppState.balance
      });
      
      // Show success
      closeTaskModal();
      showToast(`Task completed! +${totalReward} G-Coins`, 'success');
    }

    // ==================== AD FUNCTIONS ====================
    function generateDailyAds(count) {
      const ads = [];
      const adTitles = [
        'Tech Review 2024',
        'Crypto Market Update',
        'Gaming News Today',
        'Product Launch Event',
        'Software Tutorial',
        'Mobile App Review',
        'Web Development Tips',
        'AI Technology News',
        'Blockchain Insights',
        'Digital Marketing Tips'
      ];
      
      const sources = ['TechBrand Co.', 'CryptoExchange', 'GameStore', 'Fashion Brand', 'Software Inc.', 'Web Services', 'Digital Agency'];
      
      const smartLinks = [...SMART_LINKS];
      
      for (let i = 0; i < count; i++) {
        const title = adTitles[i % adTitles.length];
        const duration = Math.floor(Math.random() * 40) + 20; // 20-60 seconds
        const reward = Math.floor(Math.random() * 60) + 60; // 60-120 coins
        const source = sources[i % sources.length];
        const smartLink = smartLinks[i % smartLinks.length];
        
        ads.push({
          id: 'ad_' + i,
          title: title,
          duration: duration,
          reward: reward,
          source: source,
          link: smartLink,
          watched: false
        });
      }
      
      return ads;
    }

    function watchAd(adId, element) {
      const ad = AppState.ads.find(a => a.id === adId);
      if (!ad || ad.watched) return;
      
      // Check daily limit
      if (AppState.dailyCounters.ads >= 20) {
        showToast('Daily ad limit reached!', 'warning');
        return;
      }
      
      AppState.currentAd = ad;
      
      // Try Monetag SDK first
      if (typeof show_10274566 === 'function') {
        try {
          show_10274566('pop').then(() => {
            completeAd(adId);
          }).catch(() => {
            // Fallback to smartlink
            openAdFallback(ad);
          });
        } catch (error) {
          openAdFallback(ad);
        }
      } else {
        openAdFallback(ad);
      }
    }

    function openAdFallback(ad) {
      document.getElementById('task-modal').classList.add('active');
      document.getElementById('browserUrl').textContent = ad.link;
      document.getElementById('browserIframe').src = ad.link;
      
      startTaskTimer(ad.duration, 'ad', ad);
    }

    async function completeAd(adId) {
      const ad = AppState.ads.find(a => a.id === adId);
      if (!ad) return;
      
      ad.watched = true;
      AppState.dailyCounters.ads++;
      
      // Calculate reward with VIP bonus
      const baseReward = ad.reward;
      const vipBonus = getVIPBonus(AppState.vipLevel);
      const totalReward = baseReward + vipBonus;
      
      // Update balance
      AppState.balance += totalReward;
      
      // Update UI
      updateBalance();
      updateAds();
      updateCounters();
      
      // Send to bot
      await sendToBot('ad_watched', {
        adId: adId,
        baseReward: baseReward,
        vipBonus: vipBonus,
        totalReward: totalReward,
        newBalance: AppState.balance
      });
      
      // Show success
      if (document.getElementById('task-modal').classList.contains('active')) {
        closeTaskModal();
      }
      showToast(`Ad watched! +${totalReward} G-Coins`, 'success');
    }

    function cleanupWatchedAds() {
      AppState.ads = AppState.ads.filter(ad => !ad.watched);
      updateAds();
      showToast('Watched ads cleaned up', 'success');
    }

    // ==================== TIMER FUNCTIONS ====================
    function startTaskTimer(duration, type, data) {
      let remaining = duration;
      const display = document.getElementById('timerDisplay');
      const progressBar = document.getElementById('timerProgressBar');
      
      // Update display immediately
      updateTimerDisplay();
      
      // Start interval
      AppState.timerInterval = setInterval(() => {
        remaining--;
        updateTimerDisplay();
        
        if (remaining <= 0) {
          clearInterval(AppState.timerInterval);
          AppState.timerInterval = null;
          
          // Handle completion
          if (type === 'task') {
            completeTask(data.id);
          } else if (type === 'ad') {
            completeAd(data.id);
          } else if (type === 'post_action') {
            completePostAction(data);
          }
        }
      }, 1000);
      
      function updateTimerDisplay() {
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        const progress = ((duration - remaining) / duration) * 100;
        progressBar.style.width = `${progress}%`;
      }
    }

    async function completePostAction(data) {
      // Send to bot
      await sendToBot('action_completed', {
        postId: data.postId,
        action: data.type,
        link: data.link
      });
      
      // Close modal
      closeTaskModal();
      showToast('Action completed!', 'success');
    }

    // ==================== PROFILE FUNCTIONS ====================
    function openProfileSection(section) {
      let title = '';
      let content = '';
      
      switch (section) {
        case 'transactions':
          title = 'Transaction History';
          content = `
            <div style="max-height: 400px; overflow-y: auto;">
              <div class="transaction-item">
                <div class="transaction-icon earn">+</div>
                <div class="transaction-details">
                  <div class="transaction-title">Task Reward - YouTube</div>
                  <div class="transaction-time">2 hours ago</div>
                </div>
                <div class="transaction-amount earn">+50</div>
              </div>
              <div class="transaction-item">
                <div class="transaction-icon earn">+</div>
                <div class="transaction-details">
                  <div class="transaction-title">Ad Watch Reward</div>
                  <div class="transaction-time">5 hours ago</div>
                </div>
                <div class="transaction-amount earn">+25</div>
              </div>
            </div>
          `;
          break;
          
        case 'referrals':
          title = 'Referrals';
          const refLink = `https://t.me/GridGain_Bot?start=${AppState.user?.id}`;
          content = `
            <div class="form-group">
              <label class="form-label">Your Referral Link</label>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <input type="text" class="form-input" value="${refLink}" id="refLinkInput" readonly>
                <button class="submit-btn" style="flex: 0 0 auto; padding: 0 16px;" onclick="copyRefLink()">
                  Copy
                </button>
              </div>
            </div>
            <div class="profile-stats" style="margin-top: 24px;">
              <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Completed</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Pending</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Total Earned</div>
              </div>
            </div>
          `;
          break;
          
        case 'settings':
          title = 'Settings';
          content = `
            <div class="form-group">
              <label class="form-label">User ID</label>
              <input type="text" class="form-input" value="${AppState.user?.id || ''}" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Username</label>
              <input type="text" class="form-input" value="${AppState.user?.username || ''}" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">App Version</label>
              <input type="text" class="form-input" value="1.0.0" readonly>
            </div>
          `;
          break;
      }
      
      document.getElementById('profileModalTitle').textContent = title;
      document.getElementById('profileModalContent').innerHTML = content;
      document.getElementById('profile-modal').classList.add('active');
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.remove('active');
    }

    function openHelpSupport() {
      if (AppState.isTelegram && AppState.WebApp) {
        AppState.WebApp.openTelegramLink('https://t.me/GridGain_Bot?start=help');
      } else {
        window.open('https://t.me/GridGain_Bot?start=help', '_blank');
      }
    }

    function copyRefLink() {
      const input = document.getElementById('refLinkInput');
      input.select();
      document.execCommand('copy');
      showToast('Referral link copied!', 'success');
    }

    // ==================== DIRECT IFRAME CALL ====================
    function openDirectIframe() {
      // This is called when bot opens web with #iframe
      document.getElementById('task-modal').classList.add('active');
      
      // Use random smartlink
      const smartLink = getRandomSmartLink();
      document.getElementById('browserUrl').textContent = smartLink;
      document.getElementById('browserIframe').src = smartLink;
      
      // Random timer between 30-60 seconds
      const duration = Math.floor(Math.random() * 30) + 30;
      startTaskTimer(duration, 'direct_iframe', { id: 'direct' });
    }

    // ==================== MONETAG ADS ====================
    function initializeMonetagAds() {
      if (typeof monetag !== 'undefined') {
        monetag.start();
        
        // In-app interstitial ads
        show_10274566({ 
          type: 'inApp', 
          inAppSettings: { 
            frequency: 2, 
            capping: 0.1, 
            interval: 30, 
            timeout: 5, 
            everyPage: false 
          } 
        });
        
        // Set up rewarded ads
        document.addEventListener('click', (e) => {
          if (e.target.closest('.task-btn.primary') || 
              e.target.closest('.action-btn') && 
              !e.target.closest('.action-btn').classList.contains('liked')) {
            
            // 30% chance to show rewarded ad
            if (Math.random() < 0.3) {
              setTimeout(() => {
                show_10274566().then(() => {
                  console.log('Rewarded ad watched');
                }).catch(() => {
                  console.log('Ad skipped or error');
                });
              }, 1000);
            }
          }
        });
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function getRandomSmartLink() {
      const randomIndex = Math.floor(Math.random() * SMART_LINKS.length);
      return SMART_LINKS[randomIndex];
    }

    function getActionText(type) {
      switch (type) {
        case 'visit': return 'Visit';
        case 'join': return 'Join';
        case 'watch': return 'Watch';
        case 'install': return 'Install';
        default: return 'Open';
      }
    }

    function getDurationForAction(type) {
      switch (type) {
        case 'visit': return 60;
        case 'join': return 45;
        case 'watch': return 90;
        case 'install': return 120;
        default: return 30;
      }
    }

    function getPlatformColor(platform) {
      const colors = {
        youtube: '#FF0000',
        telegram: '#0088cc',
        instagram: '#E4405F',
        twitter: '#1DA1F2',
        tiktok: '#000000',
        facebook: '#1877F2',
        whatsapp: '#25D366',
        discord: '#5865F2',
        website: '#4AA3FF'
      };
      return colors[platform] || '#4AA3FF';
    }

    function getVIPBonus(level) {
      switch (level) {
        case 'basic': return 20;
        case 'silver': return 40;
        case 'gold': return 60;
        case 'premium': return 100;
        default: return 0;
      }
    }

    function getInitials(firstName, lastName) {
      return ((firstName?.[0] || '') + (lastName?.[0] || '')).toUpperCase();
    }

    function showToast(message, type = 'info') {
      // Remove existing toast
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '',
        error: '',
        warning: '',
        info: ''
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || ''}</div>
        <div class="toast-content">
          <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
          <div class="toast-message">${message}</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.opacity = '0';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }
      }, 3000);
    }

    // ==================== EXPORT FUNCTIONS ====================
    window.switchScreen = switchScreen;
    window.openComposer = openComposer;
    window.closeComposer = closeComposer;
    window.handleLike = handleLike;
    window.handlePostAction = handlePostAction;
    window.toggleComments = toggleComments;
    window.addComment = addComment;
    window.startTask = startTask;
    window.closeTaskModal = closeTaskModal;
    window.watchAd = watchAd;
    window.cleanupWatchedAds = cleanupWatchedAds;
    window.openProfileSection = openProfileSection;
    window.closeProfileModal = closeProfileModal;
    window.openHelpSupport = openHelpSupport;
    window.copyRefLink = copyRefLink;
    window.handleFileSelect = handleFileSelect;
    window.handlePostSubmit = handlePostSubmit;
    window.filterTasksByPlatform = filterTasksByPlatform;
  </script>
 </body>
</html>